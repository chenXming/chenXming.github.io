<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>chenXming的个人技术网站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="我的个人技术博客，如果有需要可以通过13716873821@163.com联系我">
<meta property="og:type" content="website">
<meta property="og:title" content="chenXming的个人技术网站">
<meta property="og:url" content="https://chenxming.github.io/index.html">
<meta property="og:site_name" content="chenXming的个人技术网站">
<meta property="og:description" content="我的个人技术博客，如果有需要可以通过13716873821@163.com联系我">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="chenXming">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="chenXming的个人技术网站" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">chenXming的个人技术网站</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chenxming.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-从零开发一款ChatGPT VSCode插件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/08/23/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%8F%91%E4%B8%80%E6%AC%BEChatGPT%20VSCode%E6%8F%92%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2023-08-23T12:46:25.000Z" itemprop="datePublished">2023-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/08/23/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%8F%91%E4%B8%80%E6%AC%BEChatGPT%20VSCode%E6%8F%92%E4%BB%B6/">从零开发一款ChatGPT VSCode插件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h4><p><code>OpenAI</code>发布了<code>ChatGPT</code>，就像是给平静许久的互联网湖面上扔了一颗重磅炸弹，刹那间所有人都在追捧学习它。究其原因，它其实是一款真正意义上的<code>人工智能对话机器人</code>。它使用了深度学习技术，通过大量的训练数据和自监督学习方法进行训练，以模拟人类的对话能力和生成自然语言回应。日常生产、学习中利用好<code>ChatGPT</code>这个工具，是绝对能够提升我们工作效率的，这一点对于我们程序员来说，感受应该尤为明显。我们最常用的开发工具<code>VSCode</code>，已经有许多的插件集成了<code>ChatGPT</code>功能，这篇文章将从零开始，介绍这些插件的实现原理与思路，希望对你有所帮助。</p>
<h4 id="基本需求"><a href="#基本需求" class="headerlink" title="基本需求"></a>基本需求</h4><p>实现一款可以跟<code>ChatGPT</code>对话的插件，可以通过一问一答的形式来进行对话，并且可以将我们选中的代码发送给<code>ChatGPT</code>，让其可以对代码进行优化。当然如果要访问<code>ChatGPT</code>，首先需要绑定我们在<code>OpenAI</code>后台申请的<code>ApiKey</code>.</p>
<h4 id="VSCode-插件基本配置"><a href="#VSCode-插件基本配置" class="headerlink" title="VSCode 插件基本配置"></a>VSCode 插件基本配置</h4><p>首先简单介绍一下<code>VSCode</code>插件开发的基本流程</p>
<ol>
<li>安装脚手架</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yo generator-code</span><br></pre></td></tr></table></figure>
<p>然后<code>cd</code>到你的工作目录，运行<code>yo code</code>,根据向导一步步选择即可，没啥好说的，运行完后就生成了一个干净的可以运行的插件工程了。<br>2. 工程目录介绍<br>   <img src="https://s2.loli.net/2023/08/22/u3tXlJBV6APdWp8.png" alt="pic"><br>   查看当前目录，工程的核心是<code>package.json</code>与<code>extension.js</code>.首先看下<code>package.json</code>的配置文件：</p>
<ul>
<li><p><code>name</code>:工程名称</p>
</li>
<li><p><code>displayName</code>: 应用市场名称</p>
</li>
<li><p><code>description</code>: 应用描述</p>
</li>
<li><p><code>version</code>: 当前插件版本</p>
</li>
<li><p><code>engines</code>: 表示插件最低支持的vscode版本</p>
</li>
<li><p><code>categories</code>: 插件应用市场分类</p>
</li>
<li><p><code>main</code>: 程序的主入口文件</p>
</li>
<li><p><code>activationEvents</code>:<strong>重要</strong>，扩展的激活事件数组，表示可以被哪些事件激活当前插件。比如：</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;activationEvents&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;onView:chatgpt-for-vscode.view&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;onCommand:chatgpt-for-vscode.setAPIKey&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;onCommand:chatgpt-for-vscode.askGPT&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;onCommand:chatgpt-for-vscode.whyBroken&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;onCommand:chatgpt-for-vscode.optimizeCode&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;onCommand:chatgpt-for-vscode.explainCode&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;onCommand:chatgpt-for-vscode.refactor&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p><code>onView</code>:表示 通过视图触发,<code>chatgpt-for-vscode.view</code>是视图Id。当触发这个视图时，唤起当前插件<br><code>onCommand</code>: 表示通过命令触发，后面是命令Id,这些都是我们自定义的命令。在<code>VSCode</code>中按下快捷键：<code>Command + Shift + P</code> 输入命令<code>title</code>后唤起插件，命令<code>title</code>在<code>contributes</code>,<code>commands</code>模块里面定义，后面介绍。<br>除了这两个还有：<code>onLanguage</code>、<code>onUri</code>、<code>onDebug</code>、<code>workspaceContains</code>、<code>onFileSystem</code>等，如果设置为<code>*</code>，只要一启动<code>VSCode</code>，插件就会被激活，当然为了用户体验，官方不推荐这么做。</p>
<ul>
<li><code>contributes</code>: <strong>重要</strong>，配置插件的主要功能点。比如：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;contributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.setAPIKey&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GPT:绑定APIKey&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.askGPT&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GPT:询问 GPT&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.whyBroken&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GPT:说明这段代码存在的问题&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.optimizeCode&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GPT:优化这段代码&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.explainCode&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GPT:解释这段代码&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.refactor&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GPT:重构这段代码&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;menus&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;editor/context&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.askGPT&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;navigation@1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.whyBroken&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;navigation@2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.optimizeCode&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;navigation@3&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.explainCode&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;navigation@4&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.refactor&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;navigation@5&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.setAPIKey&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;navigation@6&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;viewsContainers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;activitybar&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ChatGPT&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;images/ChatGPT.png&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;views&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;chatgpt-for-vscode&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webview&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatgpt-for-vscode.view&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ChatGPT&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>commands: <code>command</code>: 命令Id，这个命令Id跟<code>activationEvents</code>中配置的命令Id相同。<code>title</code>:输入的命令的名称。<code>Command + Shift + P</code> 输入这个命令title后找到对应的命令。<br><img src="https://s2.loli.net/2023/08/22/WFlYrBO7EtDvGQi.png" alt="pic"></p>
</li>
<li><p>menus: <code>editor/context</code>:配置编辑器右键展示内容。<code>command</code>是命令Id，<code>group</code>:右键后展示看板的命令位置。这里<code>navigation</code>表示展示在模块的顶部。<code>@*</code>表示排序。<br><img src="https://s2.loli.net/2023/08/22/WE2gFe4ODIaTYzN.png" alt="pic"></p>
</li>
<li><p><code>viewsContainers</code>: <code>activitybar</code>:配置右侧工具栏视图入口，配置后展示,注意这里的<code>id</code>,要跟后面的<br><code>views</code>模块里面的视图key值保持一致,表示点击右侧<code>icon</code>后展示那个视图,<code>icon</code>是你本地的图片路径。<br><img src="https://s2.loli.net/2023/08/22/H78tsZUYvCyuI5z.png" alt="pic"></p>
</li>
<li><p><code>views</code>: 配置视图，这里使用<code>webview</code>展示自定义视图</p>
</li>
</ul>
<ol start="3">
<li>配置完成<code>package.json</code>后右键命令展示，左侧状态栏Icon，顶部命令行选择输入命令，已经可以展示了。运行<code>npm run test</code> 后会打开默认安装你插件的<code>VSCode</code>面板,接下来就是完善触发命令后的代码逻辑了，核心在<code>extension.ts</code>中实现。</li>
</ol>
<h4 id="extension-ts模块开发"><a href="#extension-ts模块开发" class="headerlink" title="extension.ts模块开发"></a><code>extension.ts</code>模块开发</h4><p><code>extension.ts</code> 是程序的入口文件，里面有两个核心方法：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">activate</span>(<span class="params">context: vscode.ExtensionContext</span>) &#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">deactivate</span>(<span class="params"></span>) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>看字面意思很好理解，分别表示插件被激活与释放调用的生命周期方法.</p>
<h5 id="1-绑定APIKey命令逻辑"><a href="#1-绑定APIKey命令逻辑" class="headerlink" title="1. 绑定APIKey命令逻辑"></a>1. 绑定<code>APIKey</code>命令逻辑</h5><p>要想使用<code>OpenAI</code>的api，首先需要将自己的<code>ApiKey</code>与插件进行关联。这里使用<code>VSCode</code>自有API<code>vscode.window.showInputBox</code>来获取用户输入.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">apiKey</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">globalState</span>.<span class="title function_">get</span>(<span class="string">&#x27;chatgpt-api-key&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">apiKey</span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> apiKeyInput = <span class="keyword">await</span> vscode.<span class="property">window</span>.<span class="title function_">showInputBox</span>(&#123;</span><br><span class="line">       <span class="attr">prompt</span>: <span class="string">&quot;请输入你的API Key&quot;</span>,</span><br><span class="line">       <span class="attr">ignoreFocusOut</span>: <span class="literal">true</span>,</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">apiKey</span> = apiKeyInput;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">globalState</span>.<span class="title function_">update</span>(<span class="string">&#x27;chatgpt-api-key&#x27;</span>, <span class="variable language_">this</span>.<span class="property">apiKey</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用上下文的<code>globalState</code>来持久化保存<code>ApiKey</code></li>
<li>如果要让这个命令生效，需要在<code>activate</code>中进行注册<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">context.<span class="property">subscriptions</span>.<span class="title function_">push</span>(vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.setAPIKey&#x27;</span>, resetToken))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">resetToken</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">await</span> vscode.<span class="property">window</span>.<span class="title function_">showInputBox</span>(&#123;</span><br><span class="line">          <span class="attr">prompt</span>: <span class="string">&quot;请输入OpenAI API Key&quot;</span>,</span><br><span class="line">          <span class="attr">ignoreFocusOut</span>: <span class="literal">true</span>,</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>执行<code>command + shift + p</code> 输入命令title<code>GPT:绑定APIKey</code>后，展示效果如下：<img src="https://s2.loli.net/2023/08/22/q7t5SXMerksjfFU.png" alt="截屏2023-08-21 16.33.01"><br>这样就完成了对用户<code>ApiKey</code>的绑定逻辑.</p>
</blockquote>
</li>
</ul>
<h5 id="2-命令触发逻辑"><a href="#2-命令触发逻辑" class="headerlink" title="2. 命令触发逻辑"></a>2. 命令触发逻辑</h5><p>与绑定用户<code>ApiKey</code>类似，其他命令的执行也是同样的流程，这里以<code>onCommand:chatgpt-for-vscode.askGPT</code>命令来说明：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册命令</span></span><br><span class="line">vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.askGPT&#x27;</span>, askChatGPT)</span><br><span class="line"><span class="comment">// 命令实现</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">askChatGPT</span>(<span class="params">userInput: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> editor = vscode.<span class="property">window</span>.<span class="property">activeTextEditor</span>;</span><br><span class="line">  <span class="keyword">if</span> (editor) &#123;</span><br><span class="line">      <span class="keyword">const</span> selectedCode = editor.<span class="property">document</span>.<span class="title function_">getText</span>(vscode.<span class="property">window</span>.<span class="property">activeTextEditor</span>?.<span class="property">selection</span>);</span><br><span class="line">      <span class="keyword">if</span>(selectedCode.<span class="property">length</span>) &#123;</span><br><span class="line">        chatViewProvider.<span class="title function_">sendOpenAiApiRequest</span>(userInput, selectedCode);</span><br><span class="line">        vscode.<span class="property">window</span>.<span class="title function_">showInformationMessage</span>(selectedCode);</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        vscode.<span class="property">window</span>.<span class="title function_">showInformationMessage</span>(<span class="string">`请选中一段代码`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注册命令后 使用<code>editor.document.getText(vscode.window.activeTextEditor?.selection)</code>来获取选中的代码段落，并判空.</li>
<li>利用<code>chatViewProvider.sendOpenAiApiRequest(userInput, selectedCode);</code>利用这个方法用户输入的<code>Prompt</code><br>与选中的代码端传递出去，这个方法的实现后面介绍，注册所有的命令后，<code>activate</code>方法是这样的<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">activate</span>(<span class="params">context: vscode.ExtensionContext</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> chatViewProvider = <span class="keyword">new</span> view_provider.<span class="title function_">default</span>(context);</span><br><span class="line"></span><br><span class="line">	context.<span class="property">subscriptions</span>.<span class="title function_">push</span>(</span><br><span class="line">	vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.askGPT&#x27;</span>, askChatGPT), </span><br><span class="line">	vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.whyBroken&#x27;</span>, askGPTWhyBroken), </span><br><span class="line">	vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.explainCode&#x27;</span>, askGPTToExplain), </span><br><span class="line">	vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.refactor&#x27;</span>, askGPTToRefactor), </span><br><span class="line">	vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.optimizeCode&#x27;</span>, askGPTToOptimize), </span><br><span class="line">	vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&#x27;chatgpt-for-vscode.setAPIKey&#x27;</span>, resetToken), </span><br><span class="line">	vscode.<span class="property">window</span>.<span class="title function_">registerWebviewViewProvider</span>(<span class="string">&quot;chatgpt-for-vscode.view&quot;</span>, chatViewProvider, &#123;</span><br><span class="line">		<span class="attr">webviewOptions</span>: &#123; <span class="attr">retainContextWhenHidden</span>: <span class="literal">true</span> &#125;&#125;)</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">askGPTWhyBroken</span>(<span class="params"></span>) &#123; <span class="keyword">await</span> <span class="title function_">askChatGPT</span>(<span class="string">&#x27;说明下面的代码会出现什么问题?&#x27;</span>); &#125;</span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">askGPTToExplain</span>(<span class="params"></span>) &#123; <span class="keyword">await</span> <span class="title function_">askChatGPT</span>(<span class="string">&#x27;请帮我解释一下下面的代码?&#x27;</span>); &#125;</span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">askGPTToRefactor</span>(<span class="params"></span>) &#123; <span class="keyword">await</span> <span class="title function_">askChatGPT</span>(<span class="string">&#x27;帮我重构下面的代码&#x27;</span>); &#125;</span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">askGPTToOptimize</span>(<span class="params"></span>) &#123; <span class="keyword">await</span> <span class="title function_">askChatGPT</span>(<span class="string">&#x27;帮我优化下面的代码&#x27;</span>); &#125;</span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">resetToken</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">await</span> chatViewProvider.<span class="title function_">ensureApiKey</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">askChatGPT</span>(<span class="params">userInput: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> editor = vscode.<span class="property">window</span>.<span class="property">activeTextEditor</span>;</span><br><span class="line">        <span class="keyword">if</span> (editor) &#123;</span><br><span class="line">            <span class="keyword">const</span> selectedCode = editor.<span class="property">document</span>.<span class="title function_">getText</span>(vscode.<span class="property">window</span>.<span class="property">activeTextEditor</span>?.<span class="property">selection</span>);</span><br><span class="line">			<span class="keyword">if</span>(selectedCode.<span class="property">length</span>) &#123;</span><br><span class="line">				chatViewProvider.<span class="title function_">sendOpenAiApiRequest</span>(userInput, selectedCode);</span><br><span class="line">				vscode.<span class="property">window</span>.<span class="title function_">showInformationMessage</span>(selectedCode);</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				vscode.<span class="property">window</span>.<span class="title function_">showInformationMessage</span>(<span class="string">`请选中一段代码`</span>);</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="3-webView与chatViewProvider"><a href="#3-webView与chatViewProvider" class="headerlink" title="3.webView与chatViewProvider"></a>3.webView与chatViewProvider</h5><p>上面的代码除了注册命令的API<code>registerCommand</code>,还有一个注册自定义<code>webview</code>视图的API，<code>registerWebviewViewProvider</code>,作用是展示我们自定义的<code>webview</code>,它有三个参数：</p>
<ul>
<li><code>chatgpt-for-vscode.view</code>是视图Id，跟<code>package.json</code>中<code>views</code>模块对应的Id相同，表示为那个视图Id注册<code>provider</code>.</li>
<li><code>chatViewProvider</code> 视图提供者.</li>
<li>第三个参数：<code>webview</code>的属性配置，<code>retainContextWhenHidden: true</code>表示：<code>webview</code>被隐藏时保持状态，避免被重置.<br>接下来重点来看<code>chatViewProvider</code>:<br>作为自定义视图的<code>provider</code>首先需要继承<code>vscode.WebviewViewProvider</code>这个接口<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">WebviewViewProvider</span> &#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Revolves a webview view.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * `resolveWebviewView` is called when a view first becomes visible. This may happen when the view is</span></span><br><span class="line"><span class="comment">		 * first loaded or when the user hides and then shows a view again.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> webviewView Webview view to restore. The provider should take ownership of this view. The</span></span><br><span class="line"><span class="comment">		 *    provider must set the webview&#x27;s `.html` and hook up all webview events it is interested in.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> context Additional metadata about the view being resolved.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> token Cancellation token indicating that the view being provided is no longer needed.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> Optional thenable indicating that the view has been fully resolved.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="title function_">resolveWebviewView</span>(<span class="attr">webviewView</span>: <span class="title class_">WebviewView</span>, <span class="attr">context</span>: <span class="title class_">WebviewViewResolveContext</span>, <span class="attr">token</span>: <span class="title class_">CancellationToken</span>): <span class="title class_">Thenable</span>&lt;<span class="built_in">void</span>&gt; | <span class="built_in">void</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
这个接口只有一个方法，<code>resolveWebviewView</code>在视图首次可见时被调用。这可能发生在视图第一次加载时，或者当用户隐藏然后再次显示视图时。在这个方面里面设置<code>webview</code>的<code>html</code>与视图属性。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ChatGptViewProvider</span> <span class="keyword">implements</span> vscode.<span class="property">WebviewViewProvider</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> webView?: vscode.<span class="property">WebviewView</span>;</span><br><span class="line">    <span class="keyword">private</span> apiKey?: <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">private</span> message?: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> context: vscode.ExtensionContext</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">resolveWebviewView</span>(<span class="params"></span></span><br><span class="line"><span class="params">        webviewView: vscode.WebviewView,</span></span><br><span class="line"><span class="params">        _context: vscode.WebviewViewResolveContext,</span></span><br><span class="line"><span class="params">        _token: vscode.CancellationToken,</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">webView</span> = webviewView;</span><br><span class="line">        <span class="comment">// webview属性设置</span></span><br><span class="line">        webviewView.<span class="property">webview</span>.<span class="property">options</span> = &#123;</span><br><span class="line">            <span class="attr">enableScripts</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">localResourceRoots</span>: [<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">extensionUri</span>]</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 返回Html代码</span></span><br><span class="line">        webviewView.<span class="property">webview</span>.<span class="property">html</span> = <span class="variable language_">this</span>.<span class="title function_">getHtml</span>(webviewView.<span class="property">webview</span>);</span><br><span class="line">        <span class="comment">// 接收</span></span><br><span class="line">        webviewView.<span class="property">webview</span>.<span class="title function_">onDidReceiveMessage</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">&#x27;askChatGPT&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">sendOpenAiApiRequest</span>(data.<span class="property">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">message</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendMessageToWebView</span>(<span class="variable language_">this</span>.<span class="property">message</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">message</span> = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="4-通信机制"><a href="#4-通信机制" class="headerlink" title="4. 通信机制"></a>4. 通信机制</h5><p>自定义的<code>webview</code>和普通网页非常类似，都不能直接调用任何<code>VSCodeAPI</code>，但是，它唯一特别之处就在于多了一个名叫<code>acquireVsCodeApi</code>的方法，执行这个方法会返回一个超级阉割版的<code>vscode</code>对象.利用这个对象，可以实现<code>webview</code>与插件也就是<code>provider</code>的通信。</p>
<ul>
<li><code>provider</code>给<code>webview</code>发送消息：<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">webView</span>?.<span class="property">webview</span>.<span class="title function_">postMessage</span>(message);</span><br></pre></td></tr></table></figure></li>
<li><code>webview</code>端接收消息：<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> message = event.<span class="property">data</span>;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Webview接收到的消息：&#x27;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>webview</code>主动发送消息给<code>provider</code>：<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vscode = <span class="title function_">acquireVsCodeApi</span>();</span><br><span class="line">vscode.<span class="title function_">postMessage</span>(&#123;<span class="attr">text</span>: <span class="string">&#x27;你好，我是Webview啊！&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure></li>
<li><code>provider</code>接收消息：<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">webView</span>?.<span class="property">webview</span>.<span class="title function_">onDidReceiveMessage</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">&#x27;askChatGPT&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">sendOpenAiApiRequest</span>(data.<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
了解完双方的通信机制后，基本逻辑是：当点击<code>webview</code>上的<code>发送</code>按钮后，将用户输入发送给<code>ChatGPT</code>，<code>ChatGPT</code>处理完成后将返回信息发送给<code>webview</code>，<code>webview</code>将回答信息展示出来，完成一次对话逻辑。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按钮绑定点击事件</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;ask-button&quot;</span>)?.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, submitHandler);</span><br><span class="line"><span class="keyword">let</span> submitHandler = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    e.<span class="title function_">preventDefault</span>();</span><br><span class="line">    e.<span class="title function_">stopPropagation</span>();</span><br><span class="line">    <span class="keyword">const</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;question-input&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (input.<span class="property">value</span>?.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 发送消息给 插件，使其完成ChatGPT请求</span></span><br><span class="line">        vscode.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;askChatGPT&quot;</span>,</span><br><span class="line">            <span class="attr">value</span>: input.<span class="property">value</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        input.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="5-调用OPenAI接口"><a href="#5-调用OPenAI接口" class="headerlink" title="5. 调用OPenAI接口"></a>5. 调用<code>OPenAI</code>接口</h5><p>要想完成一次对话，需要调用<code>OPenAI</code>的API.具体的API你可以在官网找到：<br><img src="https://s2.loli.net/2023/08/22/9Q1linjCp754hZU.png" alt="pic"></p>
<ul>
<li><p>参数<code>model</code>是你要对话的<code>ChatGPT</code>模型代码，不同模型针对同一个问题的答案会有所区别。具体模块区别可以参考下面图片：<br><img src="https://s2.loli.net/2023/08/22/H5XpyCLc2J4nru9.png" alt="pic1"><br>更多模型可以点击<a target="_blank" rel="noopener" href="https://platform.openai.com/docs/models/overview">这里</a>去查看</p>
</li>
<li><p>参数<code>messages</code>: 你的问题信息</p>
</li>
<li><p>参数<code>temperature</code>: 它是一个用于控制生成文本的创造性的参数，其值介于0到2之间。值为1意味着模型将使用其默认采样策略，而值低于1.0将导致更保守和可预测的响应，值大于1.0将导致更有创造性和多样化的响应。</p>
</li>
<li><p>参数<code>max_tokens</code>: 生成对话的最大<code>token</code>数量。这里的<code>token</code>可以理解为模型的构建块。了解完成上面的参数，可以利用<code>fetch</code>发起请求了：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">let</span> completion =  <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.openai.com/v1/chat/completions&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;text-davinci-003&quot;</span>,</span><br><span class="line">        <span class="attr">messages</span>: [&#123; <span class="attr">role</span>: <span class="string">&quot;user&quot;</span>, <span class="attr">content</span>: question &#125;],</span><br><span class="line">        <span class="attr">temperature</span>: <span class="number">0.7</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="comment">// eslint-disable-next-line @typescript-eslint/naming-convention</span></span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="title class_">Authorization</span>: <span class="string">&#x27;Bearer &#x27;</span> + <span class="variable language_">this</span>.<span class="property">apiKey</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;) <span class="keyword">as</span> <span class="built_in">any</span>;</span><br></pre></td></tr></table></figure>
<p>根据返回的数据结构，解析响应数据，并将结果发送给<code>webview</code>进行展示，完成开发。<br><img src="https://s2.loli.net/2023/08/22/6I7N5Cb9FMDvTSW.png" alt="pic"></p>
</li>
</ul>
<h4 id="发布插件"><a href="#发布插件" class="headerlink" title="发布插件"></a>发布插件</h4><ul>
<li><p>扩展安装<br>通过以上步骤基本完成了插件的开发，接下来有两种方式发布我们的插件，如果你的插件只是在内网使用，可以通过命令：<code>vsce package</code>, 将插件打包为<code>vsix</code>插件包，通过<code>VSCode</code>的扩展，从<code>VSIX</code>安装.<br>当然首先要安装<code>vsce</code>这个工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vsce -g</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2023/08/22/gvUY9x1yCM6mTiq.png" alt="pic"></p>
</li>
<li><p>上传到应用<code>VSCode</code>插件市场</p>
<p>插件上传到<code>VSCode</code>应用市场，需要有应用市场的<code>publisher</code>账号,具体的账号创建流程这里不再涉及，创建账号后，登录当前账号，执行<code>vsce publish</code>,发布成功后大概需要过几分钟才能在应用市场搜到.发布账号有几个注意事项：</p>
</li>
<li><p><code>README.md</code>文件默认会显示在插件主页；</p>
</li>
<li><p><code>README.md</code>中的资源必须全部是HTTPS的，如果是HTTP会发布失败；</p>
</li>
<li><p><code>CHANGELOG.md</code>会显示在变更选项卡；</p>
</li>
<li><p>如果代码是放在<code>git</code>仓库并且设置了<code>repository</code>字段，发布前必须先提交<code>git</code>，否则会提示<code>Git working directory not clean</code></p>
</li>
<li><p>发布后需要等待几分钟应用市场才会更新；</p>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>以上就是一个<code>ChatGPT</code>插件的基本创建流程，核心是对<code>VSCode API</code>以及<code>ChatGPT API</code>的了解与使用。当然你所需要的功能都可以在对应的官方文档中找到。</p>
<h4 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h4><p><a target="_blank" rel="noopener" href="https://code.visualstudio.com/api/extension-guides/overview">https://code.visualstudio.com/api/extension-guides/overview</a><br><a target="_blank" rel="noopener" href="https://platform.openai.com/docs/api-reference/chat/create">https://platform.openai.com/docs/api-reference/chat/create</a><br><a target="_blank" rel="noopener" href="http://blog.haoji.me/vscode-plugin-publish.html">http://blog.haoji.me/vscode-plugin-publish.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2023/08/23/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%8F%91%E4%B8%80%E6%AC%BEChatGPT%20VSCode%E6%8F%92%E4%BB%B6/" data-id="cllnfb8pa000d3fex2b8u8vfd" data-title="从零开发一款ChatGPT VSCode插件" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-浅谈Vue3响应式原理与源码解读" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/26/%E6%B5%85%E8%B0%88Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2023-05-26T12:46:25.000Z" itemprop="datePublished">2023-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/26/%E6%B5%85%E8%B0%88Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">浅谈Vue3响应式原理与源码解读</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-了解几个概念"><a href="#一-了解几个概念" class="headerlink" title="一. 了解几个概念"></a>一. 了解几个概念</h3><h4 id="什么是响应式"><a href="#什么是响应式" class="headerlink" title="什么是响应式"></a>什么是响应式</h4><p>在开始响应式原理与源码解析之前，需要先了解一下什么是响应式？首先明确一个概念：<strong>响应式是一个过程</strong>，它有两个参与方：</p>
<ul>
<li>触发方：<strong>数据</strong></li>
<li>响应方：<strong>引用数据的函数</strong></li>
</ul>
<p>当数据发生改变时，引用数据的函数会自动重新执行，例如，视图渲染中使用了数据，数据改变后，视图也会自动更新，这就完成了一个响应的过程。</p>
<h4 id="副作用函数"><a href="#副作用函数" class="headerlink" title="副作用函数"></a>副作用函数</h4><p>在<code>Vue</code>与<code>React</code>中都有副作用函数的概念，什么是副作用函数？如果一个函数引用了外部的数据，这个函数会受到外部数据改变的影响，我们就说这个函数存在<strong>副作用</strong>，也就是我们所说的<strong>副作用函数</strong>。初听这个名字不太好理解，其实 副作用函数就是<strong>引用了数据的函数</strong>或是<strong>与数据相关联的函数</strong>。举个例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= BASE_URL %&gt;favicon.ico&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&lt;%= htmlWebpackPlugin.options.title %&gt;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> obj = &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 副作用函数 effect</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            app.<span class="property">innerHTML</span> = obj.<span class="property">name</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, obj.<span class="property">name</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">effect</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            obj.<span class="property">name</span> = <span class="string">&#x27;ming&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 手动执行 effect 函数</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">effect</span>()</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在上面例子中，<code>effect</code>函数里面引用了外部的数据<code>obj.name</code>,如果这个数据发生了改变，则会影响到这个函数，类似<code>effect</code>的这种函数就是副作用函数。</p>
<h4 id="实现响应式的基本步骤"><a href="#实现响应式的基本步骤" class="headerlink" title="实现响应式的基本步骤"></a>实现响应式的基本步骤</h4><p>在上面的例子中,当<code>obj.name</code>发生了改变，<code>effect</code>是我们手动执行的，如果能监听到<code>obj.name</code>的变化，让其自动执行副作用函数<code>effect</code>，那么就实现了响应式的过程。其实无论是 <code>Vue2</code> 还是 <code>Vue3</code> ，响应式的核心都是 <code>数据劫持/代理、依赖收集、依赖更新</code>，只不过由于实现数据劫持方式的差异从而导致具体实现的差异。</p>
<ul>
<li><p><code>Vue2</code>响应式：<code>基于Object.defineProperty()</code>实现的数据的劫持</p>
</li>
<li><p><code>Vue3</code>响应式：基于<code>Proxy</code>实现对整个对象的代理</p>
</li>
</ul>
<p>关于<code>Vue2</code>的响应式这里不做重点讲解，这篇文章主要关注<code>Vue3</code>响应式原理的实现。</p>
<h3 id="二-Proxy-与-Reflect"><a href="#二-Proxy-与-Reflect" class="headerlink" title="二. Proxy 与 Reflect"></a>二. Proxy 与 Reflect</h3><p>在解析<code>Vue3</code>的响应式原理之前，首先需要了解两个ES6新增的API:<code>Porxy</code>与<code>Reflect</code>。</p>
<h4 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h4><p><code>Proxy</code>: 代理，顾名思义主要用于为对象创建一个代理，从而实现对<strong>对象基本操作</strong>的拦截和自定义。可以理解成，在目标对象之前架设一层“拦截”，外界对该对象的访问，都必须先通过这层拦截，因此提供了一种机制，可以对外界的访问进行过滤和改写。基本语法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler);</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>target</code>: 需要拦截的目标对象</p>
</li>
<li><p><code>handler</code>: 也是一个对象，用来定制拦截行为<br>举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> objProxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj,&#123;&#125;)</span><br><span class="line">objProxy.<span class="property">age</span> = <span class="number">20</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;obj.age&#x27;</span>,obj.<span class="property">age</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;objProxy.age&#x27;</span>,objProxy.<span class="property">age</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;obj与objProxy是否相等&#x27;</span>,obj === objProxy);</span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line">[<span class="title class_">Log</span>] obj.<span class="property">age</span> – <span class="number">20</span></span><br><span class="line">[<span class="title class_">Log</span>] objProxy.<span class="property">age</span> – <span class="number">20</span> </span><br><span class="line">[<span class="title class_">Log</span>] obj与objProxy是否相等 – <span class="literal">false</span> </span><br></pre></td></tr></table></figure>
<p>这里<code>objProxy</code>的<code>handler</code>为空，则直接指向被代理对象,并且代理对象与数据源对象并<strong>不全等</strong>.如果需要更加灵活的拦截对象的操作，就需要在<code>handler</code>中添加对应的属性。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`获取对象属性<span class="subst">$&#123;key&#125;</span>值`</span>)</span><br><span class="line">        <span class="keyword">return</span> target[key]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`设置对象属性<span class="subst">$&#123;key&#125;</span>值`</span>)</span><br><span class="line">        target[key] = value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">deleteProperty</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`删除对象属性<span class="subst">$&#123;key&#125;</span>值`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">delete</span> target[key]</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, handler)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxy.<span class="property">age</span>)</span><br><span class="line">proxy.<span class="property">age</span> = <span class="number">20</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> proxy.<span class="property">age</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line">[<span class="title class_">Log</span>] 获取对象属性age值 (example01.<span class="property">html</span>, line <span class="number">22</span>)</span><br><span class="line">[<span class="title class_">Log</span>] <span class="number">16</span> (example01.<span class="property">html</span>, line <span class="number">36</span>)</span><br><span class="line">[<span class="title class_">Log</span>] 设置对象属性age值 (example01.<span class="property">html</span>, line <span class="number">26</span>)</span><br><span class="line">[<span class="title class_">Log</span>] 删除对象属性age值 (example01.<span class="property">html</span>, line <span class="number">30</span>)</span><br><span class="line">[<span class="title class_">Log</span>] <span class="literal">true</span> (example01.<span class="property">html</span>, line <span class="number">38</span>)</span><br></pre></td></tr></table></figure>
<p>上面的例子，我们在捕获器中定义了<code>set()</code>、<code>get()</code>、<code>deleteProperty()</code>属性，通过对<code>proxy</code>的操作实现了对<code>obj</code>的操作拦截。这些属性的触发方法有如下参数：</p>
</li>
<li><p><code>target</code> —— 是目标对象，该对象被作为第一个参数传递给<code>new Proxy</code></p>
</li>
<li><p><code>key</code> —— 目标属性名称</p>
</li>
<li><p><code>value</code> —— 目标属性的值</p>
</li>
<li><p><code>receiver</code> —— 指向的是当前操作 正确的上下文。如果目标属性是一个 <code>getter</code> 访问器属性，则 <code>receiver</code> 就是本次读取属性所指向的 <code>this</code> 对象。通常，<code>receiver</code>这就是 <code>proxy</code> 对象本身,但是如果我们从 <code>proxy</code> 继承，则<code>receiver</code>指的是从该 <code>proxy</code> 继承的对象</p>
</li>
<li><p>当然除了以上三个还有一些常用的属性操作方法：</p>
<ul>
<li><code>has()</code>，拦截：in操作符.</li>
<li><code>ownKeys()</code>,拦截：</li>
</ul>
</li>
</ul>
<p><code>Object.getOwnPropertyNames(proxy)  Object.getOwnPropertySymbols(proxy)  Object.keys(proxy)</code></p>
<ul>
<li><code>construct()</code>,拦截：<code>new</code> 操作等</li>
</ul>
<h4 id="Reflect"><a href="#Reflect" class="headerlink" title="Reflect"></a>Reflect</h4><p><code>Reflect</code>: 反射，就是将代理的内容反射出去。<code>Reflect</code>与<code>Proxy</code>一样，也是 <code>ES6</code> 为了操作对象而提供的新 <code>API</code>。它提供拦截<code>JavaScript</code>操作的方法，这些方法与<code>Proxy handlers</code> 提供的的方法是一一对应的，只要是<code>Proxy</code>对象的方法，就能在<code>Reflect</code>对象上找到对应的方法。且 <code>Reflect</code> 不是一个函数对象，即不能进行实例化，其所有属性和方法都是静态的。还是上面的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`获取对象属性<span class="subst">$&#123;key&#125;</span>值`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`设置对象属性<span class="subst">$&#123;key&#125;</span>值`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">deleteProperty</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`删除对象属性<span class="subst">$&#123;key&#125;</span>值`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">deleteProperty</span>(target, key)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, handler)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxy.<span class="property">age</span>)</span><br><span class="line">proxy.<span class="property">age</span> = <span class="number">20</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> proxy.<span class="property">age</span>)</span><br></pre></td></tr></table></figure>
<p>上面的例子中</p>
<ul>
<li><code>Reflect.get()</code>代替<code>target[key]</code>操作</li>
<li><code>Reflect.set()</code>代替<code>target[key] = value</code>操作</li>
<li><code>Reflect.deleteProperty()</code>代替<code>delete target[key]</code>操作<br>当然除了上面的方法还有一些常用的<code>Reflect</code>方法：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">construct</span>(target, args)</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">has</span>(target, name)</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(target)</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getPrototypeOf</span>(target)</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">setPrototypeOf</span>(target, prototype)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="三-reactive、ref源码解析"><a href="#三-reactive、ref源码解析" class="headerlink" title="三. reactive、ref源码解析"></a>三. reactive、ref源码解析</h3><p>了解了<code>Proxy</code>与<code>Reflect</code>，看下<code>Vue3</code>是如何通过<code>porxy</code>实现响应式的。其核心是下面要介绍的两个方法：<code>reactive</code>、<code>ref</code>.这里依照<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue">Vue3.2</a>版本的源码进行解析。</p>
<h4 id="reactive的源码实现"><a href="#reactive的源码实现" class="headerlink" title="reactive的源码实现"></a>reactive的源码实现</h4><p>打开源文件，找到文件<code>packages/reactivity/src/reactive.ts</code> 查看源码。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">target: <span class="built_in">object</span></span>) &#123;</span><br><span class="line">  <span class="comment">// if trying to observe a readonly proxy, return the readonly version.</span></span><br><span class="line">  <span class="keyword">if</span> (target &amp;&amp; (target <span class="keyword">as</span> <span class="title class_">Target</span>)[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createReactiveObject</span>(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    mutableHandlers,</span><br><span class="line">    mutableCollectionHandlers,</span><br><span class="line">    reactiveMap</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>刚开始对<code>target</code>进行响应式只读判断，如果为<code>true</code>，则直接返回<code>target</code>，<code>reactive</code>实现的核心方法是<code>createReactiveObject()</code>：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createReactiveObject</span>(<span class="params"></span></span><br><span class="line"><span class="params">  target: Target,</span></span><br><span class="line"><span class="params">  isReadonly: boolean,</span></span><br><span class="line"><span class="params">  baseHandlers: ProxyHandler&lt;any&gt;,</span></span><br><span class="line"><span class="params">  collectionHandlers: ProxyHandler&lt;any&gt;,</span></span><br><span class="line"><span class="params">  proxyMap: <span class="built_in">WeakMap</span>&lt;Target, any&gt;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`value cannot be made reactive: <span class="subst">$&#123;<span class="built_in">String</span>(target)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target is already a Proxy, return it.</span></span><br><span class="line">  <span class="comment">// exception: calling readonly() on a reactive object</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    target[<span class="title class_">ReactiveFlags</span>.<span class="property">RAW</span>] &amp;&amp;</span><br><span class="line">    !(isReadonly &amp;&amp; target[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>])</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target already has corresponding Proxy</span></span><br><span class="line">  <span class="keyword">const</span> existingProxy = proxyMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (existingProxy) &#123;</span><br><span class="line">    <span class="keyword">return</span> existingProxy</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// only a whitelist of value types can be observed.</span></span><br><span class="line">  <span class="keyword">const</span> targetType = <span class="title function_">getTargetType</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (targetType === <span class="title class_">TargetType</span>.<span class="property">INVALID</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">    target,</span><br><span class="line">    targetType === <span class="title class_">TargetType</span>.<span class="property">COLLECTION</span> ? collectionHandlers : baseHandlers</span><br><span class="line">  )</span><br><span class="line">  proxyMap.<span class="title function_">set</span>(target, proxy)</span><br><span class="line">  <span class="keyword">return</span> proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>createReactiveObject()</code>方法有五个参数：<ul>
<li><code>target</code>： 传入的原始目标对象</li>
<li><code>isReadonly</code>: 是否是只读的标识</li>
<li><code>baseHandlers</code>: 为普通对象创建<code>proxy</code>时的第二个参数<code>handler</code></li>
<li><code>collectionHandlers</code>: 为<code>collection</code>类型对象创建<code>proxy</code>时的第二个参数<code>handler</code></li>
<li><code>proxyMap</code>: <code>WeakMap</code>类型的<code>map</code>，主要用于存储 <code>target</code>与他的<code>proxy</code>之间的对应关系<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">targetTypeMap</span>(<span class="params">rawType: string</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (rawType) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Object&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Array&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">TargetType</span>.<span class="property">COMMON</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Map&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Set&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;WeakMap&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;WeakSet&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">TargetType</span>.<span class="property">COLLECTION</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">TargetType</span>.<span class="property">INVALID</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>源码可以看到，他将对象分为<code>COMMON</code>对象（<code>Object</code>和<code>Array</code>）与<code>COLLECTION</code>类型对象(<code>Map</code>、<code>Set</code>、<code>WeakMap</code>、<code>WeakSet</code>),这样区分的主要目的是为了根据不通的对象类型，来定制不同的<code>handler</code></li>
<li>在<code>createReactiveObject()</code>的前几行，进行了一系列的判断：<ul>
<li>首先判断<code>target</code>是否是对象，如果为<code>false</code>,直接<code>return</code></li>
<li>判断<code>target</code>是否是响应式对象，如果为<code>true</code>,直接<code>return</code></li>
<li>判断是否已经为<code>target</code>创建过<code>proxy</code>了，如果为<code>true</code>,直接<code>return</code></li>
<li>判断<code>target</code>是否是刚才上面提到的6种对象类型，如果为<code>false</code>,直接<code>return</code></li>
<li>如果以上条件都满足，则为<code>target</code>创建<code>proxy</code>,并<code>return</code>这个<code>proxy</code></li>
</ul>
</li>
</ul>
<p>接下来就是根据不同的对象类型，传入不同的<code>handler</code>的逻辑处理了，主要关注<code>baseHandlers</code>，里面存在五个属性操作方法，这重点解析<code>get</code>与<code>set</code>方法。</p>
<blockquote>
<p>源码位置：<code>packages/reactivity/src/baseHandlers.ts</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">mutableHandlers</span>: <span class="title class_">ProxyHandler</span>&lt;object&gt; = &#123;</span><br><span class="line">  get,</span><br><span class="line">  set,</span><br><span class="line">  deleteProperty,</span><br><span class="line">  has,</span><br><span class="line">  ownKeys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="get与依赖收集"><a href="#get与依赖收集" class="headerlink" title="get与依赖收集"></a><code>get</code>与依赖收集</h5><ul>
<li><p>可以看到<code>mutableHandlers</code>里面就是我们熟悉的各种钩子函数。当我们对<code>proxy</code>对象进行访问或是修改时，调用相应的函数进行处理。首先看<code>get</code>里面是如何对访问<code>target</code>的副作用函数进行收集的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createGetter</span>(<span class="params">isReadonly = <span class="literal">false</span>, shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">target: Target, key: string | symbol, receiver: object</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> !isReadonly</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadonly</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      key === <span class="title class_">ReactiveFlags</span>.<span class="property">RAW</span> &amp;&amp;</span><br><span class="line">      receiver ===</span><br><span class="line">        (isReadonly</span><br><span class="line">          ? shallow</span><br><span class="line">            ? shallowReadonlyMap</span><br><span class="line">            : readonlyMap</span><br><span class="line">          : shallow</span><br><span class="line">            ? shallowReactiveMap</span><br><span class="line">            : reactiveMap</span><br><span class="line">        ).<span class="title function_">get</span>(target)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> target</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetIsArray = <span class="title function_">isArray</span>(target)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReadonly &amp;&amp; targetIsArray &amp;&amp; <span class="title function_">hasOwn</span>(arrayInstrumentations, key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(arrayInstrumentations, key, receiver)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSymbol</span>(key) ? builtInSymbols.<span class="title function_">has</span>(key) : <span class="title function_">isNonTrackableKeys</span>(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReadonly) &#123;</span><br><span class="line">      <span class="title function_">track</span>(target, <span class="title class_">TrackOpTypes</span>.<span class="property">GET</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shallow) &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isRef</span>(res)) &#123;</span><br><span class="line">      <span class="comment">// ref unwrapping - does not apply for Array + integer key.</span></span><br><span class="line">      <span class="keyword">const</span> shouldUnwrap = !targetIsArray || !<span class="title function_">isIntegerKey</span>(key)</span><br><span class="line">      <span class="keyword">return</span> shouldUnwrap ? res.<span class="property">value</span> : res</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(res)) &#123;</span><br><span class="line">      <span class="comment">// Convert returned value into a proxy as well. we do the isObject check</span></span><br><span class="line">      <span class="comment">// here to avoid invalid value warning. Also need to lazy access readonly</span></span><br><span class="line">      <span class="comment">// and reactive here to avoid circular dependency.</span></span><br><span class="line">      <span class="keyword">return</span> isReadonly ? <span class="title function_">readonly</span>(res) : <span class="title function_">reactive</span>(res)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>如果<code>key</code>值为<code>__v_isReactive</code>、<code>__v_isReadonly</code>进行相应的返回，如果<code>key===&#39;__v_raw&#39;</code>并且<code>WeakMap</code>中<code>key</code>为<code>target</code>的值不为空，则返回<code>target</code></p>
</li>
<li><p>如果<code>target</code>是数组，则 <strong>重写&#x2F;增强</strong> 数组对应的方法</p>
<ul>
<li>数组元素的<strong>查找方法</strong>：<code>includes、indexOf、lastIndexOf</code></li>
<li><strong>修改原数组</strong> 的方法：<code>push、pop、unshift、shift、splice</code></li>
</ul>
<p>在这些方法里面调用<code>track()</code>进行依赖收集</p>
</li>
<li><p>对<code>Reflect.get()</code>方法的返回值，也就是当前数据对象的属性值<code>res</code>进行判断，如果<code>res</code>是普通对象且非只读，则调用<code>track()</code>进行依赖收集</p>
</li>
<li><p>如果<code>res</code>是浅层响应，直接返回，如果<code>res</code>是<code>ref</code>对象，则返回其<code>value</code>值</p>
</li>
<li><p>如果<code>res</code>是 <strong>对象类型</strong>并且是<strong>只读</strong>的，则调用<code>readonly(res)</code>,否则递归调用<code>reactive(res)</code>方法</p>
</li>
<li><p>如果以上都不满足，直接向外返回对应的 <strong>属性值</strong></p>
</li>
</ul>
<blockquote>
<p>那么核心方法就是如果利用**<code>track()</code>**进行依赖收集的处理了,源码在&#96;&#96;packages&#x2F;reactivity&#x2F;src&#x2F;effect.ts&#96;</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target: object, type: TrackOpTypes, key: unknown</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isTracking</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    targetMap.<span class="title function_">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">  <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">    depsMap.<span class="title function_">set</span>(key, (dep = <span class="title function_">createDep</span>()))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> eventInfo = __DEV__</span><br><span class="line">    ? &#123; <span class="attr">effect</span>: activeEffect, target, type, key &#125;</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">trackEffects</span>(dep, eventInfo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>首先进行是否正在进行依赖收集的判断处理</p>
</li>
<li><p><code>const targetMap = new WeakMap&lt;any, KeyToDepMap&gt;()</code>创建一个<code>targetMap</code>容器，用于保存和当前响应式对象相关的依赖内容，本身是一个 <code>WeakMap</code>类型</p>
</li>
<li><p>将对应的 <strong>响应式对象</strong> 作为 <code>targetMap</code> 的 <strong>键</strong>，<code>targetMap</code>的<strong>Value</strong>是一个<code>depsMap</code>（属于 <code>Map</code> 实例）， <code>depsMap</code> 存储的就是和当前响应式对象的每一个 <code>key</code> 对应的具体依赖</p>
</li>
<li><p><code>depsMap</code>的<strong>键</strong>是响应式数据对象的key，<strong>Value</strong>是一个<code>deps</code>（属于 <code>Set</code> 实例），这里之所以使用<code>Set</code>是为了避免副作用函数的重复添加，避免重复调用</p>
</li>
</ul>
<p>以上就是整个**get()**捕获器以及依赖收集的核心流程。</p>
<h5 id="set与依赖更新"><a href="#set与依赖更新" class="headerlink" title="set与依赖更新"></a><code>set</code>与依赖更新</h5><p>我们在回到<code>baseHandlers</code>中看<code>Set</code>捕获器中是如何进行依赖更新的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createSetter</span>(<span class="params">shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"></span></span><br><span class="line"><span class="params">    target: object,</span></span><br><span class="line"><span class="params">    key: string | symbol,</span></span><br><span class="line"><span class="params">    value: unknown,</span></span><br><span class="line"><span class="params">    receiver: object</span></span><br><span class="line"><span class="params">  </span>): boolean &#123;</span><br><span class="line">    <span class="keyword">let</span> oldValue = (target <span class="keyword">as</span> any)[key]</span><br><span class="line">    <span class="keyword">if</span> (!shallow) &#123;</span><br><span class="line">      value = <span class="title function_">toRaw</span>(value)</span><br><span class="line">      oldValue = <span class="title function_">toRaw</span>(oldValue)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isRef</span>(oldValue) &amp;&amp; !<span class="title function_">isRef</span>(value)) &#123;</span><br><span class="line">        oldValue.<span class="property">value</span> = value</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// in shallow mode, objects are set as-is regardless of reactive or not</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hadKey =</span><br><span class="line">      <span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isIntegerKey</span>(key)</span><br><span class="line">        ? <span class="title class_">Number</span>(key) &lt; target.<span class="property">length</span></span><br><span class="line">        : <span class="title function_">hasOwn</span>(target, key)</span><br><span class="line">    <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">    <span class="comment">// don&#x27;t trigger if target is something up in the prototype chain of original</span></span><br><span class="line">    <span class="keyword">if</span> (target === <span class="title function_">toRaw</span>(receiver)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(target, <span class="title class_">TriggerOpTypes</span>.<span class="property">ADD</span>, key, value)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(value, oldValue)) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(target, <span class="title class_">TriggerOpTypes</span>.<span class="property">SET</span>, key, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先进行旧值的保存<code>oldValue</code></li>
<li>如果不是浅层响应，<code>target</code>是普通对象，并且旧值是个响应式对象，则执行赋值操作：<code>oldValue.value = value</code> ,返回<code>true</code>，表示赋值成功</li>
<li>判断是否存在对应key值<code>hadKey</code></li>
<li>执行<code>Reflect.set</code>设置对应的属性值</li>
<li>判断对象是原始原型链上的内容（非自定义添加），则不触发依赖更新</li>
<li>根据目标对象不存在对应的 key, 调用<code>trigger</code>,进行依赖更新</li>
</ul>
<p>以上就是整个<code>baseHandlers</code>关于<strong>依赖收集</strong>与<strong>依赖更新</strong>的核心流程。</p>
<h4 id="ref的源码实现"><a href="#ref的源码实现" class="headerlink" title="ref的源码实现"></a>ref的源码实现</h4><p>我们知道<code>ref</code>可以定义基本数据类型、引用数据类型的响应式。来看下它的源码实现：<code>packages/reactivity/src/ref.ts</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value?: unknown</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createRef</span>(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createRef</span>(<span class="params">rawValue: unknown, shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRef</span>(rawValue)) &#123;</span><br><span class="line">    <span class="keyword">return</span> rawValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(rawValue, shallow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span>&lt;T&gt; &#123;</span><br><span class="line">  private <span class="attr">_value</span>: T</span><br><span class="line">  private <span class="attr">_rawValue</span>: T</span><br><span class="line"></span><br><span class="line">  public dep?: <span class="title class_">Dep</span> = <span class="literal">undefined</span></span><br><span class="line">  public readonly __v_isRef = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value: T, public readonly _shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_rawValue</span> = _shallow ? value : <span class="title function_">toRaw</span>(value)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = _shallow ? value : <span class="title function_">convert</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">    newVal = <span class="variable language_">this</span>.<span class="property">_shallow</span> ? newVal : <span class="title function_">toRaw</span>(newVal)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newVal, <span class="variable language_">this</span>.<span class="property">_rawValue</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newVal</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="variable language_">this</span>.<span class="property">_shallow</span> ? newVal : <span class="title function_">convert</span>(newVal)</span><br><span class="line">      <span class="title function_">triggerRefValue</span>(<span class="variable language_">this</span>, newVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面的函数调用流程可以看出，实现<code>ref</code>的核心就是实例化了一个<code>RefImpl</code>对象。为什么这里要实例化一个<code>RefImpl</code>对象呢，其目的在于 <code>Proxy</code> 代理的目标也是对象类型，无法通过为基本数据类型创建<code>proxy</code>的方式来进行数据代理。只能把基本数据类型包装为一个对象，通过自定义的 <code>get、set</code> 方法进行 <strong>依赖收集</strong> 和 <strong>依赖更新</strong></li>
<li>来看<code>RefImpl</code>对象属性的含义：<ul>
<li><strong>_ value</strong>：用于<code>保存ref当前值</code>，如果传递的参数是<strong>对象</strong>，它就是用于保存经过<strong>reactive函数转化后的值</strong>，否则<code>_value</code>与<code>_rawValue</code>相同</li>
<li><strong>_ rawValue</strong>：用于保存当前ref值对应的<strong>原始值</strong>，如果传递的参数是<strong>对象</strong>，它就是用于保存转化前的原始值，否则<code>_value</code>与<code>_rawValue</code>相同。这里<code>toRaw()</code>函数的作用就是将<strong>的响应式对象转为普通对象</strong></li>
<li><strong>dep</strong>：是一个<code>Set</code>类型的数据，用来存储当前的<code>ref</code>值收集的依赖。至于这里为什么用<code>Set</code>上面我们有阐述，这里也是同样的道理</li>
<li><strong>_v_isRef</strong> ：标记位，只要被<code>ref</code>定义了，都会标识当前数据为一个<code>Ref</code>，也就是它的值标记为<code>true</code></li>
<li>另外可以很清楚的看到<code>RefImpl类</code>暴露给实例对象的<code>get、set</code>方法是<strong>value</strong>，所以对于<code>ref</code>定义的响应式数据的操作我们都要带上**.value**</li>
</ul>
</li>
<li>如果传入的值是<strong>对象</strong>类型，会调用<code>convert()</code>方法，这个方法里面会调用<code>reactive()</code>方法对其进行响应式处理</li>
<li><code>RefImpl</code>实例关键就在于<code>trackRefValue(this)</code>和<code>triggerRefValue(this, newVal)</code>的两个函数的处理，我们大概也知道它们就是<strong>依赖收集</strong>、<strong>依赖更新</strong>,原理基本与<code>reactive</code>处理方式类似，这里就不在阐述了</li>
</ul>
<h3 id="五-总结"><a href="#五-总结" class="headerlink" title="五. 总结"></a>五. 总结</h3><ul>
<li>对于<strong>基础数据类型</strong>只能通过<code>ref</code>来实现其响应式，核心还是将其包装成一个<code>RefImpl</code>对象，并在内部通过自定义的<code> get value()</code> 与 <code>set value(newVal)</code>实现依赖收集与依赖更新。</li>
<li>对于<strong>对象类型</strong>，<code>ref</code>与<code>reactive</code>都可以将其转化为<strong>响应式数据</strong>，但其在<code>ref</code>内部，最终还是会调用<code>reactive</code>函数实现转化。<code>reactive</code>函数，主要通过<code>创建了Proxy实例对象</code>，通过<code>Reflect</code>实现数据的获取与修改。</li>
</ul>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vue">https://github.com/vuejs/vue</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.javascript.info/proxy#reflect">https://zh.javascript.info/proxy#reflect</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2023/05/26/%E6%B5%85%E8%B0%88Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" data-id="cllnfb8pc000h3fexee061ut1" data-title="浅谈Vue3响应式原理与源码解读" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-setState与useState使用注意项" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/04/01/setState%E4%B8%8EuseState%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E9%A1%B9/" class="article-date">
  <time class="dt-published" datetime="2023-04-01T12:46:25.000Z" itemprop="datePublished">2023-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/04/01/setState%E4%B8%8EuseState%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E9%A1%B9/">setState与useState使用注意项</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>我们知道<code>React</code>支持两种形式来创建组件，一种是 class 组件，一种是函数组件。在 React16.8 推出之前，如果要为组件添加状态，那么只能使用 class 组件来实现，并通过 <code>setState</code> 来修改状态值，达到更新组件的目的。在 React16.8 推出 Hook 后，可以利用 <code>useState</code> 来为函数组件添加状态，这让我们的状态管理更加容易。</p>
<p>前端开发的核心在于状态管理，在实际项目开发中，特别是对新手<code>React</code>开发人员而言，对<code>setState</code>和<code>useState</code> Hook 的使用上仍有一些容易犯的错误和注意事项，在本文中，我们将探讨如何避免这些问题。</p>
<h3 id="二-Class-组件中的-setState-的使用"><a href="#二-Class-组件中的-setState-的使用" class="headerlink" title="二. Class 组件中的 setState 的使用"></a>二. Class 组件中的 setState 的使用</h3><p>在 class 组件中添加一个构造函数<code>constructor</code>，然后在该函数中为 <code>this.state</code>赋初值添加状态.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">otherCount</span>: <span class="number">100</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">addCount</span> = <span class="variable language_">this</span>.<span class="property">addCount</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">addCount</span>(<span class="params">params</span>) &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">count</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                class组件</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    count: &#123;this.state.count&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    otherCount: &#123;this.state.otherCount&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.addCount&#125;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ClassComponent</span>;</span><br></pre></td></tr></table></figure>
<p>​                                                                <img src="http://p0.qhimg.com/t0108deb0bea2ef8e61.gif" alt="pic01"></p>
<p>通过<code>this.setState(&#123;count:this.state.count + 1&#125;)</code>改变 state 里面 count 的值。这样操作是可以达到预期效果，但是再次添加一行同样的代码看会发生什么</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addCount</span>(<span class="params">params</span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">count</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span>&#125;)</span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">count</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                 <img src="http://p0.qhimg.com/t0108deb0bea2ef8e61.gif" alt="pic01"></p>
<p><code>count </code>的值并没有像我们预想的那样每次点击<code>+2</code>。是什么原因导致的呢？<br><strong>State 的更新可能是异步的</strong>，出于性能考虑，<code>React</code> 可能会把多个<code>setState()</code>调用合并成一个调用，要解决这个问题，可以让 <code>setState()</code> 接收一个函数而不是一个对象。再来重新认识一下<code>setState</code></p>
<h4 id="setState"><a href="#setState" class="headerlink" title="setState()"></a><code>setState()</code></h4><h5 id="1-setState-stateChange-callback"><a href="#1-setState-stateChange-callback" class="headerlink" title="1. setState(stateChange,[callback])"></a>1. <code>setState(stateChange,[callback])</code></h5><p>第一个参数是你要改变的 state 对象，第二个是可选的回调函数。这种形式的<code>setState()</code>是异步的，并且在同一周期内会对多个 <code>setState</code>进行批处理。后调用的 <code>setState()</code> 将覆盖同一周期内先调用 <code>setState</code> 的值，因此<code>count</code>数仅增加一次。如果要解决这个问题，我们需要为<code>setState</code>传入一个函数.</p>
<h5 id="2-setState-updater-callback"><a href="#2-setState-updater-callback" class="headerlink" title="2. setState(updater,[callback])"></a>2. <code>setState(updater,[callback])</code></h5><p>第一个参数是带有形参的<code>updater</code>函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(state, props) =&gt; stateChange</span><br></pre></td></tr></table></figure>
<p><code>state</code>对应变化时组件状态的引用，也就是最新的<code>state</code>，此次更新被应用时的<code>props</code>是第二个参数(可选)。因此可以使用这种方式来解决我们上面遇到的问题.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addCount</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span></span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span></span><br><span class="line">    &#125;))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://p0.qhimg.com/t0117ba326de299d3c1.gif" alt="pic02"></p>
<p><code>[callback]</code>是<code>setState()</code>的第二个参数，为可选的回调函数,它将在<code>setState</code>完成合并并重新渲染组件后执行。因此我们也可以在这个回调函数中获取到最新的<code>state</code>值.</p>
<h4 id="对State赋值"><a href="#对State赋值" class="headerlink" title="对State赋值"></a>对State赋值</h4><p><code>State</code>里面的状态数据可能是值类型或是引用类型，对于基本数据类型<strong>（String(字符串)，Number(数值)，Boolean(布尔值)，Undefined，Null）</strong>可以直接对其赋值。对于引用类型的数据<strong>（Array，Object）</strong>赋值时要特别注意：<strong>不要直接修改原始引用类型的值</strong>。例如：为数组增加一项</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误，不要直接修改this.state的值</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">listData</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">listData</span>.<span class="title function_">push</span>(<span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 错误</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">preSate</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">listData</span>: preSate.<span class="property">listData</span>.<span class="title function_">push</span>(<span class="number">100</span>)</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>正确的做法是使用<code>concat</code>或是ES6的扩展语法：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正确</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">preSate</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">listData</span>: preSate.<span class="property">listData</span>.<span class="title function_">concat</span>(<span class="number">100</span>)</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// 正确</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">preSate</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">listData</span>: [...preSate.<span class="property">listData</span>,<span class="number">100</span>]</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：在修改<strong>数组类型</strong>的状态时不要使用<code>push</code>、<code>pop</code>、<code>shift</code>、<code>unshift</code>等方法,因为这些方法都是在原数组的基础上修改,取而代之的是使用<code>concat</code>、<code>slice</code>、<code>splice</code>、<code>filter</code>或是ES6的扩展语法，返回一个新的数组。</p>
</blockquote>
<p>对于<strong>对象类型</strong>的状态而言可以这样赋值：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用ES6 的Object.assgin方法</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">preState</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">mapData</span>: <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,preState.<span class="property">mapData</span>,&#123;<span class="attr">name</span>:<span class="string">&#x27;React&#x27;</span>&#125;)</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// 使用对象扩展语法</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">preState</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">mapData</span>: &#123;...preState.<span class="property">mapData</span>,<span class="attr">name</span>:<span class="string">&#x27;React&#x27;</span>&#125;</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<h3 id="三-函数组件中的useState"><a href="#三-函数组件中的useState" class="headerlink" title="三. 函数组件中的useState"></a>三. 函数组件中的useState</h3><p><strong>Hook</strong> 是 React 16.8 的新增特性，它可以让你在不编写 <code>class</code> 组件的情况下使用 state 以及其他的 React 特性。<code>useState</code> 是允许你在 React 函数组件中添加 state 的 <code>Hook</code>.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; memo, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">HookComponent</span> = (<span class="params"></span>) =&gt; &#123;    </span><br><span class="line">    <span class="keyword">const</span> [data,setData] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">        <span class="attr">count</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">otherCount</span>: <span class="number">100</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">addCount</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// wrong</span></span><br><span class="line">        <span class="comment">// setState(&#123;count:state.count+1&#125;)</span></span><br><span class="line">        <span class="comment">// correct</span></span><br><span class="line">         <span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,&#123;...data,<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;))</span><br><span class="line">         <span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,&#123;...data,<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;))</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data.count=====&#x27;</span>,data.<span class="property">count</span>); <span class="comment">// 0</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                函数组件</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    count: &#123;data.count&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    otherCount: &#123;data.otherCount&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;addCount&#125;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">memo</span>(<span class="title class_">HookComponent</span>);</span><br></pre></td></tr></table></figure>

<h4 id="更新state"><a href="#更新state" class="headerlink" title="更新state"></a>更新state</h4><p><code>useState</code>的唯一参数是初始 state，返回值为：当前 state 以及更新 state 的函数。如果我们也像在 class 组件中使用对象对其进行赋值，并调用更新 state 函数，那么一定要注意：<strong>class 组件中的 <code>this.setState</code>是合并state，而函数组件中更新 state 的函数是替换当前的 state</strong>。例如要对<code>count</code>执行 <code>+1</code> 操作，以下写法是错误的：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line"><span class="title function_">setData</span>(&#123;<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="http://p0.qhimg.com/t01b5cf4464f59df53d.gif" alt="pic04"></p>
<p><code>otherCount</code> 的值变为了 undefined.</p>
<p>正确写法：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,&#123;...data,<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;))</span><br></pre></td></tr></table></figure>

<p>上面的写法这和预期的一样。但是，<strong>直接更新状态是一种不好的做法</strong>, 同样如果连续调用两次，<code>count</code>的值并没有像预期的那样改变.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,&#123;...data,<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;))</span><br><span class="line"><span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,&#123;...data,<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;))</span><br></pre></td></tr></table></figure>

<p><img src="http://p0.qhimg.com/t01e7078390fa6b8a6f.gif" alt="pic05"></p>
<p>与 class 组件状态更新原理不同，这里<code>setData()</code>是替换当前的 state,只执行最后一次<code>+1</code>的操作。如果要解决这个问题需要传递给 <code>setState()</code> 一个回调函数，在这个回调函数中我们获取该实例的当前状态，例如 <code>setState(currentState =&gt; currentState + newValue)</code>。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setData</span>(<span class="function"><span class="params">data</span> =&gt;</span> (&#123;</span><br><span class="line">    ...data,</span><br><span class="line">    <span class="attr">count</span>:data.<span class="property">count</span> + <span class="number">1</span></span><br><span class="line">&#125;))</span><br><span class="line"><span class="title function_">setData</span>(<span class="function"><span class="params">data</span> =&gt;</span> (&#123;</span><br><span class="line">    ...data,</span><br><span class="line">    <span class="attr">count</span>:data.<span class="property">count</span> + <span class="number">1</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p><img src="http://p0.qhimg.com/t01c8e55684f9b6edfd.gif" alt="pic06"></p>
<h4 id="获取State的最新值"><a href="#获取State的最新值" class="headerlink" title="获取State的最新值"></a>获取State的最新值</h4><p>我们知道<strong>State 的更新可能是异步的</strong>，但有时候的业务场景需要我们同步拿到变量的最新变化值，以便做下一步操作，可以用一下几种方式获取：</p>
<h5 id="1-回调函数内获取"><a href="#1-回调函数内获取" class="headerlink" title="1. 回调函数内获取"></a>1. 回调函数内获取</h5><p>在setXXX中使用回调函数更新</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setData</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> count = data.<span class="property">count</span> + <span class="number">1</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;count====&gt;&gt;&gt;&#x27;</span>,count); <span class="comment">// 获取最新值,执行后续逻辑</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...data,</span><br><span class="line">        <span class="attr">count</span>:count</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="2-直接使用useEffect-获取"><a href="#2-直接使用useEffect-获取" class="headerlink" title="2. 直接使用useEffect 获取"></a>2. 直接使用<code>useEffect</code> 获取</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">... </span><br><span class="line"><span class="keyword">const</span> <span class="title function_">addCount</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,&#123;...data,<span class="attr">count</span>:data.<span class="property">count</span>+<span class="number">1</span>&#125;))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用 useEffect 解决数据同步问题</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 获取最新值，执行后续逻辑</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;count====&#x27;</span>,data.<span class="property">count</span>);</span><br><span class="line">&#125;, [data]);</span><br></pre></td></tr></table></figure>

<h5 id="3-使用Promise实现"><a href="#3-使用Promise实现" class="headerlink" title="3.使用Promise实现"></a>3.使用Promise实现</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newData = &#123;</span><br><span class="line">        ...data,</span><br><span class="line">        <span class="attr">count</span>:data.<span class="property">count</span> + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="title function_">setData</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,newData))</span><br><span class="line">   <span class="title function_">resolve</span>(newData)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data====&#x27;</span>,data); <span class="comment">// 获取到最新值，进行后续逻辑处理</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="四-小结"><a href="#四-小结" class="headerlink" title="四. 小结"></a>四. 小结</h3><p>需要注意的是，在 React18 之前，在非 React 调度流程如<code>setTimeout</code> <code>setInterval</code> ，直接在 <code>DOM</code> 上绑定原生事件等，<code>setState</code> 是同步的，除了这些，<code>setState</code>都是异步执行。从<code>react18</code>开始, 使用了<code>createRoot</code>创建应用后, 所有的更新都会自动进行批处理，也就是异步合并。后续文章中我们在探讨 React 的自动批处理流程，本文不再涉及。</p>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/hooks-reference.html#usecontext">React</a></p>
<p><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/state-and-lifecycle.html">State 和生命周期指南</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48563650/does-react-keep-the-order-for-state-updates/48610973#48610973">深入学习：何时以及为什么 setState() 会批量执行？</a><br><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/react-component.html#setstate">深入：为什么不直接更新 this.state？</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2023/04/01/setState%E4%B8%8EuseState%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E9%A1%B9/" data-id="cllnfb8p7000a3fex2eua1tol" data-title="setState与useState使用注意项" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-使用useReducer + useContext 代替 react-redux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/06/%E4%BD%BF%E7%94%A8useReducer%20+%20useContext%20%E4%BB%A3%E6%9B%BF%20react-redux/" class="article-date">
  <time class="dt-published" datetime="2023-02-06T12:46:25.000Z" itemprop="datePublished">2023-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/02/06/%E4%BD%BF%E7%94%A8useReducer%20+%20useContext%20%E4%BB%A3%E6%9B%BF%20react-redux/">使用useReducer + useContext 代替 react-redux</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>在 React16.8推出之前，我们使用<code>react-redux</code>并配合一些中间件，来对一些大型项目进行状态管理，React16.8推出后，我们普遍使用函数组件来构建我们的项目，React提供了两种Hook来为函数组件提供状态支持，一种是我们常用的<code>useState</code>,另一种就是<code>useReducer</code>, 其实从代码底层来看<code>useState</code>实际上执行的也是一个<code>useReducer</code>,这意味着<code>useReducer</code>是更原生的，你能在任何使用<code>useState</code>的地方都替换成使用<code>useReducer</code>.</p>
<p><code>Reducer</code>的概念是伴随着<code>Redux</code>的出现逐渐在JavaScript中流行起来的,<code>useReducer</code>从字面上理解这个是<code>reducer</code>的一个Hook，那么能否使用<code>useReducer</code>配合<code>useContext</code> 来代替<code>react-redux</code>来对我们的项目进行状态管理呢？答案是肯定的。</p>
<h3 id="二-useReducer-与-useContext"><a href="#二-useReducer-与-useContext" class="headerlink" title="二. useReducer 与 useContext"></a>二. useReducer 与 useContext</h3><h4 id="1-useReducer"><a href="#1-useReducer" class="headerlink" title="1. useReducer"></a>1. useReducer</h4><p>在介绍<code>useReducer</code>这个Hook之前，我们先来回顾一下<code>Reducer</code>，简单来说 <code>Reducer</code>是一个函数<code>(state, action) =&gt; newState</code>：它接收两个参数，分别是当前应用的<code>state</code>和触发的动作<code>action</code>，它经过计算后返回一个新的<code>state</code>.来看一个<code>todoList</code>的例子:</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ITodo</span> &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="attr">content</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">complete</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">IStore</span> &#123;</span><br><span class="line">    <span class="attr">todoList</span>: <span class="title class_">ITodo</span>[],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">IAction</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">payload</span>: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> <span class="variable constant_">ACTION_TYPE</span> &#123;</span><br><span class="line">    <span class="variable constant_">ADD_TODO</span> = <span class="string">&#x27;addTodo&#x27;</span>,</span><br><span class="line">    <span class="variable constant_">REMOVE_TODO</span> = <span class="string">&#x27;removeTodo&#x27;</span>,</span><br><span class="line">    <span class="variable constant_">UPDATE_TODO</span> = <span class="string">&#x27;updateTodo&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">ACTION_TYPE</span>, <span class="title class_">IAction</span>, <span class="title class_">IStore</span>, <span class="title class_">ITodo</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./type&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoReducer = (<span class="attr">state</span>: <span class="title class_">IStore</span>, <span class="attr">action</span>: <span class="title class_">IAction</span>): <span class="function"><span class="params">IStore</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="keyword">type</span>, payload &#125; = action</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">ADD_TODO</span>: <span class="comment">//增加</span></span><br><span class="line">            <span class="keyword">if</span> (payload.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> isExit = state.<span class="property">todoList</span>.<span class="title function_">find</span>(<span class="function"><span class="params">todo</span> =&gt;</span> todo.<span class="property">content</span> === payload)</span><br><span class="line">                <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                    <span class="title function_">alert</span>(<span class="string">&#x27;存在这个了值了&#x27;</span>)</span><br><span class="line">                    <span class="keyword">return</span> state</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> item = &#123;</span><br><span class="line">                    <span class="attr">id</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>(),</span><br><span class="line">                    <span class="attr">complete</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">content</span>: payload</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...state,</span><br><span class="line">                    <span class="attr">todoList</span>: [...state.<span class="property">todoList</span>, item <span class="keyword">as</span> <span class="title class_">ITodo</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">REMOVE_TODO</span>:  <span class="comment">// 删除 </span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">todoList</span>: state.<span class="property">todoList</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">todo</span> =&gt;</span> todo.<span class="property">id</span> !== payload)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">UPDATE_TODO</span>: <span class="comment">// 更新</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">todoList</span>: state.<span class="property">todoList</span>.<span class="title function_">map</span>(<span class="function"><span class="params">todo</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> todo.<span class="property">id</span> === payload ? &#123;</span><br><span class="line">                        ...todo,</span><br><span class="line">                        <span class="attr">complete</span>: !todo.<span class="property">complete</span></span><br><span class="line">                    &#125; : &#123;</span><br><span class="line">                        ...todo</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> todoReducer</span><br></pre></td></tr></table></figure>
<p>上面是个todoList的例子，其中<code>reducer</code>可以根据传入的<code>action</code>类型<code>（ACTION_TYPE.ADD_TODO、ACTION_TYPE.REMOVE_TODO、UPDATE_TODO）</code>来计算并返回一个新的state。<code>reducer</code>本质是一个纯函数，没有任何UI和副作用。接下来看下<code>useReducer</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const [state, dispatch] = useReducer(reducer, initState);</span><br></pre></td></tr></table></figure>
<p><code>useReducer</code> 接受两个参数：第一个是上面我们介绍的<code>reducer</code>，第二个参数是初始化的<code>state</code>，返回的是个数组，数组第一项是当前最新的state，第二项是<code>dispatch函数</code>,它主要是用来dispatch不同的<code>Action</code>，从而触发<code>reducer</code>计算得到对应的<code>state</code>.</p>
<p>利用上面创建的<code>reducer</code>,看下如何使用<code>useReducer</code>这个Hook：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">initState</span>: <span class="title class_">IStore</span> = &#123;</span><br><span class="line">  <span class="attr">todoList</span>: [],</span><br><span class="line">  <span class="attr">themeColor</span>: <span class="string">&#x27;black&#x27;</span>,</span><br><span class="line">  <span class="attr">themeFontSize</span>: <span class="number">16</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ReducerExamplePage</span>: <span class="title class_">React</span>.<span class="property">FC</span> = (): <span class="function"><span class="params">ReactElement</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = <span class="title function_">useReducer</span>(todoReducer, initState)</span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef&lt;<span class="title class_">HTMLInputElement</span>&gt;(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">addTodo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> val = inputRef.<span class="property">current</span>!.<span class="property">value</span>.<span class="title function_">trim</span>()</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">ADD_TODO</span>, <span class="attr">payload</span>: val &#125;)</span><br><span class="line">    inputRef.<span class="property">current</span>!.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> removeTodo = <span class="title function_">useCallback</span>(<span class="function">(<span class="params">id: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">REMOVE_TODO</span>, <span class="attr">payload</span>: id &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> updateTodo = <span class="title function_">useCallback</span>(<span class="function">(<span class="params">id: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">UPDATE_TODO</span>, <span class="attr">payload</span>: id &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;example&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color:</span> <span class="attr">state.themeColor</span>, <span class="attr">fontSize:</span> <span class="attr">state.themeFontSize</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      ReducerExamplePage</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;addTodo&#125;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;example-list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;</span></span><br><span class="line"><span class="language-xml">            state.todoList &amp;&amp; state.todoList.map((todo: ITodo) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">              return (</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ListItem</span> <span class="attr">key</span>=<span class="string">&#123;todo.id&#125;</span> <span class="attr">todo</span>=<span class="string">&#123;todo&#125;</span> <span class="attr">removeTodo</span>=<span class="string">&#123;removeTodo&#125;</span> <span class="attr">updateTodo</span>=<span class="string">&#123;updateTodo&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">              )</span></span><br><span class="line"><span class="language-xml">            &#125;)</span></span><br><span class="line"><span class="language-xml">          &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ReducerExamplePage</span></span><br></pre></td></tr></table></figure>
<p><code>ListItem.tsx</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">ReactElement</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ITodo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../typings&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IProps</span> &#123;</span><br><span class="line">    <span class="attr">todo</span>:<span class="title class_">ITodo</span>,</span><br><span class="line">    <span class="attr">removeTodo</span>: <span class="function">(<span class="params">id:<span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">    <span class="attr">updateTodo</span>: <span class="function">(<span class="params">id: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span>  <span class="title class_">ListItem</span>:<span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">IProps</span>&gt; = (&#123;</span><br><span class="line">    todo,</span><br><span class="line">    updateTodo,</span><br><span class="line">    removeTodo</span><br><span class="line">&#125;) : <span class="function"><span class="params">ReactElement</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;id, content, complete&#125; = todo</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">            &#123;/* 不能使用onClick,会被认为是只读的 */&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">checked</span>=<span class="string">&#123;complete&#125;</span> <span class="attr">onChange</span> = <span class="string">&#123;()</span> =&gt;</span> updateTodo(id)&#125;&gt;<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;&#123;textDecoration:complete?</span>&#x27;<span class="attr">line-through</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">none</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;content&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>removeTodo(id)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">                删除</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ListItem</span>;</span><br></pre></td></tr></table></figure>

<p><code>useReducer</code>利用上面创建的<code>todoReducer</code>与初始状态<code>initState</code>完成了初始化。用户触发<code>增加、删除、更新</code>操作后，通过<code>dispatch</code>派发不类型的<code>Action</code>，<code>reducer</code>根据接收到的不同<code>Action</code>，调用各自逻辑，完成对state的处理后返回新的state。</p>
<p>可以看到<code>useReducer</code>的使用逻辑，几乎跟<code>react-redux</code>的使用方式相同，只不过<code>react-redux</code>中需要我们利用<code>actionCreator</code>来进行action的创建，以便利用<code>Redux</code>中间键(如<code>redux-thunk</code>)来处理一些异步调用。</p>
<p>那是不是可以使用<code>useReducer</code>来代替<code>react-redux</code>了呢？我们知道<code>react-redux</code>可以利用<code>connect</code>函数，并且使用<code>Provider</code>来对<code>&lt;App /&gt;</code>进行了包裹，可以使任意组件访问store的状态。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果想要<code>useReducer</code>到达类似效果，我们需要用到<code>useContext</code>这个Hook。</p>
<h4 id="2-useContext"><a href="#2-useContext" class="headerlink" title="2. useContext"></a>2. useContext</h4><p><code>useContext</code>顾名思义，它是以Hook的方式使用<code>React Context</code>。先简单介绍 <code>Context</code>。<br><code>Context</code>设计目的是为了共享那些对于一个组件树而言是<strong>“全局”</strong>的数据,它提供了一种在组件之间共享值的方式，而不用显式地通过组件树逐层的传递<code>props</code>。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="title function_">useContext</span>(<span class="title class_">MyContext</span>);</span><br></pre></td></tr></table></figure>
<p><code>useContext</code>:接收一个<code>context</code>对象（<code>React.createContext</code> 的返回值）并返回该<code>context</code>的当前值,当前的 <code>context</code>值由上层组件中距离当前组件最近的<code>&lt;MyContext.Provider&gt;</code>的 <code>value prop</code> 决定。来看官方给的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">const themes = &#123;</span><br><span class="line">  light: &#123;</span><br><span class="line">    foreground: &quot;#000000&quot;,</span><br><span class="line">    background: &quot;#eeeeee&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  dark: &#123;</span><br><span class="line">    foreground: &quot;#ffffff&quot;,</span><br><span class="line">    background: &quot;#222222&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const ThemeContext = React.createContext(themes.light);</span><br><span class="line"></span><br><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;ThemeContext.Provider value=&#123;themes.dark&#125;&gt;</span><br><span class="line">      &lt;Toolbar /&gt;</span><br><span class="line">    &lt;/ThemeContext.Provider&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Toolbar(props) &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;ThemedButton /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function ThemedButton() &#123;</span><br><span class="line">  const theme = useContext(ThemeContext);</span><br><span class="line">  return (</span><br><span class="line">    &lt;button style=&#123;&#123; background: theme.background, color: theme.foreground &#125;&#125;&gt;</span><br><span class="line">      I am styled by theme context!</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子，首先利用<code>React.createContext</code>创建了<code>context</code>,然后用<code>ThemeContext.Provider</code>标签包裹需要进行状态共享的组件树，在子组件中使用<code>useContext</code>获取到<code>value</code>值进行使用。</p>
<p>利用<code>useReducer</code>、<code>useContext</code>这两个Hook就可以实现对<code>react-redux</code>的替换了。</p>
<h3 id="三-代替方案"><a href="#三-代替方案" class="headerlink" title="三. 代替方案"></a>三. 代替方案</h3><p>通过一个例子看下如何利用<code>useReducer</code>+<code>useContext</code>代替<code>react-redux</code>,实现下面的效果:<br><img src="http://p0.qhimg.com/t018207650f3c2b7be1.gif" alt="pic"></p>
<h5 id="react-redux实现"><a href="#react-redux实现" class="headerlink" title="react-redux实现"></a><code>react-redux</code>实现</h5><p>这里假设你已经熟悉了<code>react-redux</code>的使用，如果对它不了解可以去 <a target="_blank" rel="noopener" href="https://react-redux.js.org/">查看</a>.使用它来实现上面的需求：</p>
<ul>
<li><p>首先项目中导入我们所需类库后，创建<code>Store</code></p>
<p><code>Store/index.tsx</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore,compose,applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;<span class="comment">// 配置 redux-thunk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> composeEnhancers = compose;</span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer,<span class="title function_">composeEnhancers</span>(</span><br><span class="line">    <span class="title function_">applyMiddleware</span>(thunk)<span class="comment">// 配置 redux-thunk</span></span><br><span class="line">));</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">RootState</span> = <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> store.<span class="property">getState</span>&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>reducer</code>与<code>actionCreator</code></p>
<p><code>reducer.tsx</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">ACTION_TYPE</span>, <span class="title class_">IAction</span>, <span class="title class_">IStore</span>, <span class="title class_">ITodo</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../ReducerExample/type&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaultState</span>:<span class="title class_">IStore</span> = &#123;</span><br><span class="line">    <span class="attr">todoList</span>:[],</span><br><span class="line">    <span class="attr">themeColor</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">themeFontSize</span>: <span class="number">14</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> todoReducer = (<span class="attr">state</span>: <span class="title class_">IStore</span> = defaultState, <span class="attr">action</span>: <span class="title class_">IAction</span>): <span class="function"><span class="params">IStore</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="keyword">type</span>, payload &#125; = action</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">ADD_TODO</span>: <span class="comment">// 新增</span></span><br><span class="line">            <span class="keyword">if</span> (payload.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> isExit = state.<span class="property">todoList</span>.<span class="title function_">find</span>(<span class="function"><span class="params">todo</span> =&gt;</span> todo.<span class="property">content</span> === payload)</span><br><span class="line">                <span class="keyword">if</span> (isExit) &#123;</span><br><span class="line">                    <span class="title function_">alert</span>(<span class="string">&#x27;存在这个了值了&#x27;</span>)</span><br><span class="line">                    <span class="keyword">return</span> state</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> item = &#123;</span><br><span class="line">                    <span class="attr">id</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>(),</span><br><span class="line">                    <span class="attr">complete</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">content</span>: payload</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...state,</span><br><span class="line">                    <span class="attr">todoList</span>: [...state.<span class="property">todoList</span>, item <span class="keyword">as</span> <span class="title class_">ITodo</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">REMOVE_TODO</span>:  <span class="comment">// 删除 </span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">todoList</span>: state.<span class="property">todoList</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">todo</span> =&gt;</span> todo.<span class="property">id</span> !== payload)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">UPDATE_TODO</span>: <span class="comment">// 更新</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">todoList</span>: state.<span class="property">todoList</span>.<span class="title function_">map</span>(<span class="function"><span class="params">todo</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> todo.<span class="property">id</span> === payload ? &#123;</span><br><span class="line">                        ...todo,</span><br><span class="line">                        <span class="attr">complete</span>: !todo.<span class="property">complete</span></span><br><span class="line">                    &#125; : &#123;</span><br><span class="line">                        ...todo</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_COLOR</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">themeColor</span>: payload</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_FONT_SIZE</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">themeFontSize</span>: payload</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> todoReducer</span><br></pre></td></tr></table></figure>

<p> <code>actionCreator.tsx</code></p>
  <figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="variable constant_">ACTION_TYPE</span>, <span class="title class_">IAction</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../ReducerExample/type&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Dispatch</span> &#125; <span class="keyword">from</span> <span class="string">&quot;redux&quot;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> addCount = (<span class="attr">val</span>: <span class="built_in">string</span>):<span class="function"><span class="params">IAction</span> =&gt;</span> (&#123;</span><br><span class="line">     <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">ADD_TODO</span>,</span><br><span class="line">     <span class="attr">payload</span>:val</span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> removeCount = (<span class="attr">id</span>: <span class="built_in">number</span>):<span class="function"><span class="params">IAction</span> =&gt;</span> (&#123;</span><br><span class="line">     <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">REMOVE_TODO</span>,</span><br><span class="line">     <span class="attr">payload</span>:id</span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> upDateCount = (<span class="attr">id</span>: <span class="built_in">number</span>):<span class="function"><span class="params">IAction</span> =&gt;</span> (&#123;</span><br><span class="line">     <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">UPDATE_TODO</span>,</span><br><span class="line">     <span class="attr">payload</span>:id</span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> changeThemeColor = (<span class="attr">color</span>: <span class="built_in">string</span>):<span class="function"><span class="params">IAction</span> =&gt;</span> (&#123;</span><br><span class="line">     <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_COLOR</span>,</span><br><span class="line">     <span class="attr">payload</span>:color</span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> changeThemeFontSize = (<span class="attr">fontSize</span>: <span class="built_in">number</span>):<span class="function"><span class="params">IAction</span> =&gt;</span> (&#123;</span><br><span class="line">     <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_FONT_SIZE</span>,</span><br><span class="line">     <span class="attr">payload</span>:fontSize</span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">asyncAddCount</span> = (<span class="params">val: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;val======&#x27;</span>,val);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="function">(<span class="params">dispatch:Dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">             <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                 <span class="title function_">dispatch</span>(<span class="title function_">addCount</span>(val))</span><br><span class="line">              &#125;, <span class="number">2000</span>);  </span><br><span class="line">         &#125;)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p> 最后我们在组件中通过<code>useSelector,useDispatch</code>这两个Hook来分别获取<code>state</code>以及派发<code>action</code>：</p>
  <figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> todoList = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state: RootState</span>) =&gt;</span> state.<span class="property">newTodo</span>.<span class="property">todoList</span>)</span><br><span class="line"><span class="keyword">const</span> dispatch = <span class="title function_">useDispatch</span>()</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h5 id="useReducer-useContext-实现"><a href="#useReducer-useContext-实现" class="headerlink" title="useReducer + useContext 实现"></a><code>useReducer</code> + <code>useContext</code> 实现</h5><p>为了实现修改颜色与字号的需求，在最开始的<code>useReducer</code>我们再添加两种<code>action</code>类型，完成后的<code>reducer</code>:</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> todoReducer = (<span class="attr">state</span>: <span class="title class_">IStore</span>, <span class="attr">action</span>: <span class="title class_">IAction</span>): <span class="function"><span class="params">IStore</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="keyword">type</span>, payload &#125; = action</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_COLOR</span>: <span class="comment">// 修改颜色</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">themeColor</span>: payload</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_FONT_SIZE</span>: <span class="comment">// 修改字号</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">themeFontSize</span>: payload</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> todoReducer</span><br></pre></td></tr></table></figure>
<p>在父组件中创建<code>Context</code>,并将需要与子组件共享的数据传递给<code>Context.Provider</code>的<code>Value prop</code> </p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">initState</span>: <span class="title class_">IStore</span> = &#123;</span><br><span class="line">  <span class="attr">todoList</span>: [],</span><br><span class="line">  <span class="attr">themeColor</span>: <span class="string">&#x27;black&#x27;</span>,</span><br><span class="line">  <span class="attr">themeFontSize</span>: <span class="number">14</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建 context</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(initState);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ReducerExamplePage</span>: <span class="title class_">React</span>.<span class="property">FC</span> = (): <span class="function"><span class="params">ReactElement</span> =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">changeColor</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_COLOR</span>, <span class="attr">payload</span>: <span class="title function_">getColor</span>() &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">changeFontSize</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="variable constant_">ACTION_TYPE</span>.<span class="property">CHANGE_FONT_SIZE</span>, <span class="attr">payload</span>: <span class="number">20</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getColor = (): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> x = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">255</span>);</span><br><span class="line">    <span class="keyword">const</span> y = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">255</span>);</span><br><span class="line">    <span class="keyword">const</span> z = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">255</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;rgb(&#x27;</span> + x + <span class="string">&#x27;,&#x27;</span> + y + <span class="string">&#x27;,&#x27;</span> + z + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// 传递state值</span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;state&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;example&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ReducerExamplePage</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;addTodo&#125;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;example-list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;</span></span><br><span class="line"><span class="language-xml">              state.todoList &amp;&amp; state.todoList.map((todo: ITodo) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">                return (</span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">ListItem</span> <span class="attr">key</span>=<span class="string">&#123;todo.id&#125;</span> <span class="attr">todo</span>=<span class="string">&#123;todo&#125;</span> <span class="attr">removeTodo</span>=<span class="string">&#123;removeTodo&#125;</span> <span class="attr">updateTodo</span>=<span class="string">&#123;updateTodo&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                )</span></span><br><span class="line"><span class="language-xml">              &#125;)</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;changeColor&#125;</span>&gt;</span>改变颜色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;changeFontSize&#125;</span>&gt;</span>改变字号<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">memo</span>(<span class="title class_">ReducerExamplePage</span>)</span><br></pre></td></tr></table></figure>
<p>然后在<code>ListItem</code>中使用<code>const theme = useContext(ThemeContext);</code> 获取传递的颜色与字号，并进行样式绑定</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入创建的context</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ThemeContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../ReducerExample/index&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 获取传递的数据</span></span><br><span class="line"><span class="keyword">const</span> theme = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">checked</span>=<span class="string">&#123;complete&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;()</span> =&gt;</span> updateTodo(id)&#125; style=&#123;&#123; color: theme.themeColor, fontSize: theme.themeFontSize &#125;&#125;&gt;<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">textDecoration:</span> <span class="attr">complete</span> ? &#x27;<span class="attr">line-through</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">none</span>&#x27;, <span class="attr">color:</span> <span class="attr">theme.themeColor</span>, <span class="attr">fontSize:</span> <span class="attr">theme.themeFontSize</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;content&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> removeTodo(id)&#125; style=&#123;&#123; color: theme.themeColor, fontSize: theme.themeFontSize &#125;&#125;&gt;</span></span><br><span class="line"><span class="language-xml">            删除</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>可以看到在<code>useReducer</code>结合<code>useContext</code>，通过<code>Context</code>把<code>state</code>数据给组件树中的所有组件使用 ，而不用通过<code>props</code>添加回调函数的方式一层层传递,达到了数据共享的目的。</p>
<h3 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h3><p>总体来说，相比<code>react-redux</code>而言，使用<code>useReducer</code> + <code>userContext</code> 进行状态管理更加简单，免去了导入各种状态管理库以及中间键的麻烦，也不需要再创建<code>store</code>和<code>actionCreator</code>，对于新手来说，减轻了状态管理的难度。对于一些小型项目完全可以用它来代替<code>react-redux</code>，当然一些大型项目普遍还是使用<code>react-redux</code>来进行的状态管理，所以深入学习<code>Redux</code> 也是很有必要的。</p>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/hooks-reference.html#usecontext">React</a></p>
<p><a target="_blank" rel="noopener" href="https://react-redux.js.org/">React Redux</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7026645463277404191#heading-3">用useState还是用useReducer</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2023/02/06/%E4%BD%BF%E7%94%A8useReducer%20+%20useContext%20%E4%BB%A3%E6%9B%BF%20react-redux/" data-id="cllnfb8pa000e3fex8r6b6efi" data-title="使用useReducer + useContext 代替 react-redux" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-GitHub Actions 自动部署前端 Vue 项目" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/11/15/GitHub%20Actions%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%20Vue%20%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2022-11-15T12:46:25.000Z" itemprop="datePublished">2022-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/11/15/GitHub%20Actions%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%20Vue%20%E9%A1%B9%E7%9B%AE/">GitHub Actions 自动部署前端 Vue 项目</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>作为前端技术人员，如果要部署一个项目大体要经过：<code>代码开发</code>、<code>代码推送</code>、<code>打包dist文件</code>、<code>scp到服务器</code>、<code>服务器nginx配置</code>、<code>完成部署</code>这几个流程，现实中我们希望项目部署尽可能自动且简单，因此诞生了各种<code>CI/CD</code>工具，比如：<code>Jenkins</code>、<code>gitlab ci</code>、<code>gitlab runner</code>等，其实我们最熟悉的 <code>GitHub</code> 也提供了<code>CI/CD</code> 的能力：<code>GitHub Actions</code>,它于2019年11月正式发布，现已经支持多种的语言和框架：<strong>Node.js, Python, Java, PHP, Ruby, Go, Rust, C&#x2F;C++, .NET, Android, iOS</strong>.当然在利用<code>GitHub Actions</code>自动部署项目之前，先要利用<code>GitHub Pages</code>来发布我们的前端项目。</p>
<h3 id="二-GitHub-Pages"><a href="#二-GitHub-Pages" class="headerlink" title="二. GitHub Pages"></a>二. GitHub Pages</h3><img src="https://s2.loli.net/2022/11/22/LbKqXmOwxdyYhBr.png" alt="github pages" style="zoom:35%;" />

<p>什么是 <code>GitHub Pages</code>？官网的介绍：<strong>Websites for you and your projects.Hosted directly from your GitHub repository. Just edit, push, and your changes are live.</strong> 说的很明确了，可以利用它,将我们托管在 <code>GitHub</code> 仓库的项目部署为一个可以对外访问的网站，免去了我们自己购买与配置服务器的麻烦。</p>
<ul>
<li><strong>首先创建一个项目</strong>，以Vue项目为例，利用 Vue 脚手架创建一个项目 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init vue@latest</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这里假设你已经熟悉了 Vue 项目创建，如果不熟悉Vue可以去<a target="_blank" rel="noopener" href="https://cn.vuejs.org/guide/quick-start.html#creating-a-vue-application">查看</a><br>执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> &lt;your-project-name&gt;</span><br><span class="line">&gt; npm install</span><br><span class="line">&gt; npm run dev</span><br></pre></td></tr></table></figure>
<p>运行后在浏览器中打开本地地址，得到如下页面：<br><img src="https://s2.loli.net/2022/11/22/WAoUnXbaOcl28wv.png" alt="vue" style="zoom:60%;" /></p>
<ul>
<li><p><strong>在<code>GitHub</code>上创建一个新的<code>Repository</code>,将项目上传到<code>GitHub</code>仓库</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;备注信息&quot;</span></span><br><span class="line">git remote add origin 你的远程仓库地址</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure></li>
<li><p><strong>配置 <code>GitHub Actions</code></strong><br>回到<code>GitHub</code>,点击<code>Setting</code>-&gt;<code>Pages</code>，看到如下界面</p>
<img src="https://s2.loli.net/2022/12/29/QtXCsK9SiP8AyhH.png" alt="github" style="zoom:65%;" />
<img src="https://s2.loli.net/2022/11/22/LrmfoOxtJ253BdC.png" alt="github" style="zoom:40%;" />
并没有展示网址，别急！此时还需要我们去新建一个名为**gh-pages**的分支，创建完成后再次打开`Pages`，可以看到页面发生了变化
<img src="https://s2.loli.net/2022/11/22/kracCN5MbYnR1iU.png" alt="github" style="zoom:40%;" />
> **Source**: 选择`Deploy from a branch`, **Branch**：`github pages` 默认只能识别项目根目录的 `index` 文件，我们这里选择新建的`gh-pages`的`root`根目录，意思是去这个分支的根目录加载`index.html`文件.</li>
<li><p><strong>打包应用，并发布到 <code>gh-pages</code> 分支</strong><br>打包应用，执行<code>npm run build</code> ，在项目根目录下得到打包后的产物<code>dist</code>文件夹,</p>
<img src="https://s2.loli.net/2022/11/22/On4IHZa2QyjmUEd.png" alt="截屏2022-11-18 17.53.12" style="zoom:50%;" />

<p>切换当前分支到<code>gh-pages</code>,并且将原有内容全部删除, 最后将<code>dist</code>文件夹下的内容全部拷贝到<code>gh-pages</code>上，push到远端.</p>
</li>
</ul>
<img src="https://s2.loli.net/2022/12/29/PVKfULoNtjiShkJ.png" alt="pic" style="zoom:30%;" />
再次点击`Setting`->`Pages` ,稍等一会儿，下面出现了一个网址,这就是项目线上地址
<img src="https://s2.loli.net/2022/12/29/THu82SdE5QsDArl.png" alt="pci1" style="zoom:50%;" />

<ul>
<li><strong>遇到问题</strong><br>点击查看网址，并没有像我们预期的那样展示页面，而是一片空白。打开调试版查看错误信息：<img src="https://s2.loli.net/2022/12/29/J28xGTSu7wZdktp.png" alt="pic02" style="zoom:50%;" />
如果有项目部署经验的一看就知道是怎么回事了，这是打包编译后的文件路径配置有问题，资源文件`css`、`js`，加载的路径地址不对，加载的是根路径
`https://<用户名>.github.io/assets/index.bf782a5b.js`,而我们的资源文件在`/vue-pages/`目录下，所以当然报错`404`，修复也很简单，如果你的Vue项目是基于 Vite 的构建的，需要修改`vite.config.js`，添加`base:'./'`
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>(), <span class="title function_">vueJsx</span>()],</span><br><span class="line">  <span class="attr">base</span>:<span class="string">&#x27;./&#x27;</span>,<span class="comment">// 将根路径换成相对路径</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&quot;@&quot;</span>: <span class="title function_">fileURLToPath</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;./src&quot;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>)),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
如果是基于`webpack`构建，修改`vue.config.js`添加`publicPath: './'`.
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * publicPath 默认是 / 是根路径，这个是指服务的根路径：https://xxx.github.io/，发布后会从这个路径下找 js.css 等资源，而生成的网站路径是这个 https://xxx.github.io/Vue-Element/，显然是找不到的</span></span><br><span class="line"><span class="comment">   * 我们需要修改为 相对路径&#x27;./&#x27; 或是‘.’ 或是 直接设置的项目子路径 :/项目名称/ 就可找到资源了</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">publicPath</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">  <span class="attr">outputDir</span>: <span class="string">&#x27;dist&#x27;</span>, <span class="comment">// dist</span></span><br><span class="line">  <span class="attr">assetsDir</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">  <span class="attr">lintOnSave</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  <span class="attr">productionSourceMap</span>: <span class="literal">false</span>,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
重新打包，将`dist`文件夹下内容拷贝到`gh-pages`分支下，并重新打开`pages`链接：`https://<用户名>.github.io/vue-pages/`
成功部署！</li>
</ul>
<blockquote>
<p>每一次修改后都要重新打包，切换分支拷贝dist文件夹，实属麻烦，能不能让<code>GitHub</code>自动检测<code>push</code>动作,自动进行打包部署吗？那就是<code>GitHub Actions</code>的工作了.</p>
</blockquote>
<h3 id="三-GitHub-Actions"><a href="#三-GitHub-Actions" class="headerlink" title="三. GitHub Actions"></a>三. GitHub Actions</h3><h4 id="什么是GitHub-Actions"><a href="#什么是GitHub-Actions" class="headerlink" title="什么是GitHub Actions?"></a>什么是<code>GitHub Actions</code>?</h4><p><code>GitHub Actions</code>是<code>GitHub</code>推出的一款持续集成<strong>（CI&#x2F;CD）</strong>服务，它给我们提供了虚拟的服务器资源，让我们可以基于它完成自动化测试、集成、部署等操作。这里简单介绍一下它的几个基本概念，更多内容可以去官网<a target="_blank" rel="noopener" href="https://github.com/features/actions">查看</a></p>
<h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><ul>
<li><p><code>Workflows（工作流程）</code><br>持续集成的运行过程称为一次工作流程，也就是我们项目开始自动化部署到部署结束的这一段过程可以称为工作流程.</p>
</li>
<li><p><code>job （任务）</code><br>一个工作流程中包含多个任务，简单来说就是一次自动部署的过程需要完成一个或多个任务.</p>
</li>
<li><p><code>step（步骤）</code><br>部署项目需要按照一个一个的步骤来进行，每个<code>job</code>由多个<code>step</code>构成.</p>
</li>
<li><p><code>action（动作）</code><br>每个步骤<code>step</code>可以包含一个或多个动作，比如我们在一个步骤中执行打包命令这个Action.</p>
</li>
</ul>
<h4 id="语法简介"><a href="#语法简介" class="headerlink" title="语法简介"></a>语法简介</h4><ul>
<li><p><strong>name</strong><br><code>name</code>字段是<code>workflow</code>的名称。如果省略该字段，默认为当前<code>workflow</code>的文件名.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">GitHub</span> <span class="string">CI</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>on</strong><br><code>on</code>字段指定触发<code>workflow</code>的条件，通常是某些事件,比如代码推送<code>push</code>,拉取<code>pull_request</code>,可以是事件的数组.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="string">or</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>, <span class="string">pull_request</span>]</span><br></pre></td></tr></table></figure>
<p>指定触发事件时，可以限定分支或标签:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>上面代码表示：只有<code>master</code>分支发生<code>push</code>事件时，才会触发<code>workflow</code>.</p>
</li>
<li><p><strong>jobs</strong><br><code>workflow</code>的核心就是<code>jobs</code>，任务<code>job</code>放在<code>jobs</code>这个集合下，每一个<code>job</code>都有<code>job_id</code>，用<code>job_id</code>标识一个具体任务</p>
</li>
<li><p><code>jobs.&lt;job_id&gt;.name</code><br>任务说明</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span> <span class="string">//</span> <span class="string">job_id</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">job</span> </span><br><span class="line">  <span class="string">my_second_job://</span> <span class="string">job_id</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">My</span> <span class="string">second</span> <span class="string">job</span></span><br></pre></td></tr></table></figure>
<p>上面的<code>jobs</code>字段包含两项任务，<code>job_id</code>分别是<code>my_first_job</code>和<code>my_second_job</code>。</p>
</li>
<li><p><code>jobs.&lt;job_id&gt;.runs-on</code><br><code>runs-on</code>字段指定运行所需要的虚拟机环境,它是必填字段。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">runs-on:</span> <span class="string">ubuntu-18.04</span></span><br></pre></td></tr></table></figure>
<p><code>GitHub Actions</code>给我们提提供的运行环境主要有以下几种：<br><strong>ubuntu-latest</strong>，<strong>ubuntu-18.04或ubuntu-16.04</strong><br><strong>windows-latest，windows-2019或windows-2016</strong><br><strong>macOS-latest或macOS-10.14</strong></p>
<ul>
<li><code>jobs.&lt;job_id&gt;.steps</code><br>任务步骤，一个<code>job</code>可以包含多个步骤，我们需要分为多个步骤来完成这个任务，每个步骤包含下面三个字段：</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jobs.&lt;job_id&gt;.<span class="property">steps</span>.<span class="property">name</span>：步骤名称。</span><br><span class="line">jobs.&lt;job_id&gt;.<span class="property">steps</span>.<span class="property">run</span>：该步骤运行的命令或者 action。</span><br><span class="line">jobs.&lt;job_id&gt;.<span class="property">steps</span>.<span class="property">env</span>：该步骤所需的环境变量。</span><br></pre></td></tr></table></figure>
<h4 id="使用介绍"><a href="#使用介绍" class="headerlink" title="使用介绍"></a>使用介绍</h4><ul>
<li>新建.yml文件<br>点击主页<code>Actions</code> -&gt; <code>New workflow</code> -&gt; <code>set up a workflow yourself</code>，当然你也可以选择一个模板，点击<code>start commit</code>则会自动在我们项目目录下新建<code>.github/workflows/main.yml</code>文件.<img src="https://s2.loli.net/2022/12/29/KVHnIA8UTirJXtj.png" alt="pic" style="zoom:40%;" /></li>
</ul>
<p>整个<code>workflow</code>的核心就是<code>yml</code>脚本的书写。如果你需要某个<code>action</code>，不必自己写复杂的脚本，直接引用他人写好的 <code>action</code>即可，整个持续集成过程，就变成了一个<code>actions</code>的组合，你可以在<code>GitHub</code>的<a target="_blank" rel="noopener" href="https://github.com/marketplace?type=actions">官方市场</a>，可以搜索到他人提交的<code>actions</code>. 下面是我们要自动发布<code>GitHub pages</code>所写的脚本：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">CI</span> <span class="string">Github</span> <span class="string">Pages</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="comment">#监听push操作</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span> <span class="comment"># 这里只配置了main分支，所以只有推送main分支才会触发以下任务</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="comment"># 任务ID</span></span><br><span class="line">  <span class="attr">build-and-deploy:</span></span><br><span class="line">    <span class="comment"># 运行环境</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># 步骤</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># 官方action，将代码拉取到虚拟机</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span>  <span class="string">️</span> </span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">Build</span>   <span class="comment"># 安装依赖、打包，如果提前已打包好无需这一步</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npm install</span></span><br><span class="line"><span class="string">          npm run build</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span>   <span class="comment"># 部署</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">JamesIves/github-pages-deploy-action@v4.3.3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">branch:</span> <span class="string">gh-pages</span> <span class="comment"># 部署后提交到那个分支</span></span><br><span class="line">          <span class="attr">folder:</span> <span class="string">dist</span> <span class="comment"># 这里填打包好的目录名称</span></span><br></pre></td></tr></table></figure>
<p>上面整个<code>workflow</code>的说明：</p>
<ul>
<li>只有当<code>main</code>分支有新的<code>push</code>推送时候才会执行整个<code>workflow</code>.</li>
<li>整个<code>workflow</code>只有一个<code>job</code>,<code>job_id</code>是<code>build-and-deploy</code>,<code>name</code>被省略.</li>
<li><code>job</code> 有三个<code>step</code>： 第一步是<code>Checkout</code>,获取源码，使用的<code>action</code>是<code>GitHub</code>官方的<code>actions/checkout</code>.</li>
<li>第二步：<code>Install and Build</code>,执行了两条命令：<code>npm install</code>,<code>npm run build</code>,分别安装依赖与打包应用.</li>
<li>第三步：<code>Deploy</code> 部署，使用的第三方<code>action</code>：<code>JamesIves/github-pages-deploy-action@v4.3.3</code>,它有两个参数：分别是<code>branch</code>、<code>folder</code>，更多关于这个<code>action</code>的详情可以去<a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/deploy-to-github-pages">查看</a>.</li>
</ul>
<blockquote>
<p>当点击**<code>Start commit</code>**，<code>GitHub Actions</code> 会自动运行<code>workflow</code>. 修改工程文字欢迎文字：</p>
</blockquote>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">HelloWorld</span> msg=<span class="string">&quot;You did it!&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>改为:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">HelloWorld</span> msg=<span class="string">&quot;GitHub Actions CI Succeed!&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p><code>push</code>可以点击<code>Actions</code>查看工作流的运行情况<br><img src="https://s2.loli.net/2022/12/29/aN4Z7Ak8fsPgIJo.png" alt="flow1" style="zoom:30%;" /><br>当这个黄色加载动画变成绿色后表示<code>workflow</code>运行完成，看下最终效果：<br><img src="https://s2.loli.net/2022/11/22/TcMG6iVDXkfZdJb.png" alt="flow2" style="zoom:50%;" /><br>达到了自动部署的目的.</p>
<h3 id="四-设置Custom-domain"><a href="#四-设置Custom-domain" class="headerlink" title="四. 设置Custom domain"></a>四. 设置<code>Custom domain</code></h3><p>其实经过上面的三步已经可以实现自动部署的目的了，但是还是有点瑕疵。我们部署后的项目地址是：<code>https://&lt;用户名&gt;.github.io/vue-pages/</code>,域名还是<code>GitHub</code>的,能不能改成我们自己的专属域名呢？比如改成<code>http://&lt;用户名&gt;.com/</code>,那就需要设置<code>Custom domain</code>了。</p>
<h4 id="1-购买域名"><a href="#1-购买域名" class="headerlink" title="1. 购买域名"></a>1. 购买域名</h4><p>如果想将项目地址改成自己的专属域名，首先需要你去购买一个域名，目前<a target="_blank" rel="noopener" href="https://wanwang.aliyun.com/domain/searchresult/">阿里云</a>,<a target="_blank" rel="noopener" href="https://dnspod.cloud.tencent.com/">腾讯云</a>都支持域名的购买，搜索自己喜欢的域名直接付款就好了。<br><img src="https://s2.loli.net/2022/12/29/yh8OMVg9PYv4HcI.png" alt="domain"></p>
<h4 id="2-购买域名后，还需要我们进行实名认证以及备案，按照平台的提示进行操作就好了，这里不再涉及"><a href="#2-购买域名后，还需要我们进行实名认证以及备案，按照平台的提示进行操作就好了，这里不再涉及" class="headerlink" title="2. 购买域名后，还需要我们进行实名认证以及备案，按照平台的提示进行操作就好了，这里不再涉及."></a>2. 购买域名后，还需要我们进行实名认证以及备案，按照平台的提示进行操作就好了，这里不再涉及.</h4><h4 id="3-进行DNS解析配置"><a href="#3-进行DNS解析配置" class="headerlink" title="3. 进行DNS解析配置"></a>3. 进行DNS解析配置</h4><p>这里以阿里云为例，打开域名解析控制台，点击解析按钮<br><img src="https://s2.loli.net/2022/12/29/MlUAqoZ671FtTXR.png" alt="pic" style="zoom:30%;" /><br>点击添加记录按钮，将下面两种类型的记录值添加上，记录类型是：<code>CNAME</code>，记录值就是你<code>GitHub</code>的主域名.<br><img src="https://s2.loli.net/2022/12/29/mdMhJlj47IHDR3N.png" alt="feak" style="zoom:40%;" /></p>
<h4 id="4-设置Custom-domain"><a href="#4-设置Custom-domain" class="headerlink" title="4. 设置Custom domain"></a>4. 设置<code>Custom domain</code></h4><p>返回到项目的<code>GitHub pages</code>设置页面，将我们购买的域名添加在<code>Custom domain</code>中，点击<code>save</code>，可以看到<code>pages</code>的地址变成了我们自己的域名，访问它就会看到你的网站了.<br><img src="https://s2.loli.net/2022/12/29/CbGXnScfWVDQTs6.png" alt="pic" style="zoom:50%;" /></p>
<h3 id="五-小结"><a href="#五-小结" class="headerlink" title="五. 小结"></a>五. 小结</h3><p><code>GitHub Actions</code>给我们提供了一站式的自动化部署体验，加上<code>Custom domain</code>的设置，完全可以用于搭建我们的个人博客，最重要的是这完全免费. 你也可以用它来部署其他框架的项目，当然这里的重点是的<code>yml</code>脚本的书写.</p>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://pages.github.com/">https://pages.github.com</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/features/actions">https://github.com/features/actions</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/formula10000/article/details/98946098">https://blog.csdn.net/formula10000/article/details/98946098</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/11/15/GitHub%20Actions%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%20Vue%20%E9%A1%B9%E7%9B%AE/" data-id="cllnfb8ov00003fexhnpi5zbo" data-title="GitHub Actions 自动部署前端 Vue 项目" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Vue3.2语法糖使用总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/15/Vue3.2%E8%AF%AD%E6%B3%95%E7%B3%96%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2022-09-15T12:46:25.000Z" itemprop="datePublished">2022-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/15/Vue3.2%E8%AF%AD%E6%B3%95%E7%B3%96%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">Vue3.2语法糖使用总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>在<code>Vue2</code>时期，组件里定义的各类变量、方法、计算属性等是分别存放到<code>data</code>、<code>methods</code>、<code>computed</code>等选项里，这样编写的代码不便于后期的查阅，查找一个业务逻辑需要在各个选项来回切换。<code>vue3.0</code>组合式API<code>setup</code>函数的推出就是为了解决这个问题，它让我们的逻辑关注点更加集中，语法也更加精简，但是当我们在使用<code>vue3.0</code>的语法就构建组件的时候，总是需要把外面定义的方法变量必须要return出去才能在<code>&lt;template&gt;</code>，比较麻烦一些. <code>vue3.2</code>语法糖的出现以及一些新增的API，让我们的代码进一步简化。</p>
<h4 id="什么是语法糖？"><a href="#什么是语法糖？" class="headerlink" title="什么是语法糖？"></a>什么是语法糖？</h4><p><strong>语法糖</strong>（英语：Syntactic sugar）是由英国计算机科学家<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%BD%BC%E5%BE%97%C2%B7%E5%85%B0%E4%B8%81">彼得·兰丁</a>发明的一个术语，指计算机语言中添加的某种语法，这种语法对语言的功能没有影响，但是更方便程序员使用。语法糖让程序更加简洁，有更高的可读性。</p>
<h4 id="Vue3-2语法糖"><a href="#Vue3-2语法糖" class="headerlink" title="Vue3.2语法糖"></a><code>Vue3.2</code>语法糖</h4><p>来看下<code>vue3.0</code>与<code>vue3.2</code>的单文件组件（SFC，即.vue 文件）的结构对比</p>
<ul>
<li><code>vue3.0</code>组件<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    props: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    setup () &#123;</span><br><span class="line">        return &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></li>
<li><code>vue3.2</code>组件<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;MyTestVue :title=&quot;title&quot; @click=&quot;changeTitle&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import MyTestVue from &#x27;./MyTest.vue&#x27;;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">const title = ref(&#x27;测试一下&#x27;)</span><br><span class="line">const changeTitle = () =&gt; &#123;</span><br><span class="line">    title.value = &#x27;Hello,World&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li><p>对比<code>vue3.0</code> 与<code>vue3.2</code>版本的组件模板，最主要的变化是3.2中没有了<code>setup</code>函数，而是把它放在了script标签中。</p>
</li>
<li><p>我们定义的属性和方法也不用在return中返回，直接就可以用在模板语法中<br> …</p>
<p> 这些是直观的变化，接下来我们学习具体的用法。</p>
</li>
</ol>
<h3 id="二-使用介绍"><a href="#二-使用介绍" class="headerlink" title="二.使用介绍"></a>二.使用介绍</h3><h4 id="1-组件注册"><a href="#1-组件注册" class="headerlink" title="1.组件注册"></a>1.组件注册</h4><p><code>vue3.0</code>中使用组件，需要使用 components 选项来显式注册：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import ComponentA from &#x27;./ComponentA.js&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    ComponentA</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><code>vue3.2</code> <code>&lt;script setup&gt;</code> 的单文件组件中，导入的组件可以直接在模板中使用，组件会自动注册，并且无需指定当前组件的名字，它会自动以文件名为主，也就是不用再写name属性了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import ComponentA from &#x27;./ComponentA.vue&#x27;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;ComponentA /&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-Props-声明"><a href="#2-Props-声明" class="headerlink" title="2.Props 声明"></a>2.Props 声明</h4><p>在<code>vue3.0</code>中，<code>prop</code>可以使用<code>props</code>选项来声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  props: [&#x27;foo&#x27;],</span><br><span class="line">  // 或者用这种方式指类型与默认值</span><br><span class="line">  // props: &#123;</span><br><span class="line">  //   foo:&#123;</span><br><span class="line">  //     type: String,</span><br><span class="line">  //     default: &#x27;&#x27;</span><br><span class="line">  //   &#125;,</span><br><span class="line">  // &#125;,</span><br><span class="line">  setup(props) &#123;</span><br><span class="line">    // setup() 接收 props 作为第一个参数</span><br><span class="line">    console.log(props.foo)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>vue3.2</code>组件中，<code>props</code>可以使用<code>defineProps()</code>宏来声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">const props = defineProps([&#x27;foo&#x27;])</span><br><span class="line">// 或者</span><br><span class="line">const propsOther = defineProps(&#123;</span><br><span class="line">  title: String,</span><br><span class="line">  likes: Number</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">console.log(props.foo)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意事项：所有的 props 都遵循着单向绑定原则，props 因父组件的更新而变化，自然地将新的状态向下流往子组件，而不会逆向传递，这意味着你不应该在子组件中去更改一个 prop。</p>
</blockquote>
<h4 id="3-计算属性"><a href="#3-计算属性" class="headerlink" title="3.计算属性"></a>3.计算属性</h4><p>我们一般使用计算属性来描述依赖响应式状态的复杂逻辑。说白了就是这个计算属性的值依赖于其他响应式属性的值，依赖的属性发生变化，那么这个计算属性的值就会进行重新计算。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, computed &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const firstName = ref(&#x27;John&#x27;)</span><br><span class="line">const lastName = ref(&#x27;Doe&#x27;)</span><br><span class="line"></span><br><span class="line">const fullName = computed(&#123;</span><br><span class="line">  // getter</span><br><span class="line">  get() &#123;</span><br><span class="line">    return firstName.value + &#x27; &#x27; + lastName.value</span><br><span class="line">  &#125;,</span><br><span class="line">  // setter</span><br><span class="line">  set(newValue) &#123;</span><br><span class="line">    // 注意：我们这里使用的是解构赋值语法</span><br><span class="line">    [firstName.value, lastName.value] = newValue.split(&#x27; &#x27;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>当调用<code>fullName.value = &#39;John Doe&#39;</code>时，<code>setter</code>会被调用，而<code>firstName</code> 和 <code>lastName</code>会被更新，在<code>vue3.2</code>中我们可以直接在<code>&lt;template&gt;</code>标签中使用它，不在需要return返回。</p>
<blockquote>
<ul>
<li>不要在计算函数中做异步请求或者更改 DOM！</li>
<li>一个计算属性仅会在其响应式依赖更新时才重新计算，如果他依赖的是个非响应式的依赖，及时其值发生变化，计算属性也不会更新。</li>
<li>相比于方法而言，计算属性值会基于其响应式依赖被缓存，一个计算属性仅会在其响应式依赖更新时才重新计算</li>
</ul>
</blockquote>
<h4 id="4-watch"><a href="#4-watch" class="headerlink" title="4. watch"></a>4. watch</h4><p>在组合式API中，我们可以使用<code>watch</code>函数在每次响应式状态发生变化时触发回调函数,<code>watch</code>的第一个参数可以是不同形式的“数据源”：它可以是一个<code> ref</code>(包括计算属性)、一个响应式对象、一个 <code>getter</code> 函数、或多个数据源组成的数组：<br><code>watch()</code>是懒执行的：仅当数据源变化时，才会执行回调，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref,watch &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">const props = defineProps(&#123;</span><br><span class="line">    title: String,</span><br><span class="line">    itemList: &#123;</span><br><span class="line">        type: Array,</span><br><span class="line">        default: () =&gt; [&#123;</span><br><span class="line">            text: &#x27;title&#x27;,</span><br><span class="line">            value: 0</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">watch(() =&gt; props.itemList.length,(newValue,oldValue) =&gt; &#123;</span><br><span class="line">    console.log(&#x27;newValue===&#x27;,newValue);</span><br><span class="line">    console.log(&#x27;oldValue===&#x27;,oldValue);</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里监听<code>props.itemList.length</code>，当传入的<code>itemList</code>数量发生变化时，后面的回调方法会被调用。当然<code>wacth()</code>还有第三个可选参数：<code>否开启深监听(deep)</code>, 如果这里这样写:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref,watch &#125; from &#x27;vue&#x27;;</span><br><span class="line">...</span><br><span class="line">watch(() =&gt; props.itemList,(newValue,oldValue) =&gt; &#123;</span><br><span class="line">    console.log(&#x27;newValue===&#x27;,newValue);</span><br><span class="line">    console.log(&#x27;oldValue===&#x27;,oldValue);</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>当传入的<code>itemList</code>数量发生改变时，回调函数不会触发，正确的写法是加上其第三个参数<code>deep:true</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref,watch &#125; from &#x27;vue&#x27;;</span><br><span class="line">...</span><br><span class="line">watch(() =&gt; props.itemList,(newValue,oldValue) =&gt; &#123;</span><br><span class="line">    console.log(&#x27;newValue===&#x27;,newValue);</span><br><span class="line">    console.log(&#x27;oldValue===&#x27;,oldValue);</span><br><span class="line">&#125;,&#123;deep:true&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>watch</code>也可以同时监听多个属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref,watch &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">const props = defineProps(&#123;</span><br><span class="line">    title: String,</span><br><span class="line">    itemList: &#123;</span><br><span class="line">        type: Array,</span><br><span class="line">        default: () =&gt; [&#123;</span><br><span class="line">            text: &#x27;title&#x27;,</span><br><span class="line">            value: 0</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">// 同时监听多个属性</span><br><span class="line">watch(() =&gt; [props.itemList,props.title],(newValue,oldValue) =&gt; &#123;</span><br><span class="line">    console.log(&#x27;newValue===&#x27;,newValue);</span><br><span class="line">    console.log(&#x27;oldValue===&#x27;,oldValue);</span><br><span class="line">&#125;,&#123;deep:true&#125;)</span><br><span class="line">  </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h4 id="5-watchEffect"><a href="#5-watchEffect" class="headerlink" title="5. watchEffect()"></a>5. <code>watchEffect()</code></h4><p>与<code>watch()</code>的懒执行不同的是，<code>watchEffect()</code>会立即执行一遍回调函数，如果这时函数产生了副作用，<code>Vue</code>会自动追踪副作用的依赖关系，自动分析出响应源。上面的例子可以重写为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">  ...</span><br><span class="line">watchEffect(() =&gt; &#123;</span><br><span class="line">    console.log(&#x27;itemList===&#x27;,props.itemList.length);</span><br><span class="line">    console.log(&#x27;title===&#x27;,props.title);</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;  </span><br></pre></td></tr></table></figure>
<p>这个例子中，回调会立即执行。在执行期间，它会自动追踪<code>props.itemList.length</code>作为依赖（和计算属性的行为类似）。每当传入的<code>itemList.length</code>变化时，回调会再次执行。</p>
<p>如果要清除<code>watchEffect()</code>的的监听，只需要显示的调用<code>watchEffect()</code>的返回函数就可以了，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">  ...</span><br><span class="line">const stopEffect = watchEffect(() =&gt; &#123;</span><br><span class="line">    console.log(&#x27;itemList===&#x27;,props.itemList.length);</span><br><span class="line">    console.log(&#x27;title===&#x27;,props.title);</span><br><span class="line">&#125;)</span><br><span class="line">stopEffect()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>watch 只追踪明确侦听的数据源。它不会追踪任何在回调中访问到的东西。另外，仅在数据源确实改变时才会触发回调。我们能更加精确地控制回调函数的触发时机。<br>watchEffect，则会在副作用发生期间追踪依赖。它会在同步执行过程中，自动追踪所有能访问到的响应式属性。</p>
</blockquote>
<h4 id="6-组件的事件调用"><a href="#6-组件的事件调用" class="headerlink" title="6.组件的事件调用"></a>6.组件的事件调用</h4><h5 id="6-1-子组件调用父组件的方法"><a href="#6-1-子组件调用父组件的方法" class="headerlink" title="6.1 子组件调用父组件的方法"></a>6.1 子组件调用父组件的方法</h5><p><code>vue3.0</code>中如果我们的子组件触发父组件的方法，我们的做法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">子组件</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  emits: [&#x27;inFocus&#x27;, &#x27;submit&#x27;],</span><br><span class="line">  setup(props, ctx) &#123;</span><br><span class="line">    ctx.emit(&#x27;submit&#x27;,params)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 或者将可以将emit解构使用</span><br><span class="line">export default &#123;</span><br><span class="line">    setup(props,&#123;emit&#125;) &#123;</span><br><span class="line">    emit(&#x27;submit&#x27;,params)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">父组件</span><br><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;Children @submit=&quot;submitHandel&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;TodoItem&#x27;,</span><br><span class="line">  setup(props, &#123; emit &#125;) &#123;</span><br><span class="line">    const submitHandel = () =&gt; &#123;</span><br><span class="line">      console.log(&#x27;子组件调用了父组件的submitHandel方法&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      submitHandel,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><code>vue3.2</code>语法糖中,子组件要触发的事件需要显式地通过 <code>defineEmits()</code> 宏来声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">子组件</span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const emit = defineEmits([&#x27;inFocus&#x27;, &#x27;submit&#x27;])</span><br><span class="line"></span><br><span class="line">function buttonClick(parmas) &#123;</span><br><span class="line">  emit(&#x27;submit&#x27;, parmas)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">父组件</span><br><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;Children @submit=&quot;submitHandel&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">  const submitHandel = () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;子组件调用了父组件的submitHandel方法&#x27;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h5 id="6-2-父组件调用子组件的方法或是属性"><a href="#6-2-父组件调用子组件的方法或是属性" class="headerlink" title="6.2 父组件调用子组件的方法或是属性"></a>6.2 父组件调用子组件的方法或是属性</h5><p><code>vue3.0</code>中如果父组件触发子组件的方法或是属性，直接在return函数中返回就可以，数据都是默认隐式暴露给父组件的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">// 子组件</span><br><span class="line">setup(props, &#123; emit &#125;) &#123;</span><br><span class="line">  const isShow = ref(false)</span><br><span class="line">  // 父组件调用这个方法</span><br><span class="line">  const showSubComponent = () =&gt; &#123;</span><br><span class="line">    isShow.value = !isShow.value</span><br><span class="line">  &#125;</span><br><span class="line">  return &#123;</span><br><span class="line">      // return 返回</span><br><span class="line">      showSubComponent,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>父组件中通过<code>ref</code>获取到子组件，并对子组件暴露的方法进行访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">父组件</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;todo-list&quot;&gt;</span><br><span class="line">    &lt;TodoItemVue :itemList=&quot;itemList&quot; @clickItemHandel=&quot;clickItemHandel&quot; ref=&quot;todoItemVueRef&quot; /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  import &#123; ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">  export default &#123;</span><br><span class="line">  setup(props, &#123; emit &#125;) &#123;</span><br><span class="line">    //获取子组件ref</span><br><span class="line">    const todoItemVueRef = ref(null)</span><br><span class="line">    // 调用子组件的方法</span><br><span class="line">    const callItemFuncHandel = () =&gt; &#123;</span><br><span class="line">        todoItemVueRef.value.showSubComponent()</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">     todoItemVueRef</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><code>vue3.2</code>语法中，父组件的调用方式相同，子组件通过<code>defineExpose()</code>将方法或是属性暴露出去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">子组件</span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const isShow = ref(false)</span><br><span class="line">// 父组件调用这个方法</span><br><span class="line">const showSubComponent = () =&gt; &#123;</span><br><span class="line">    isShow.value = !isShow.value</span><br><span class="line">&#125;</span><br><span class="line">// 通过defineExpose将方法暴露出去</span><br><span class="line">defineExpose(&#123;</span><br><span class="line">    showSubComponent</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt; </span><br><span class="line">父组件</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;todo-list&quot;&gt;</span><br><span class="line">    &lt;TodoItemVue :itemList=&quot;itemList&quot; @clickItemHandel=&quot;clickItemHandel&quot; ref=&quot;todoItemVueRef&quot; /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">  import &#123; ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">  //获取子组件ref</span><br><span class="line">  const todoItemVueRef = ref(null)</span><br><span class="line">  // 调用子组件的方法</span><br><span class="line">  const callItemFuncHandel = () =&gt; &#123;</span><br><span class="line">      todoItemVueRef.value.showSubComponent()</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h4 id="7-Vuex的使用"><a href="#7-Vuex的使用" class="headerlink" title="7.Vuex的使用"></a>7.Vuex的使用</h4><p>在<code>vue3.0</code>与<code>vue3.2</code>中创建<code>Vuex</code>没有区别，只不过在<code>&lt;template&gt;</code>模板中使用Vuex的<code>store</code>有细微差别。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">ADD_ITEM_LIST</span>, <span class="variable constant_">REDUCE_ITEM_LIST</span>, <span class="variable constant_">CHANGE_ITEM_LIST_ASYNC</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./constants&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">itemList</span>: [</span><br><span class="line">      &#123; <span class="attr">text</span>: <span class="string">&#x27;Learn JavaScript&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">text</span>: <span class="string">&#x27;Learn Vue&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">text</span>: <span class="string">&#x27;Build something awesome&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doneItemList</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">itemList</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">todo</span>) =&gt;</span> todo.<span class="property">done</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="comment">// 使用ES2015风格的计算属性命名功能 来使用一个常量作为函数名</span></span><br><span class="line">    [<span class="variable constant_">ADD_ITEM_LIST</span>](state, item) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;增加数据&#x27;</span>, item);</span><br><span class="line">      state.<span class="property">itemList</span>.<span class="title function_">push</span>(item);</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="variable constant_">REDUCE_ITEM_LIST</span>](state) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;减少数据&#x27;</span>);</span><br><span class="line">      state.<span class="property">itemList</span>.<span class="title function_">pop</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    [<span class="variable constant_">CHANGE_ITEM_LIST_ASYNC</span>](&#123; commit, state &#125;, todoItem) &#123;</span><br><span class="line">      <span class="comment">/// 模拟网络请求</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">commit</span>(<span class="variable constant_">ADD_ITEM_LIST</span>, todoItem);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;state===&#x27;</span>, state);</span><br><span class="line">      &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在<code>vue3.0</code>中我们一般在return中对<code>store.state</code>进行解构,然后可以直接在<code>&lt;template&gt;</code>中使用<code>state</code>中的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;todo-item&quot;&gt;</span><br><span class="line">    &lt;ol&gt;</span><br><span class="line">      &lt;li v-for=&quot;(item,index) in itemList&quot; :key=&quot;index&quot; class=&quot;todos&quot; @click=&quot;clickItem(index)&quot;&gt;</span><br><span class="line">        &#123;&#123; item.text &#125;&#125;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">    &lt;/ol&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  export default &#123;</span><br><span class="line">  name: &#x27;TodoItem&#x27;,</span><br><span class="line">  setup(props, &#123; emit &#125;) &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      // 对store.state进行解构</span><br><span class="line">      ...store.state,</span><br><span class="line">      clickItem,</span><br><span class="line">      count,</span><br><span class="line">      isShow,</span><br><span class="line">      showSubComponent,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>vue3.2</code>中没有了return，需要我们显示的获取要使用的<code>stare</code>的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;todo-item&quot;&gt;</span><br><span class="line">    &lt;ol&gt;</span><br><span class="line">      &lt;li v-for=&quot;(item,index) in itemList&quot; :key=&quot;index&quot; class=&quot;todos&quot; @click=&quot;clickItem(index)&quot;&gt;</span><br><span class="line">        &#123;&#123; item.text &#125;&#125;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">    &lt;/ol&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;;</span><br><span class="line">const store = useStore()</span><br><span class="line">// 获取后在&lt;template&gt;中使用</span><br><span class="line">const itemList = store.state.itemList</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="8-中的-v-bind"><a href="#8-中的-v-bind" class="headerlink" title="8. &lt;style&gt;中的 v-bind"></a>8. <code>&lt;style&gt;</code>中的 v-bind</h4><p><code>&lt;style&gt;</code>中的 <code>v-bind</code>: 用于在 SFC <code>&lt;style&gt;</code> 标签中启用组件状态驱动的动态 CSS 值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, watchEffect &#125; from &#x27;vue&#x27;;</span><br><span class="line">const color = ref(&#x27;black&#x27;)</span><br><span class="line">const callChangeColorHandel = () =&gt; &#123;</span><br><span class="line">  if(color.value === &#x27;black&#x27;) &#123;</span><br><span class="line">    color.value = &#x27;red&#x27;</span><br><span class="line">  &#125;else &#123;</span><br><span class="line">    color.value = &#x27;black&#x27;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">.todo-list &#123;</span><br><span class="line">  color: v-bind(color);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>触发<code>callChangeColorHandel</code> 函数，在<code>&lt;style&gt;</code>中的<code>v-bind</code>指令可以动态绑定的响应式状态。</p>
<h3 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h3><p>整体来说，setup语法糖的引入简化了使用<code>Composition API</code>时冗长的模板代码，也就是让代码更加简洁，可读性也更高。并且官方介绍<code>vue3.2</code>在界面渲染的速度以及内存的使用量上都进行了优化，本文只是对setup语法糖的常用方式进行了总结，更多<code>vue3.2</code>新特性可以去官方文档查看。</p>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.vuejs.org/posts/vue-3.2.html">Vue3.2</a></p>
<p><a target="_blank" rel="noopener" href="https://vuex.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%22%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F%22%EF%BC%9F">Vuex</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/09/15/Vue3.2%E8%AF%AD%E6%B3%95%E7%B3%96%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" data-id="cllnfb8p100023fex8draej6s" data-title="Vue3.2语法糖使用总结" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-从Vuex到Pinia" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/18/%E4%BB%8EVuex%E5%88%B0Pinia/" class="article-date">
  <time class="dt-published" datetime="2022-07-18T12:46:25.000Z" itemprop="datePublished">2022-07-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/18/%E4%BB%8EVuex%E5%88%B0Pinia/">从Vuex到Pinia</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>在开发Vue项目时，我们一般使用<code>Vuex</code>来进行状态管理，但是在使用<code>Vuex</code>时始终伴随着一些痛点。比如：需要使用<code>Provide/Inject</code>来定义类型化的<code>InjectionKey</code>以便支持<code>TypeScript</code>，模块的结构嵌套、命名空间以及对新手比较难理解的流程规范等。<code>Pinia</code>的出现很好的解决了这些痛点。本质上<code>Pinia</code>也是<code>Vuex</code>团队核心成员开发的，在<code>Vuex</code>的基础上提出了一些改进。与<code>Vuex</code>相比，<code>Pinia</code>去除了<code>Vuex</code>中对于同步函数<code>Mutations</code>和异步函数<code>Actions</code>的区分。并且实现了在<code>Vuex5</code>中想要的大部分内容。</p>
<h3 id="二-使用"><a href="#二-使用" class="headerlink" title="二.使用"></a>二.使用</h3><p>在介绍<code>Pinia</code>之前我们先来回顾一下<code>Vuex</code>的使用流程</p>
<h4 id="1-Vuex"><a href="#1-Vuex" class="headerlink" title="1.Vuex"></a>1.Vuex</h4><p><code>Vuex</code>是一个专为<code>Vue.js</code>应用程序开发的<strong>状态管理库</strong>。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。它主要用来解决<strong>多个组件状态共享</strong>的问题。</p>
<p><img src="https://s2.loli.net/2022/04/28/JR5o9UgPHM8t7Dl.png" alt="Pic"></p>
<blockquote>
<p>主流程： 在Store中创建要共享的状态state，修改state流程：<code>Vue Compontents</code> dispatch Actions(在Actions中定义异步函数)，Action commit Mutations，在Mutations中我们定义直接修改state的纯函数，state修改促使Vue compontents 做响应式变化。</p>
</blockquote>
<h5 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="(1) 核心概念"></a>(1) 核心概念</h5><ul>
<li><p><code>State</code>: 就是组件所依赖的状态对象。我们可以在里面定义我们组件所依赖的数据。可以在Vue组件中通过<code>this.$store.state.xxx</code>获取state里面的数据.</p>
</li>
<li><p><code>Getter</code>:从 <code>store</code> 中的 <code>state</code> 派生出的一些状态，可以把他理解为是<code>store</code>的计算属性.</p>
</li>
<li><p><code>Mutation</code>:更改<code> store</code> 中状态的唯一方法是提交 mutation，我们通过在<code>mutation</code>中定义方法来改变state里面的数据.</p>
</li>
</ul>
<blockquote>
<p>在Vue组件中，我们通过<code>store.commit(&#39;方法名&#39;)</code>,来提交<code>mutation</code>。<strong>需要注意的是，Mutation 必须是同步函数</strong>。</p>
</blockquote>
<ul>
<li><code>Action:</code> action类似于 mutation，不同在于：</li>
</ul>
<p>​     Action 提交的是 mutation，而不是直接变更状态.</p>
<p>​      Action 可以包含任意异步操作.</p>
<ul>
<li><code>Module</code>: 当我们的应用较大时，为了避免所有状态会集中到一个比较大的对象中，<code>Vuex</code>允许我们将 store 分割成<strong>模块（module）</strong>，你可以把它理解为<code>Redux</code>中的<code>combineReducer</code>的作用.</li>
</ul>
<h5 id="2-在组合式API中对TypeScript的支持"><a href="#2-在组合式API中对TypeScript的支持" class="headerlink" title="(2) 在组合式API中对TypeScript的支持"></a>(2) 在组合式API中对<code>TypeScript</code>的支持</h5><p>在使用组合式API编写<code>Vue</code>组件时候，我们希望使用<code>useStore</code>返回类型化的<code>store</code>，流程大概如下：</p>
<ol>
<li>定义类型化的 <code>InjectionKey</code>。</li>
<li>将 <code>store</code> 安装到 <code>Vue</code> 应用时提供类型化的 <code>InjectionKey</code> 。</li>
<li>将类型化的 <code>InjectionKey</code>传给<code>useStore</code>方法并简化<code>useStore</code>用法</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, <span class="title class_">Store</span>, useStore <span class="keyword">as</span> baseUseStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectionKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.定义 injection key</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">key</span>: <span class="title class_">InjectionKey</span>&lt;<span class="title class_">Store</span>&lt;<span class="title class_">IState</span>&gt;&gt; = <span class="title class_">Symbol</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createStore&lt;<span class="title class_">IState</span>&gt;(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    addCount (<span class="attr">state</span>:<span class="title class_">IState</span>) &#123;</span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    asyncAddCount (&#123; commit, state &#125;) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;state.count=====&gt;&#x27;</span>, state.<span class="property">count</span>++)</span><br><span class="line"></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;addCount&#x27;</span>)</span><br><span class="line">      &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义自己的 `useStore` 组合式函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useStore</span> () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">baseUseStore</span>(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>main.ts</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; store, key &#125; <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(&#123; ... &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入 injection key</span></span><br><span class="line">app.<span class="title function_">use</span>(store, key)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>组件中使用</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang=<span class="string">&quot;ts&quot;</span>&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; defineComponent, toRefs &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  setup () &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">clickHandel</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;====&gt;&#x27;</span>)</span><br><span class="line">      store.<span class="title function_">commit</span>(<span class="string">&#x27;addCount&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">clickAsyncHandel</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;====&gt;&#x27;</span>)</span><br><span class="line">      store.<span class="title function_">dispatch</span>(<span class="string">&#x27;asyncAddCount&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...<span class="title function_">toRefs</span>(store.<span class="property">state</span>),</span><br><span class="line">      clickHandel,</span><br><span class="line">      clickAsyncHandel</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Pinia-的使用"><a href="#Pinia-的使用" class="headerlink" title="Pinia 的使用"></a>Pinia 的使用</h2><p><img src="https://s2.loli.net/2022/07/18/W9RuGc7Hm2BLVhK.png" alt="截屏2022-07-11 21.19.55"></p>
<h3 id="基本特点"><a href="#基本特点" class="headerlink" title="基本特点"></a>基本特点</h3><p> <code>Pinia</code>同样是一个Vue的状态管理工具，在<code>Vuex</code>的基础上提出了一些改进。与vuex相比，<code>Pinia</code> 最大的特点是：简便。</p>
<ul>
<li>它没有<code>mutation</code>,他只有<code>state</code>，<code>getters</code>，<code>action</code>,在<code>action</code>中支持同步与异步方法来修改<code>state</code>数据</li>
<li>类型安全，与 <code>TypeScript</code> 一起使用时具有可靠的类型推断支持</li>
<li>模块化设计，通过构建多个存储模块，可以让程序自动拆分它们。</li>
<li>非常轻巧，只有大约 1kb 的大小。</li>
<li>不再有 <code>modules</code> 的嵌套结构,没有命名空间模块</li>
<li><code>Pinia</code> 支持扩展，可以非常方便地通过本地存储，事物等进行扩展。</li>
<li>支持服务器端渲染</li>
</ul>
<h3 id="安装与使用"><a href="#安装与使用" class="headerlink" title="安装与使用"></a>安装与使用</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add pinia</span><br><span class="line"><span class="comment"># 或者使用 npm</span></span><br><span class="line">npm install pinia</span><br></pre></td></tr></table></figure>
<h4 id="核心概念："><a href="#核心概念：" class="headerlink" title="核心概念："></a>核心概念：</h4><h5 id="store-使用defineStore-函数定义一个store，第一个参数是应用程序中store的唯一id-里面包含state、getters-和-actions-与Vuex相比没有了Mutations"><a href="#store-使用defineStore-函数定义一个store，第一个参数是应用程序中store的唯一id-里面包含state、getters-和-actions-与Vuex相比没有了Mutations" class="headerlink" title="store: 使用defineStore()函数定义一个store，第一个参数是应用程序中store的唯一id. 里面包含state、getters 和 actions, 与Vuex相比没有了Mutations."></a><code>store</code>: 使用<code>defineStore()</code>函数定义一个store，第一个参数是应用程序中store的唯一id. 里面包含<code>state</code>、<code>getters</code> 和 <code>actions</code>, 与Vuex相比没有了<code>Mutations</code>.</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;main&#x27;</span>, &#123;</span><br><span class="line"> <span class="attr">state</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;ming&#x27;</span>,</span><br><span class="line">      <span class="attr">doubleCount</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：store 是一个用reactive 包裹的对象，这意味着不需要在getter 之后写.value，但是，就像setup 中的props 一样，我们不能对其进行解构.</p>
</blockquote>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line">    <span class="comment">// ❌ 这不起作用，因为它会破坏响应式</span></span><br><span class="line">    <span class="comment">// 这和从 props 解构是一样的</span></span><br><span class="line">    <span class="keyword">const</span> &#123; name, doubleCount &#125; = store</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 一直会是 &quot;ming&quot;</span></span><br><span class="line">      name,</span><br><span class="line">      <span class="comment">// 一直会是 2</span></span><br><span class="line">      doubleCount,</span><br><span class="line">      <span class="comment">// 这将是响应式的</span></span><br><span class="line">      <span class="attr">doubleValue</span>: <span class="title function_">computed</span>(<span class="function">() =&gt;</span> store.<span class="property">doubleCount</span>),</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>当然你可以使用<code>computed</code>来响应式的获取state的值（这与Vuex中需要创建<code>computed</code>引用以保留其响应性类似）,但是我们通常的做法是使用<code>storeToRefs</code>响应式解构Store.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line"><span class="comment">// 正确的响应式解构</span></span><br><span class="line"><span class="keyword">const</span> &#123; name, doubleCount &#125; = <span class="title function_">storeToRefs</span>(store)</span><br></pre></td></tr></table></figure>

<h5 id="State-在Pinia中，状态被定义为返回初始状态的函数"><a href="#State-在Pinia中，状态被定义为返回初始状态的函数" class="headerlink" title="State: 在Pinia中，状态被定义为返回初始状态的函数."></a><code>State</code>: 在Pinia中，状态被定义为返回初始状态的函数.</h5><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;main&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// 推荐使用 完整类型推断的箭头函数</span></span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 所有这些属性都将自动推断其类型</span></span><br><span class="line">      <span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Eduardo&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h6 id="组件中state的获取与修改："><a href="#组件中state的获取与修改：" class="headerlink" title="组件中state的获取与修改："></a>组件中state的获取与修改：</h6><p>在<code>Vuex</code>中我们修改<code>state</code>的值必须在<code>mutation</code>中定义方法进行修改，而在<code>pinia</code>中我们有多中修改state的方式.</p>
<ul>
<li>基本方法：<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line">store.<span class="property">counter</span>++</span><br></pre></td></tr></table></figure></li>
<li>重置状态：<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line">store.$reset()</span><br></pre></td></tr></table></figure></li>
<li>使用<code>$patch</code>修改state<br> [1] 使用部分<code>state</code>对象进行修改</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mainStore = <span class="title function_">useMainStore</span>()</span><br><span class="line">mainStore.$patch(&#123;</span><br><span class="line">   <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">   <span class="attr">counter</span>: mainStore.<span class="property">counter</span>++</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>
<p>​      [2] <code>$patch</code>方法也可以接受一个函数来批量修改集合内部分对象的值</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cartStore.$patch(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  state.<span class="property">counter</span>++</span><br><span class="line">  state.<span class="property">name</span> = <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>替换state<br>可以通过将其 $state 属性设置为新对象,来替换<code>Store</code>的整个状态：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mainStore.<span class="property">$state</span> = &#123; <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">counter</span>: <span class="number">0</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问其他模块的<code>state</code></p>
<ul>
<li><code>Vuex</code>中我们要访问其他带命名空间的模块的state我们需要使用<code>rootState</code></li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">addAsyncTabs (&#123; state, commit, rootState, rootGetters &#125;:<span class="title class_">ActionContext</span>&lt;<span class="title class_">TabsState</span>, <span class="title class_">RootState</span>&gt;, <span class="attr">tab</span>:<span class="title class_">ITab</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">/// 通过rootState 访问main的数据</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rootState.main.count=======&#x27;</span>, rootState.<span class="property">main</span>.<span class="property">count</span>)</span><br><span class="line">    <span class="keyword">if</span> (state.<span class="property">tabLists</span>.<span class="title function_">some</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">id</span> === tab.<span class="property">id</span>)) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      state.<span class="property">tabLists</span>.<span class="title function_">push</span>(tab)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Pinia 中访问其他<code>store</code>的<code>state</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useInputStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./inputStore&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useListStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;listStore&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">itemList</span>: [] <span class="keyword">as</span> <span class="title class_">IItemDate</span>[],</span><br><span class="line">      <span class="attr">counter</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    addList (<span class="attr">item</span>: <span class="title class_">IItemDate</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">itemList</span>.<span class="title function_">push</span>(item)</span><br><span class="line">      <span class="comment">///获取store，直接调用</span></span><br><span class="line">      <span class="keyword">const</span> inputStore = <span class="title function_">useInputStore</span>()</span><br><span class="line">      inputStore.<span class="property">inputValue</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="Getter-Getter完全等同于Store状态的计算值"><a href="#Getter-Getter完全等同于Store状态的计算值" class="headerlink" title="Getter: Getter完全等同于Store状态的计算值."></a>Getter: Getter完全等同于Store状态的计算值.</h4><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;main&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="comment">// 自动将返回类型推断为数字</span></span><br><span class="line">    <span class="title function_">doubleCount</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">counter</span> * <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 返回类型必须明确设置</span></span><br><span class="line">    <span class="title function_">doublePlusOne</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">counter</span> * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果需要使用<code>this</code>访问到 整个<code>store</code>的实例,在<code>TypeScript</code>需要定义返回类型.<br>在<code>setup()</code>中使用：</p>
</blockquote>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line"></span><br><span class="line">    store.<span class="property">counter</span> = <span class="number">3</span></span><br><span class="line">    store.<span class="property">doubleCount</span> <span class="comment">// 6</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>访问其他模块的getter</p>
<ul>
<li><p>对于<code>Vuex</code>而言如果要访问其他命名空间模块的<code>getter</code>，需要使用<code>rootGetters</code>属性</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// action 方法</span></span><br><span class="line">addAsyncTabs (&#123; state, commit, rootState, rootGetters &#125;:<span class="title class_">ActionContext</span>&lt;<span class="title class_">TabsState</span>, <span class="title class_">RootState</span>&gt;, <span class="attr">tab</span>:<span class="title class_">ITab</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">/// 通过rootGetters 访问main的数据</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rootGetters[]=======&#x27;</span>, rootGetters[<span class="string">&#x27;main/getCount&#x27;</span>])</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Pinia</code>中访问其他store中的getter</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useOtherStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./other-store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;main&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="title function_">otherGetter</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> otherStore = <span class="title function_">useOtherStore</span>()</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">localData</span> + otherStore.<span class="property">data</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="Action-actions-相当于组件中的methods-使用defineStore-中的-actions-属性定义"><a href="#Action-actions-相当于组件中的methods-使用defineStore-中的-actions-属性定义" class="headerlink" title="Action:actions 相当于组件中的methods,使用defineStore()中的 actions 属性定义."></a>Action:actions 相当于组件中的methods,使用<code>defineStore()</code>中的 actions 属性定义.</h4><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;main&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">counter</span>++</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">randomizeCounter</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">counter</span> = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="number">100</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>pinia</code>中没有<code>mutation</code>属性，我们可以在<code>action</code>中定义业务逻辑，<code>action</code>可以是异步的，可以在其中await 任何 API调用甚至其他操作.</p>
</blockquote>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//定义一个action</span></span><br><span class="line">asyncAddCounter () &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">counter</span>++</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">///setup()中调用</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> main = <span class="title function_">useMainStore</span>()</span><br><span class="line">    <span class="comment">// Actions 像 methods 一样被调用：</span></span><br><span class="line">    main.<span class="title function_">asyncAddCounter</span>()</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>访问其他store中的Action</p>
<p>要使用另一个 store中的action ，可以直接在操作内部使用它：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useAuthStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth-store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useSettingsStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;settings&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">fetchUserPreferences</span>(<span class="params">preferences</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> auth = <span class="title function_">useAuthStore</span>()</span><br><span class="line">      <span class="comment">///调用其他store的action</span></span><br><span class="line">      <span class="keyword">if</span> (auth.<span class="title function_">isAuthenticated</span>()) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">preferences</span> = <span class="keyword">await</span> <span class="title function_">fetchPreferences</span>()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;User must be authenticated&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p> 在<code>Vuex</code>中如果要调用另一个模块的<code>Action</code>，我们需要在当前模块中注册该方法为全局的<code>Action</code>，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 注册全局Action</span></span><br><span class="line"> <span class="attr">globalSetCount</span>: &#123;</span><br><span class="line">  <span class="attr">root</span>: <span class="literal">true</span>,<span class="comment">/// 设置root 为true</span></span><br><span class="line">    handler (&#123; commit &#125;:<span class="title class_">ActionContext</span>&lt;<span class="title class_">MainState</span>, <span class="title class_">RootState</span>&gt;, <span class="attr">count</span>:<span class="built_in">number</span>):<span class="built_in">void</span> &#123;</span><br><span class="line">       <span class="title function_">commit</span>(<span class="string">&#x27;setCount&#x27;</span>, count)</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在另一个模块中对其进行<code>dispatch</code>调用</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 调用全局命名空间的函数</span></span><br><span class="line">   handelGlobalAction (&#123; dispatch &#125;:<span class="title class_">ActionContext</span>&lt;<span class="title class_">TabsState</span>, <span class="title class_">RootState</span>&gt;):<span class="built_in">void</span> &#123;</span><br><span class="line">     <span class="title function_">dispatch</span>(<span class="string">&#x27;globalSetCount&#x27;</span>, <span class="number">100</span>, &#123; <span class="attr">root</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h3><p>与 Vuex 相比，Pinia 提供了一个更简单的 API，具有更少的操作，提供<code>Composition API</code>，最重要的是，在与<code>TypeScript</code>一起使用时具有可靠的类型推断支持，如果你正在开发一个新项目并且使用了<code>TypeScript</code>，可以尝试一下<code>pinia</code>，相信不会让你失望。</p>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://vuex.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%22%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F%22%EF%BC%9F">Vuex</a></p>
<p><a target="_blank" rel="noopener" href="https://pinia.web3doc.top/core-concepts/">Pinia</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/07/18/%E4%BB%8EVuex%E5%88%B0Pinia/" data-id="cllnfb8p8000b3fexdjfbaw5w" data-title="从Vuex到Pinia" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-iOS多线程使用总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/16/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2022-06-16T12:46:25.000Z" itemprop="datePublished">2022-06-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/16/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">iOS-多线程使用总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://i.loli.net/2021/06/25/5aihXZop3HEQuTU.png" alt="网络图片"></p>
<h3 id="一-概述与实现方案"><a href="#一-概述与实现方案" class="headerlink" title="一.概述与实现方案"></a>一.概述与实现方案</h3><h4 id="1-线程与进程"><a href="#1-线程与进程" class="headerlink" title="1. 线程与进程"></a>1. 线程与进程</h4><p>多线程在iOS中有着举足轻重的地位，是每一位开发者都必备的技能，当然也是面试常考的技术点，本文主要是探究我们实际开发或者面试中遇到的多线程问题。比如什么是线程？它跟进程是什么关系，队列跟线程什么关系，<code>同步、异步、并发（并行）、串行</code>这些概念又怎么来理解，iOS有哪些常用多线程方案，以及线程同步技术有哪些等等。</p>
<blockquote>
<p>线程（英语：thread）是操作系统能够进行运算调度的最小单位。大部分情况下，它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。   — 维基百科</p>
</blockquote>
<p>这里又多了一个 <code>进程</code>,那什么是进程呢,说白了就是是指在操作系统中正在运行的一个应用程序，如微信、支付宝app等都是一个进程。线程是就是进程的基本执行单元，一个进程的所有任务都在线程中执行。也就是说 一个进程最少要有一个线程，这个线程就是主线程。当然在我们实际使用过程中不可能只有一条主线程，我们为提高程序的执行效率，往往需要开辟多条子线程去执行一些耗时任务，这里就引出了多线程的概念。</p>
<blockquote>
<p>多线程（英语：multithreading），是指从软件或者硬件上实现多个线程并发执行的技术</p>
</blockquote>
<p>根据操作系统与硬件的不同分为两类：<code>软件多线程</code>与<code>硬件多线程</code></p>
<ul>
<li><p>软件多线程: 即便CPU只能运行一个线程，操作系统也可以通过快速的在不同线程之间进行切换，由于时间间隔很小，来给用户造成一种多个线程同时运行的假象</p>
</li>
<li><p>硬件多线程: 如果CPU有多个核心，操作系统可以让每个核心执行一条线程，从而具有真正的同时执行多个线程的能力，当然由于任务数量远远多于CPU的核心数量，所以，操作系统也会自动把很多任务轮流调度到每个核心上执行。<br>以上都是google出来的一大堆东西，比较抽象，没关系我们来看下我们实际iOS开发中用到的多线程技术。</p>
</li>
</ul>
<h4 id="2-iOS中的多线程方案"><a href="#2-iOS中的多线程方案" class="headerlink" title="2.iOS中的多线程方案"></a>2.iOS中的多线程方案</h4><p>iOS 中的多线程方案主要有四种 <code>PThread</code>、<code>NSThread</code>、<code>GCD</code>、<code>NSOperation</code>，<code>PThread</code> 是一套纯粹<code>C</code>语言的API，能适用于Unix\Linux\Windows等系统,线程生命周期需要程序员自己管理，使用难度较大，在我们的实际开发中几乎用不到，在这里我们不做过多介绍，感兴趣的直接去百度。我们着重介绍另外三中方案。</p>
<blockquote>
<p>这里解释一下线程的生命周期，所谓的线程的生命周期就是线程从创建到死亡的过程。一般会经历：<code>新建 - 就绪 - 运行 - 阻塞 - 死亡</code>的过程。</p>
</blockquote>
<ul>
<li>新建：就是初始化线程对象</li>
<li>就绪：向线程对象发送start消息，线程对象被加入可调度线程池等待CPU调度。</li>
<li>运行：CPU 负责调度可调度线程池中线程的执行，线程执行完成之前，状态可能会在就绪和运行之间来回切换。就绪和运行之间的状态变化由CPU负责，程序员不能干预。</li>
<li>阻塞：当满足某个预定条件时，可以使用休眠或锁，阻塞线程执行</li>
<li>死亡：线程执行完毕，退出，销毁。</li>
</ul>
<h5 id="1-NSThread"><a href="#1-NSThread" class="headerlink" title="(1) NSThread"></a>(1) <code>NSThread</code></h5><p>NSThread是苹果官方提供面向对象操作线程的技术，简单方便，可以直接操作线程对象，不过需要自己控制线程的生命周期，我们看下苹果官方给出的方法。</p>
<h6 id="1-初始化方法"><a href="#1-初始化方法" class="headerlink" title="[1] 初始化方法"></a>[1] 初始化方法</h6><ul>
<li>实例初始化方法<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)init API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0)) NS_DESIGNATED_INITIALIZER;</span><br><span class="line">- (instancetype)initWithTarget:(id)target selector:(SEL)selector object:(nullable id)argument API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">- (instancetype)initWithBlock:(void (^)(void))block API_AVAILABLE(macosx(10.12), ios(10.0), watchos(3.0), tvos(10.0));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
对应的初始化方法：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//创建线程</span><br><span class="line">NSThread *newThread = [[NSThread  alloc]initWithTarget:self selector:@selector(demo:) object:@&quot;Thread&quot;];</span><br><span class="line">NSThread *newThread = [[NSThread alloc]init];</span><br><span class="line">NSThread *newThread = [[NSThread alloc]initWithBlock:^&#123;</span><br><span class="line">    NSLog(@&quot;Block&quot;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意三种方法创建完成后都需要执行 <code>[newThread start]</code> 去启动线程。</p>
</blockquote>
<ul>
<li>类初始化方法<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (void)detachNewThreadWithBlock:(void (^)(void))block API_AVAILABLE(macosx(10.12), ios(10.0), watchos(3.0), tvos(10.0));</span><br><span class="line">+ (void)detachNewThreadSelector:(SEL)selector toTarget:(id)target withObject:(nullable id)argument;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意这两个类方法创建后就可执行，不需手动开启</p>
</blockquote>
</li>
</ul>
<h6 id="2-取消退出"><a href="#2-取消退出" class="headerlink" title="[2] 取消退出"></a>[2] 取消退出</h6><p>既然有了创建，那就得有退出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 实例方法 取消线程</span><br><span class="line">- (void)cancel;</span><br><span class="line">//类方法 退出</span><br><span class="line">+ (void)exit;</span><br></pre></td></tr></table></figure>
<h6 id="3-线程执行状态"><a href="#3-线程执行状态" class="headerlink" title="[3] 线程执行状态"></a>[3] 线程执行状态</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 线程正在执行</span><br><span class="line">@property (readonly, getter=isExecuting) BOOL executing API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">// 线程执行结束</span><br><span class="line">@property (readonly, getter=isFinished) BOOL finished API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">// 线程是否可取消</span><br><span class="line">@property (readonly, getter=isCancelled) BOOL cancelled API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br></pre></td></tr></table></figure>
<h6 id="4-线程间的通信方法"><a href="#4-线程间的通信方法" class="headerlink" title="[4] 线程间的通信方法"></a>[4] 线程间的通信方法</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (NSThreadPerformAdditions)</span><br><span class="line">/*</span><br><span class="line">* 去主线程执行指定方法</span><br><span class="line">* aSelector: 方法</span><br><span class="line">* arg: 参数</span><br><span class="line">* wait:表示是否等待主线程做完事情后往下走，YES表示做完后执行下面事情，NO表示跟下面事情一起执行</span><br><span class="line">*/</span><br><span class="line">- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait modes:(nullable NSArray&lt;NSString *&gt; *)array;</span><br><span class="line">- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait;</span><br><span class="line">/*</span><br><span class="line">* 去指定线程执行指定方法</span><br><span class="line">* aSelector: 方法</span><br><span class="line">* arg: 参数</span><br><span class="line">* wait:表示是否等待本线程做完事情后往下走，YES表示做完后执行下面事，NO表示跟下面事一起执行</span><br><span class="line">*/</span><br><span class="line">- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait modes:(nullable NSArray&lt;NSString *&gt; *)array API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">/*</span><br><span class="line">* 去开启的子线程执行指定方法</span><br><span class="line">* SEL: 方法</span><br><span class="line">* arg: 参数</span><br><span class="line">*/</span><br><span class="line">- (void)performSelectorInBackground:(SEL)aSelector withObject:(nullable id)arg API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>我们常说的线程间的通信所用的方法其实就是上面的这几个方法，所有继承NSObject实例化对象都可调用。当然还有其他方法也可以实现线程间的通信，如：<code>GCD</code>、<code>NSOperation</code>、<code>NSMachPort</code>端口等形式，我们后面用到在做介绍。<br>举个简单的例子：我们在子线程中下载图片，然后去主线程展示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    // 子线程执行下载方法</span><br><span class="line">    [self performSelectorInBackground:@selector(download) withObject:nil];</span><br><span class="line">&#125;</span><br><span class="line">- (void)download&#123;</span><br><span class="line">    //图片的网络路径</span><br><span class="line">     NSURL *url = [NSURL URLWithString:@&quot;https://p3.ssl.qhimg.com/t011e94f0b9ed8e66b0.png&quot;];</span><br><span class="line">     //下载图片数据</span><br><span class="line">     NSData *data = [NSData dataWithContentsOfURL:url];</span><br><span class="line">     //生成图片</span><br><span class="line">     UIImage *image = [UIImage imageWithData:data];</span><br><span class="line">    // 回主线程显示图片</span><br><span class="line">    [self performSelectorOnMainThread:@selector(showImage:) withObject:image waitUntilDone:YES];</span><br><span class="line">&#125;</span><br><span class="line">- (void)showImage:(UIImage *)image&#123;</span><br><span class="line">    self.imageView.image = image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="5-其他常用方法"><a href="#5-其他常用方法" class="headerlink" title="[5] 其他常用方法"></a>[5] 其他常用方法</h6><ul>
<li><code>+(void)currentThread</code> 获取当前线程</li>
<li><code>+(BOOL)isMultiThreaded</code> 判断当前是否运行在子线程</li>
<li><code>-(BOOL)isMainThread</code> 判断是否在主线程</li>
<li><code>+(void)sleepUntilDate:(NSDate *)date;+ (void)sleepForTimeInterval:(NSTimeInterval)ti;</code> 当前线程休眠时间</li>
</ul>
<h5 id="3-GCD"><a href="#3-GCD" class="headerlink" title="(3). GCD"></a>(3). GCD</h5><p>在介绍<code>GCD</code>前我们先来了解下多线程中比较容易混淆的几个概念</p>
<h6 id="1-同步、异步、并发（并行）、串行"><a href="#1-同步、异步、并发（并行）、串行" class="headerlink" title="[1]. 同步、异步、并发（并行）、串行"></a>[1]. 同步、异步、并发（并行）、串行</h6><ul>
<li><p>同步和异步主要影响：能不能开启新的线程<br>同步：在当前线程中执行任务，不具备开启新线程的能力<br>异步：在新的线程中执行任务，具备开启新线程的能力</p>
</li>
<li><p>并发和串行主要影响：任务的执行方式<br>并发：也叫并行，也叫并行队列，多个任务并发（同时）执行<br>串行：也叫串行队列，一个任务执行完毕后，再执行下一个任务</p>
</li>
</ul>
<p>单纯的介绍概念比较抽象，我们还是结合实际使用来说明：<br></p>
<h6 id="2-GCD-中的同步、异步方法"><a href="#2-GCD-中的同步、异步方法" class="headerlink" title="[2] GCD 中的同步、异步方法"></a>[2] GCD 中的同步、异步方法</h6><ul>
<li>同步执行方法：<code>dispatch_sync()</code></li>
<li>异步执行方法：<code>dispatch_async()</code><br>使用方法：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dispatch_sync(<span class="type">dispatch_queue_t</span> <span class="built_in">queue</span>, DISPATCH_NOESCAPE <span class="type">dispatch_block_t</span> block);</span><br><span class="line">dispatch_async(<span class="type">dispatch_queue_t</span> <span class="built_in">queue</span>, <span class="type">dispatch_block_t</span> block);</span><br></pre></td></tr></table></figure>
可以看到这个两个方法需要两个参数，第一个参数需要传入一个<code>dispatch_queue_t</code> 类型的队列，第二个是执行的block。下面介绍一下GCD的队列</li>
</ul>
<h6 id="3-GCD-中的队列"><a href="#3-GCD-中的队列" class="headerlink" title="[3] GCD 中的队列"></a>[3] GCD 中的队列</h6><p>GCD中的队列有三种：<code>串行队列、并行队列、主队列</code>，创建方式也非常简单：</p>
<ul>
<li>串行队列<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">&quot;myQueue&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br></pre></td></tr></table></figure>
第一个参数是队列名称，第二个是一个宏定义，常用的两个宏 <code>DISPATCH_QUEUE_SERIAL</code> 和 <code>DISPATCH_QUEUE_CONCURRENT</code>分别表示串行队列和并行队列,除此之外，宏<code>DISPATCH_QUEUE_SERIAL_INACTIVE</code> 和 <code>DISPATCH_QUEUE_CONCURRENT_INACTIVE</code> 分别表示初始化的串行队列和并行队列处于不可活动状态。看下它的底层实现<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">dispatch_queue_attr_t</span></span><br><span class="line"><span class="title function_">dispatch_queue_attr_make_initially_inactive</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="type">dispatch_queue_attr_t</span> _Nullable attr)</span>;</span><br><span class="line">		</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISPATCH_QUEUE_SERIAL_INACTIVE \</span></span><br><span class="line"><span class="meta">		dispatch_queue_attr_make_initially_inactive(DISPATCH_QUEUE_SERIAL)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISPATCH_QUEUE_CONCURRENT_INACTIVE \</span></span><br><span class="line"><span class="meta">		dispatch_queue_attr_make_initially_inactive(DISPATCH_QUEUE_CONCURRENT)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>应当注意的是，初始化后处于不可活动状态的队列，添加到其中的任务要想开始执行，必须先调用 <code>dispatch_activate()</code>函数使其状态变更为可活动状态.</p>
</blockquote>
</li>
<li>并行队列<br>并行队列有两种：<br><br>第一种：全局并发队列创建方法,也是系统为我们创建好的并发队列，创建方式</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  - QOS_CLASS_USER_INTERACTIVE</span></span><br><span class="line"><span class="comment"> *  - QOS_CLASS_USER_INITIATED</span></span><br><span class="line"><span class="comment"> *  - QOS_CLASS_DEFAULT</span></span><br><span class="line"><span class="comment"> *  - QOS_CLASS_UTILITY</span></span><br><span class="line"><span class="comment"> *  - QOS_CLASS_BACKGROUND</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//dispatch_get_global_queue(intptr_t identifier, uintptr_t flags); </span></span><br><span class="line"></span><br><span class="line"><span class="type">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>这里有两个参数,第一个参数标识线程执行优先级，第二个是苹果保留参数传参：0 就可以。<br><br>第二种：手动创建并发队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 串行执行，第一个参数是名称 ，第二个是标识：DISPATCH_QUEUE_CONCURRENT,并发队列标识</span></span><br><span class="line"><span class="type">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_queue_create(<span class="string">&quot;myQueue&quot;</span>,DISPATCH_QUEUE_CONCURRENT);</span><br></pre></td></tr></table></figure>
<ul>
<li>主队列<br>主队列是一种特殊的串行队列<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_get_main_queue();</span><br></pre></td></tr></table></figure>
同步、异步以及队列的组合就可以实现对任务进行多线程编程的需求了。</li>
</ul>
<ol>
<li><p>同步串行队列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  dispatch_queue_t queue1 = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    for(NSInteger i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">        dispatch_sync(queue1, ^&#123;</span><br><span class="line">            NSLog(@&quot;thread == %@ i====%ld&quot;,[NSThread currentThread],(long)i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">//thread == &lt;NSThread: 0x6000011b8880&gt;&#123;number = 1, name = main&#125; i====n</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到没有开启新的线程，都是在主线程中执行任务,并且是顺序执行的</p>
</blockquote>
</li>
<li><p>同步并行队列</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue1 = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    for(NSInteger i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">        dispatch_sync(queue1, ^&#123;</span><br><span class="line">            NSLog(@&quot;thread == %@ i====%ld&quot;,[NSThread currentThread],(long)i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">// thread == &lt;NSThread: 0x600001db8a00&gt;&#123;number = 1, name = main&#125; i====n</span><br></pre></td></tr></table></figure>
<blockquote>
<p>也是在主线程中顺序执行。<br>3. 异步串行队列</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue1 = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    for(NSInteger i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">        dispatch_async(queue1, ^&#123;</span><br><span class="line">            NSLog(@&quot;thread == %@ i====%ld&quot;,[NSThread currentThread],(long)i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>开启子线程，顺序执行任务<br>4. 异步并发队列</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> dispatch_queue_t queue1 = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    for(NSInteger i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">        dispatch_async(queue1, ^&#123;</span><br><span class="line">            NSLog(@&quot;thread == %@ i====%ld&quot;,[NSThread currentThread],(long)i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">/*</span><br><span class="line">thread == &lt;NSThread: 0x6000024f9440&gt;&#123;number = 4, name = (null)&#125; i====0</span><br><span class="line">thread == &lt;NSThread: 0x6000024f5340&gt;&#123;number = 5, name = (null)&#125; i====2</span><br><span class="line">thread == &lt;NSThread: 0x6000024a8780&gt;&#123;number = 3, name = (null)&#125; i====3</span><br><span class="line">thread == &lt;NSThread: 0x6000024ac6c0&gt;&#123;number = 6, name = (null)&#125; i====1</span><br><span class="line">thread == &lt;NSThread: 0x6000024f4a80&gt;&#123;number = 8, name = (null)&#125; i====5</span><br><span class="line">thread == &lt;NSThread: 0x6000024b0b40&gt;&#123;number = 7, name = (null)&#125; i====4</span><br><span class="line">thread == &lt;NSThread: 0x60000249cd00&gt;&#123;number = 9, name = (null)&#125; i====6</span><br><span class="line">thread == &lt;NSThread: 0x6000024b0980&gt;&#123;number = 10, name = (null)&#125; i====7</span><br><span class="line">thread == &lt;NSThread: 0x6000024cb900&gt;&#123;number = 11, name = (null)&#125; i====8</span><br><span class="line">thread == &lt;NSThread: 0x6000024f5340&gt;&#123;number = 5, name = (null)&#125; i====9</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>开启了多个子线程，并且是并发执行任务。</p>
</blockquote>
<p>注意 <code>dispatch_async()</code>具备开辟新线程的能力，但是不表示使用它就一定会开辟新的线程。 例如 传入的 queue 是主队列,就是在主线程中执行任务,没有开辟新线程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  dispatch_queue_t queue1 = dispatch_get_main_queue();</span><br><span class="line">    for(NSInteger i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">        sleep(2);</span><br><span class="line">        dispatch_async(queue1, ^&#123;</span><br><span class="line">            NSLog(@&quot;thread == %@ i====%ld&quot;,[NSThread currentThread],(long)i);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">//thread == &lt;NSThread: 0x600002b24880&gt;&#123;number = 1, name = main&#125; i====n</span><br></pre></td></tr></table></figure>
<blockquote>
<p>主队列是一种特殊的串行队列，从打印结果看出，这里执行方式是串行，而且没有开启新的线程。</p>
</blockquote>
<p>具体任务的执行方式可以参考下面的表格<br><img src="https://i.loli.net/2021/06/25/DAehSErXHNW1cCJ.png" alt="执行方式"></p>
<h6 id="4-dispatch-group-t-队列组"><a href="#4-dispatch-group-t-队列组" class="headerlink" title="[4] dispatch_ group_ t 队列组"></a>[4] dispatch_ group_ t 队列组</h6><p><code>dispatch_group_t</code>是一个比较实用的方法，通过构造一个组的形式，将各个同步或异步提交任务都加入到同一个组中，当所有任务都完成后会收到通知，用于进一步处理.举个简单的例子如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line"></span><br><span class="line">    dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;Task1 %@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;Task2 %@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;Task3 %@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_notify(group, concurrentQueue, ^&#123;</span><br><span class="line">        NSLog(@&quot;All Task Complete&quot;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h6 id="5-diapatch-barrier-async-栅栏异步调用函数"><a href="#5-diapatch-barrier-async-栅栏异步调用函数" class="headerlink" title="[5] diapatch_barrier_async 栅栏异步调用函数"></a>[5] diapatch_barrier_async 栅栏异步调用函数</h6><p>有异步调用就也有同步调用函数<code>diapatch_barrier_sync()</code>，两者的区别：<code>dispatch_barrier_sync</code> 需要等待栅栏执行完才会执行栅栏后面的任务,而<code>dispatch_barrier_async</code> 无需等待栅栏执行完,会继续往下走，有什么用呢？其实栅栏函数用的最多的地方还是实现线程同步使用，比如我们有这样一个需求：怎么样利用GCD实现多读单写文件的IO操作？也就是怎么样实现多读单写，看代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">@interface UserCenter()</span><br><span class="line">&#123;</span><br><span class="line">    // 定义一个并发队列</span><br><span class="line">    dispatch_queue_t concurrent_queue;</span><br><span class="line">    </span><br><span class="line">    // 用户数据中心, 可能多个线程需要数据访问</span><br><span class="line">    NSMutableDictionary *userCenterDic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 多读单写模型</span><br><span class="line">@implementation UserCenter</span><br><span class="line"></span><br><span class="line">- (id)init</span><br><span class="line">&#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        // 通过宏定义 DISPATCH_QUEUE_CONCURRENT 创建一个并发队列</span><br><span class="line">        concurrent_queue = dispatch_queue_create(&quot;read_write_queue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">        // 创建数据容器</span><br><span class="line">        userCenterDic = [NSMutableDictionary dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)objectForKey:(NSString *)key</span><br><span class="line">&#123;</span><br><span class="line">    __block id obj;</span><br><span class="line">    // 同步读取指定数据,立刻返回读取结果</span><br><span class="line">    dispatch_sync(concurrent_queue, ^&#123;</span><br><span class="line">        obj = [userCenterDic objectForKey:key];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setObject:(id)obj forKey:(NSString *)key</span><br><span class="line">&#123;</span><br><span class="line">    // 异步栅栏调用设置数据</span><br><span class="line">    dispatch_barrier_async(concurrent_queue, ^&#123;</span><br><span class="line">        [userCenterDic setObject:obj forKey:key];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到把写操作放入栅栏函数，可以实现线程同步效果<br>注意：使用<code>dispatch_barrier_async</code> ，该函数只能搭配自定义并发队列 <code>dispatch_queue_t</code> 使用。不能使用全局并发队列： <code>dispatch_get_global_queue</code>，否则 <code>dispatch_barrier_async</code>无作用。</p>
</blockquote>
<h6 id="6-线程死锁"><a href="#6-线程死锁" class="headerlink" title="[6] 线程死锁"></a>[6] 线程死锁</h6><p>先来看两个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = dispatch_get_main_queue();</span><br><span class="line">    dispatch_sync(queue, ^&#123;</span><br><span class="line">        NSLog(@&quot;执行任务2&quot;);</span><br><span class="line">    &#125;);// 往主线程里面 同步添加任务 会发生死锁现象</span><br><span class="line"></span><br><span class="line"> dispatch_queue_t myQueue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(myQueue, ^&#123;</span><br><span class="line">        NSLog(@&quot;1111,thread====%@&quot;,[NSThread currentThread]);</span><br><span class="line">        </span><br><span class="line">        dispatch_sync(myQueue, ^&#123;</span><br><span class="line">            NSLog(@&quot;2222,thread====%@&quot;,[NSThread currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">// 1111,thread====&lt;NSThread: 0x6000022dd880&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">// crash</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的例子可以看出，不能向当前的串行队列，同步添加任务，否则会产生死锁导致crash。线程死锁的条件：使用sync函数往当前串行队列里面添加任务，会产生死锁。</p>
</blockquote>
<h5 id="4-NSOperation"><a href="#4-NSOperation" class="headerlink" title="(4). NSOperation"></a>(4). NSOperation</h5><p>NSOperation 是苹果对GCD面向对象的封装，它的底层是基于<code>GCD</code>实现的，相比于GCD它添加了更多实用的功能</p>
<ul>
<li>可以添加任务依赖</li>
<li>任务执行状态的控制</li>
<li>设置最大并发数<br>它有两个核心类分别是<code>NSOperation</code>和<code>NSOperationQueue</code>，NSOperation就是对任务进行的封装，封装好的任务交给不同的NSOperationQueue即可进行串行队列的执行或并发队列的执行。</li>
</ul>
<h6 id="1-NSOperation"><a href="#1-NSOperation" class="headerlink" title="[1] NSOperation"></a>[1] NSOperation</h6><p>NSOperation 是一个抽象类，并不能直接实用，必须使用它的子类，有三种方式：<code>NSInvocationOperation</code>、<code>NSBlockOperation</code>、<code>自定义子类继承NSOperation</code>,前两中是苹果为我们封装好的，可以直接使用，自定义子类，需要我们实现相应的方法。</p>
<ul>
<li>NSBlockOperation &amp; NSInvocationOperation<br>使用：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//创建一个NSBlockOperation对象，传入一个block</span><br><span class="line">NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">    for (int i = 0; i &lt; 5; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        NSLog(@&quot;Task1 %@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">创建一个NSInvocationOperation对象，指定执行的对象和方法</span><br><span class="line">该方法可以接收一个参数即object</span><br><span class="line">*/</span><br><span class="line">NSInvocationOperation *invocationOperation = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(task:) object:@&quot;Hello, World!&quot;];</span><br><span class="line"></span><br><span class="line">// 执行</span><br><span class="line">[operation start];</span><br><span class="line">[invocationOperation start];</span><br><span class="line"></span><br><span class="line">// 打印： Task1 &lt;NSThread: 0x6000019581c0&gt;&#123;number = 1, name = main&#125; 0</span><br></pre></td></tr></table></figure>
可以看到创建这两个任务对象去执行任务，并没有开启新线程。NSBlockOperation 相比 NSInvocationOperation 多了个<code>addExecutionBlock</code> 追加任务的方法，<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;task1=====%@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [operation addExecutionBlock:^&#123;</span><br><span class="line">       </span><br><span class="line">        NSLog(@&quot;task2=====%@&quot;,[NSThread currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [operation addExecutionBlock:^&#123;</span><br><span class="line">       </span><br><span class="line">        NSLog(@&quot;task3=====%@&quot;,[NSThread currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [operation addExecutionBlock:^&#123;</span><br><span class="line">       </span><br><span class="line">        NSLog(@&quot;task4=====%@&quot;,[NSThread currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [operation start];</span><br><span class="line">/*</span><br><span class="line">task3=====&lt;NSThread: 0x600000509840&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">task4=====&lt;NSThread: 0x600000530200&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">task1=====&lt;NSThread: 0x600000558880&gt;&#123;number = 1, name = main&#125; 0</span><br><span class="line">task2=====&lt;NSThread: 0x600000511680&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">task1=====&lt;NSThread: 0x600000558880&gt;&#123;number = 1, name = main&#125; 1</span><br><span class="line">task1=====&lt;NSThread: 0x600000558880&gt;&#123;number = 1, name = main&#125; 2</span><br><span class="line">task1=====&lt;NSThread: 0x600000558880&gt;&#123;number = 1, name = main&#125; 3</span><br><span class="line">task1=====&lt;NSThread: 0x600000558880&gt;&#123;number = 1, name = main&#125; 4</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用<code>addExecutionBlock</code>追加的任务是并发执行的,如果这个操作的任务数大于1那么会开启子线程并发执行任务，这里追加的任务不一定就是子线程，也有可能是主线程。</p>
</blockquote>
</li>
</ul>
<h6 id="2-NSOperationQueue"><a href="#2-NSOperationQueue" class="headerlink" title="[2] NSOperationQueue"></a>[2] NSOperationQueue</h6><p>NSOperationQueue 有两种队列，一个是主队列通过<code>[NSOperationQueue mainQueue]</code> 获取，还有一个是自己创建的队列<code>[[NSOperationQueue alloc] init]</code>,它同时具备并发跟串行的能力，可以通过设置最大并发数来决定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;task1=====%@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    NSBlockOperation *operation2 = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;Task2===== %@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    NSOperationQueue *queues = [[NSOperationQueue alloc] init];</span><br><span class="line">    [queues setMaxConcurrentOperationCount:2];//设置最大并发数，如果设置为1则串行执行</span><br><span class="line">    [queues addOperation:operation];</span><br><span class="line">    [queues addOperation:operation2];</span><br><span class="line">/*</span><br><span class="line">Task2===== &lt;NSThread: 0x600000489940&gt;&#123;number = 4, name = (null)&#125; 0</span><br><span class="line">task1=====&lt;NSThread: 0x6000004e15c0&gt;&#123;number = 5, name = (null)&#125; 0</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>这个例子有两个任务，如果设置最大并发数为2，则会开辟两个线程，并发执行这两个任务。如果设置为1，则会在新的线程中串行执行。</p>
<h6 id="3-任务依赖"><a href="#3-任务依赖" class="headerlink" title="[3] 任务依赖"></a>[3] 任务依赖</h6><p><code>addDependency</code>可以建立两个任务之间的依赖关系，如<code>[operation2 addDependency:operation1];</code> 为任务2依赖任务1，必须等任务1执行完成后才会执行任务2，看个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;task1=====%@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    NSBlockOperation *operation2 = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;Task2===== %@ %d&quot;, [NSThread currentThread], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    NSOperationQueue *queues = [[NSOperationQueue alloc] init];</span><br><span class="line">    [queues setMaxConcurrentOperationCount:2];</span><br><span class="line">    //设置任务依赖</span><br><span class="line">    [operation addDependency:operation2];</span><br><span class="line">    </span><br><span class="line">    [queues addOperation:operation];</span><br><span class="line">    [queues addOperation:operation2];</span><br><span class="line">/*</span><br><span class="line">Task2===== &lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 0</span><br><span class="line">Task2===== &lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 1</span><br><span class="line">Task2===== &lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 2</span><br><span class="line">Task2===== &lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 3</span><br><span class="line">Task2===== &lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 4</span><br><span class="line">task1=====&lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 0</span><br><span class="line">task1=====&lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 1</span><br><span class="line">task1=====&lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 2</span><br><span class="line">task1=====&lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 3</span><br><span class="line">task1=====&lt;NSThread: 0x6000005b5dc0&gt;&#123;number = 6, name = (null)&#125; 4</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>还是已上面的例子，设置<code>[operation addDependency:operation2];</code>,可以看到任务2完成后才会执行任务1的操作。</p>
<h6 id="4-自定义NSOperation"><a href="#4-自定义NSOperation" class="headerlink" title="[4] 自定义NSOperation"></a>[4] 自定义NSOperation</h6><p>任务执行状态的控制是相对于自定义的NSOperation子类来说的。对于自定义NSOperation子类有两种类型：<br></p>
<ol>
<li>重写<code>main</code>方法<br>只重写<code>operation</code>的main方法,main方法里面写要执行的任务，系统底层控制变更任务执行完成状态，以及任务的退出。看个例子</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;TestOperation.h&quot;</span><br><span class="line"></span><br><span class="line">@interface TestOperation ()</span><br><span class="line">@property (nonatomic, copy) id obj;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation TestOperation</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithObject:(id)obj&#123;</span><br><span class="line">    if(self = [super init])&#123;</span><br><span class="line">        self.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    return  self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)main&#123;</span><br><span class="line">    NSLog(@&quot;开始执行任务%@ thread===%@&quot;,self.obj,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  TestOperation *operation4 = [[TestOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务4&quot;]];</span><br><span class="line">    [operation4 setCompletionBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;执行完成 thread===%@&quot;,[NSThread currentThread]);</span><br><span class="line">    &#125;];</span><br><span class="line">    [operation4 start];</span><br><span class="line">// 打印</span><br><span class="line">开始执行任务我是任务4 thread===&lt;NSThread: 0x6000008d8880&gt;&#123;number = 1, name = main&#125;</span><br><span class="line">执行完成 thread===&lt;NSThread: 0x60000089fa40&gt;&#123;number = 7, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到任务operation的main方法执行是在主线程中的，只是最后完成后的回调<code>setCompletionBlock</code>是异步的，好像没什么用，别着急，我们把他放入队列中执行看下，还是上面的例子,加入队列执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> NSOperationQueue *queue4 = [[NSOperationQueue alloc] init];</span><br><span class="line"> TestOperation *operation4 = [[TestOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务4&quot;]];</span><br><span class="line"> TestOperation *operation5 = [[TestOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务5&quot;]];</span><br><span class="line"> TestOperation *operation6 = [[TestOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务6&quot;]];</span><br><span class="line"></span><br><span class="line"> [queue4 addOperation:operation4];</span><br><span class="line"> [queue4 addOperation:operation5];</span><br><span class="line"> [queue4 addOperation:operation6];</span><br><span class="line">//打印：</span><br><span class="line">开始执行任务我是任务6 thread===&lt;NSThread: 0x600001fc8200&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务4 thread===&lt;NSThread: 0x600001fcc040&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务5 thread===&lt;NSThread: 0x600001fd7c80&gt;&#123;number = 7, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>这时候可以看到任务的并发执行了，operation的main方法执行结束后就会调用各自的<code>dealloc</code>方法进行释放，任务的生命周期结束。如果我们想让任务4、5、6 倒序执行，可以添加任务依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> [operation4 addDependency:operation5];</span><br><span class="line"> [operation5 addDependency:operation6];</span><br><span class="line">// 打印</span><br><span class="line">开始执行任务我是任务6 thread===&lt;NSThread: 0x600003d04680&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务5 thread===&lt;NSThread: 0x600003d04680&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务4 thread===&lt;NSThread: 0x600003d04680&gt;&#123;number = 6, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>这样做貌似是可以的，但是如果我们的operation 中又存在异步任务（如网络请求），我们想让网络任务6请求完后调用任务5，任务5调用成功后调任务4，那该怎么办呢，我们先卖个关子，我们在第二节<code>多个请求完成后继续进行下一个请求的方法总结</code>中介绍。<br>2. 重写<code>start</code>方法<br>通过重写<code>main</code>方法可以实现任务的串行执行，如果要让任务并发执行，就需要重写<code>start</code>方法。两者还是有很大区别的：<br>如果只是重写main方法，方法执行完毕，那么整个operation就会从队列中被移除。如果你是一个自定义的operation并且它是某些类的代理，这些类恰好有异步方法，这时就会找不到代理导致程序出错了。然而start方法就算执行完毕，它的finish属性也不会变，因此你可以控制这个operation的生命周期了。然后在任务完成之后手动cancel掉这个operation即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@interface TestStartOperation : NSOperation</span><br><span class="line">- (instancetype)initWithObject:(id)obj;</span><br><span class="line">@property (nonatomic, copy) id obj;</span><br><span class="line">@property (nonatomic, assign, getter=isExecuting) BOOL executing;</span><br><span class="line">@property (nonatomic, assign, getter=isFinished) BOOL finished;</span><br><span class="line">@end</span><br><span class="line">@implementation TestStartOperation</span><br><span class="line">@synthesize executing = _executing;</span><br><span class="line">@synthesize finished = _finished;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithObject:(id)obj&#123;</span><br><span class="line">    if(self = [super init])&#123;</span><br><span class="line">        self.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    return  self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)start&#123;</span><br><span class="line">    </span><br><span class="line">    //在任务开始前设置executing为YES，在此之前可能会进行一些初始化操作</span><br><span class="line">    self.executing = YES;</span><br><span class="line">    NSLog(@&quot;开始执行任务%@ thread===%@&quot;,self.obj,[NSThread currentThread]);</span><br><span class="line">    /*</span><br><span class="line">    需要在适当的位置判断外部是否调用了cancel方法</span><br><span class="line">    如果被cancel了需要正确的结束任务</span><br><span class="line">    */</span><br><span class="line">    if (self.isCancelled)</span><br><span class="line">    &#123;</span><br><span class="line">        //任务被取消正确结束前手动设置状态</span><br><span class="line">        self.executing = NO;</span><br><span class="line">        self.finished = YES;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSString *str = @&quot;https://www.360.cn&quot;;</span><br><span class="line">    NSURL *url = [NSURL URLWithString:str];</span><br><span class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</span><br><span class="line">    NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">    __weak typeof(self) weakSelf = self;</span><br><span class="line">    NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">       // NSLog(@&quot;response==%@&quot;,response);</span><br><span class="line">        NSLog(@&quot;TASK完成:====%@ thread====%@&quot;,weakSelf.obj,[NSThread currentThread]);</span><br><span class="line">        //任务执行完成后手动设置状态</span><br><span class="line">        weakSelf.executing = NO;</span><br><span class="line">        weakSelf.finished = YES;</span><br><span class="line">    &#125;];</span><br><span class="line">    [task resume];</span><br><span class="line">&#125;</span><br><span class="line">- (void)setExecuting:(BOOL)executing</span><br><span class="line">&#123;</span><br><span class="line">    //手动调用KVO通知</span><br><span class="line">    [self willChangeValueForKey:@&quot;isExecuting&quot;];</span><br><span class="line">    _executing = executing;</span><br><span class="line">    //调用KVO通知</span><br><span class="line">    [self didChangeValueForKey:@&quot;isExecuting&quot;];</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isExecuting</span><br><span class="line">&#123;</span><br><span class="line">    return _executing;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setFinished:(BOOL)finished</span><br><span class="line">&#123;</span><br><span class="line">    //手动调用KVO通知</span><br><span class="line">    [self willChangeValueForKey:@&quot;isFinished&quot;];</span><br><span class="line">    _finished = finished;</span><br><span class="line">    //调用KVO通知</span><br><span class="line">    [self didChangeValueForKey:@&quot;isFinished&quot;];</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isFinished</span><br><span class="line">&#123;</span><br><span class="line">    return _finished;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isAsynchronous</span><br><span class="line">&#123;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">    NSLog(@&quot;Dealloc %@&quot;,self.obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行与结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NSOperationQueue *queue4 = [[NSOperationQueue alloc] init];</span><br><span class="line">TestStartOperation *operation4 = [[TestStartOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务4&quot;]];</span><br><span class="line">TestStartOperation *operation5 = [[TestStartOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务5&quot;]];</span><br><span class="line">TestStartOperation *operation6 = [[TestStartOperation alloc] initWithObject:[NSString stringWithFormat:@&quot;我是任务6&quot;]];</span><br><span class="line">//设置任务依赖 </span><br><span class="line">[operation4 addDependency:operation5];</span><br><span class="line">[operation5 addDependency:operation6];</span><br><span class="line">[queue4 addOperation:operation4];</span><br><span class="line">[queue4 addOperation:operation5];</span><br><span class="line">[queue4 addOperation:operation6];</span><br><span class="line">/*打印</span><br><span class="line">开始执行任务我是任务6 thread===&lt;NSThread: 0x600002bb8480&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">TASK完成:====我是任务6 thread====&lt;NSThread: 0x600002bd4d80&gt;&#123;number = 8, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务5 thread===&lt;NSThread: 0x600002bb0300&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">TASK完成:====我是任务5 thread====&lt;NSThread: 0x600002bb0300&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务4 thread===&lt;NSThread: 0x600002bfb080&gt;&#123;number = 7, name = (null)&#125;</span><br><span class="line">TASK完成:====我是任务4 thread====&lt;NSThread: 0x600002bfb080&gt;&#123;number = 7, name = (null)&#125;</span><br><span class="line">2021-06-22 17:57:56.436591+0800 Interview01-打印[15994:9172130] Dealloc 我是任务4</span><br><span class="line">2021-06-22 17:57:56.436690+0800 Interview01-打印[15994:9172130] Dealloc 我是任务5</span><br><span class="line">2021-06-22 17:57:56.436784+0800 Interview01-打印[15994:9172130] Dealloc 我是任务6</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>在这个例子中我们在任务请求完成后，手动设置其<code>self.executing</code>和<code>self.finished</code>状态，并且手动触发KVO，队列会监听任务的执行状态。由于我们设置了任务依赖，当任务6请求完成后才会执行任务5，任务5请求完成后 才会执行任务4。最后对各自任务进行移除队列并释放。其实这样也变相解决了上面重写<code>main</code>方法中无法解决的问题。</p>
<h3 id="二-实际应用"><a href="#二-实际应用" class="headerlink" title="二.实际应用"></a>二.实际应用</h3><p><img src="https://i.loli.net/2021/06/25/BFjIue9kngfc8qQ.jpg" alt="执行"></p>
<blockquote>
<p>多个请求完成后继续进行下一个请求的方法总结</p>
</blockquote>
<p>在我们的工作中经常会遇到这样的请求：一个请求依赖另一个请求的结果，或者多个请求一起发出然后再获取所有的结果后继续后续操作。根据这几种情况总结常用的方法：</p>
<h4 id="1-使用GCD的dispatch-group-t实现"><a href="#1-使用GCD的dispatch-group-t实现" class="headerlink" title="1. 使用GCD的dispatch_group_t实现"></a>1. 使用<code>GCD</code>的<code>dispatch_group_t</code>实现</h4><p>需求：请求顺序执行，执行完成后回调结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> NSString *str = @&quot;https://www.360.cn&quot;;</span><br><span class="line"> NSURL *url = [NSURL URLWithString:str];</span><br><span class="line"> NSURLRequest *request = [NSURLRequest requestWithURL:url];</span><br><span class="line"> NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">   </span><br><span class="line"> dispatch_group_t downloadGroup = dispatch_group_create();</span><br><span class="line"> for (int i=0; i&lt;10; i++) &#123;</span><br><span class="line">       dispatch_group_enter(downloadGroup);</span><br><span class="line">       NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">           </span><br><span class="line">          NSLog(@&quot;执行完请求=%d&quot;,i);</span><br><span class="line">          dispatch_group_leave(downloadGroup);</span><br><span class="line">       &#125;];</span><br><span class="line">       </span><br><span class="line">       [task resume];</span><br><span class="line">   &#125;</span><br><span class="line">   dispatch_group_notify(downloadGroup, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">       NSLog(@&quot;end&quot;);</span><br><span class="line">   &#125;);</span><br><span class="line">/*</span><br><span class="line">2021-06-22 18:37:56.786878+0800 Interview01-打印[17121:9352056] 请求结束：0</span><br><span class="line">2021-06-22 18:37:56.787770+0800 Interview01-打印[17121:9352057] 请求结束：1</span><br><span class="line">2021-06-22 18:37:56.788492+0800 Interview01-打印[17121:9352057] 请求结束：2</span><br><span class="line">2021-06-22 18:37:56.789148+0800 Interview01-打印[17121:9352057] 请求结束：3</span><br><span class="line">2021-06-22 18:37:56.789837+0800 Interview01-打印[17121:9352057] 请求结束：4</span><br><span class="line">2021-06-22 18:37:56.790433+0800 Interview01-打印[17121:9352059] 请求结束：5</span><br><span class="line">2021-06-22 18:37:56.791117+0800 Interview01-打印[17121:9352059] 请求结束：6</span><br><span class="line">2021-06-22 18:37:56.791860+0800 Interview01-打印[17121:9352059] 请求结束：7</span><br><span class="line">2021-06-22 18:37:56.792614+0800 Interview01-打印[17121:9352059] 请求结束：8</span><br><span class="line">2021-06-22 18:37:56.793201+0800 Interview01-打印[17121:9352059] 请求结束：9</span><br><span class="line">2021-06-22 18:37:56.804529+0800 Interview01-打印[17121:9351753] end*/</span><br></pre></td></tr></table></figure>
<p>主要方法：</p>
<ul>
<li><code>dispatch_group_t downloadGroup = dispatch_group_create();</code>创建队列组</li>
<li><code>dispatch_group_enter(downloadGroup);</code> 每次执行请求前调用</li>
<li><code>dispatch_group_leave(downloadGroup);</code> 请求完成后调用离开方法</li>
<li><code>dispatch_group_notify()</code> 所有请求完成后回调block</li>
<li>对于enter和leave必须配合使用，有几次enter就要有几次leave</li>
</ul>
<h4 id="2-GCD信号量dispatch-semaphore-t"><a href="#2-GCD信号量dispatch-semaphore-t" class="headerlink" title="2. GCD信号量dispatch_semaphore_t"></a>2. <code>GCD</code>信号量<code>dispatch_semaphore_t</code></h4><h5 id="1-需求：顺序执行多个请求，都执行完成后回调给end"><a href="#1-需求：顺序执行多个请求，都执行完成后回调给end" class="headerlink" title="(1).需求：顺序执行多个请求，都执行完成后回调给end"></a>(1).需求：顺序执行多个请求，都执行完成后回调给end</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NSString *str = @&quot;https://www.360.cn&quot;;</span><br><span class="line">NSURL *url = [NSURL URLWithString:str];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:url];</span><br><span class="line">NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">       </span><br><span class="line">dispatch_semaphore_t sem = dispatch_semaphore_create(0);</span><br><span class="line">   </span><br><span class="line">for (int i=0; i&lt;10; i++) &#123;</span><br><span class="line">      </span><br><span class="line">     NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">           </span><br><span class="line">           NSLog(@&quot;请求结束：%d&quot;,i);</span><br><span class="line">           dispatch_semaphore_signal(sem);</span><br><span class="line">     &#125;];</span><br><span class="line">     [task resume];</span><br><span class="line">     dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br><span class="line">&#125;</span><br><span class="line">   dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">       NSLog(@&quot;end&quot;);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
<p>主要方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_semaphore_t sem = dispatch_semaphore_create(0);</span><br><span class="line">dispatch_semaphore_signal(sem);</span><br><span class="line">dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br></pre></td></tr></table></figure>
<p><code>dispatch_semaphore</code>信号量为基于计数器的一种多线程同步机制,<code>dispatch_semaphore_signal(sem);</code>表示为计数+1操作，<code>dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</code> 信号量-1，遇到<code>dispatch_semaphore_wait</code>如果信号量的值小于0,就一直阻塞线程,不执行后面的所有程序,直到信号量大于等于0;当第一个for循环执行后<code>dispatch_semaphore_wait</code>堵塞线程，直到执行到<code>dispatch_semaphore_signal</code>后继续下一个for循环进行请求，以此类推完成顺序请求。</p>
<h5 id="2-需求：多个请求同时进行，都执行完成后回调给end"><a href="#2-需求：多个请求同时进行，都执行完成后回调给end" class="headerlink" title="(2).需求：多个请求同时进行，都执行完成后回调给end"></a>(2).需求：多个请求同时进行，都执行完成后回调给end</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">NSString *str = @&quot;https://www.360.cn&quot;;</span><br><span class="line">NSURL *url = [NSURL URLWithString:str];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:url];</span><br><span class="line">NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">       </span><br><span class="line"> dispatch_semaphore_t sem = dispatch_semaphore_create(0);</span><br><span class="line"> __block int count = 0;</span><br><span class="line"> for (int i=0; i&lt;10; i++) &#123;</span><br><span class="line">           </span><br><span class="line">      NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">               </span><br><span class="line">        NSLog(@&quot;%d---%d&quot;,i,i);</span><br><span class="line">        count++;</span><br><span class="line">        if (count==10) &#123;</span><br><span class="line">            dispatch_semaphore_signal(sem);</span><br><span class="line">            count = 0;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;];</span><br><span class="line">           </span><br><span class="line">       [task resume];</span><br><span class="line">   &#125;</span><br><span class="line">   dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br><span class="line">       </span><br><span class="line">   dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        NSLog(@&quot;end&quot;);</span><br><span class="line">   &#125;);</span><br><span class="line">/*</span><br><span class="line">2021-06-23 09:47:49.723576+0800 Interview01-打印[21740:9823752] 请求完成：0</span><br><span class="line">2021-06-23 09:47:49.741118+0800 Interview01-打印[21740:9823751] 请求完成：1</span><br><span class="line">2021-06-23 09:47:49.756781+0800 Interview01-打印[21740:9823752] 请求完成：3</span><br><span class="line">2021-06-23 09:47:49.765250+0800 Interview01-打印[21740:9823752] 请求完成：2</span><br><span class="line">2021-06-23 09:47:49.773008+0800 Interview01-打印[21740:9823756] 请求完成：4</span><br><span class="line">2021-06-23 09:47:49.797809+0800 Interview01-打印[21740:9823751] 请求完成：5</span><br><span class="line">2021-06-23 09:47:49.801775+0800 Interview01-打印[21740:9823751] 请求完成：6</span><br><span class="line">2021-06-23 09:47:49.805542+0800 Interview01-打印[21740:9823751] 请求完成：7</span><br><span class="line">2021-06-23 09:47:49.814714+0800 Interview01-打印[21740:9823751] 请求完成：8</span><br><span class="line">2021-06-23 09:47:49.850517+0800 Interview01-打印[21740:9823753] 请求完成：9</span><br><span class="line">2021-06-23 09:47:49.864394+0800 Interview01-打印[21740:9823591] end</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>这个也比较好理解，for循环运行后堵塞当前线程（当前是主线程，你也可以把这段代码放入子线程中去执行），当10个请求全部完成后发送信号，继续下面的流程。</p>
<h4 id="3-使用NSOperation与GCD结合使用"><a href="#3-使用NSOperation与GCD结合使用" class="headerlink" title="3. 使用NSOperation与GCD结合使用"></a>3. 使用<code>NSOperation</code>与<code>GCD</code>结合使用</h4><p>需求：两个网络请求，第一个依赖第二个的回调结果</p>
<p>通过自定义<code>operation</code>实现，我们重写其main方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@interface CustomOperation : NSOperation</span><br><span class="line">@property (nonatomic, copy) id obj;</span><br><span class="line">- (instancetype)initWithObject:(id)obj;</span><br><span class="line">@end</span><br><span class="line">@implementation CustomOperation</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithObject:(id)obj&#123;</span><br><span class="line">    if(self = [super init])&#123;</span><br><span class="line">        self.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    return  self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)main&#123;</span><br><span class="line">    </span><br><span class="line">    //创建信号量并设置计数默认为0</span><br><span class="line">    dispatch_semaphore_t sema = dispatch_semaphore_create(0);</span><br><span class="line">    NSLog(@&quot;开始执行任务%@&quot;,self.obj);</span><br><span class="line">    NSString *str = @&quot;https://www.360.cn&quot;;</span><br><span class="line">    NSURL *url = [NSURL URLWithString:str];</span><br><span class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</span><br><span class="line">    NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">    </span><br><span class="line">    NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        NSLog(@&quot;TASK完成:====%@ thread====%@&quot;,self.obj,[NSThread currentThread]);</span><br><span class="line">        //请求成功 计数+1操作</span><br><span class="line">        dispatch_semaphore_signal(sema);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    [task resume];</span><br><span class="line">    </span><br><span class="line">    //若计数为0则一直等待</span><br><span class="line">    dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调用与结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> NSOperationQueue *queue3 = [[NSOperationQueue alloc] init];</span><br><span class="line">    [queue3 setMaxConcurrentOperationCount:2];</span><br><span class="line">    CustomOperation *operation0 = [[CustomOperation alloc] initWithObject:@&quot;我是任务0&quot;];</span><br><span class="line">    CustomOperation *operation1 = [[CustomOperation alloc] initWithObject:@&quot;我是任务1&quot;];</span><br><span class="line">    CustomOperation *operation2 = [[CustomOperation alloc] initWithObject:@&quot;我是任务2&quot;];</span><br><span class="line">    CustomOperation *operation3 = [[CustomOperation alloc] initWithObject:@&quot;我是任务3&quot;];</span><br><span class="line"></span><br><span class="line">    [operation0 addDependency:operation1];</span><br><span class="line">    [operation1 addDependency:operation2];</span><br><span class="line">    [operation2 addDependency:operation3];</span><br><span class="line"></span><br><span class="line">    [queue3 addOperation:operation0];</span><br><span class="line">    [queue3 addOperation:operation1];</span><br><span class="line">    [queue3 addOperation:operation2];</span><br><span class="line">    [queue3 addOperation:operation3];</span><br><span class="line">/**打印结果</span><br><span class="line">开始执行任务我是任务3</span><br><span class="line">TASK完成:====我是任务3 thread====&lt;NSThread: 0x6000039c3340&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务2</span><br><span class="line">TASK完成:====我是任务2 thread====&lt;NSThread: 0x6000039ece80&gt;&#123;number = 7, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务1</span><br><span class="line">TASK完成:====我是任务1 thread====&lt;NSThread: 0x6000039c3340&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">开始执行任务我是任务0</span><br><span class="line">TASK完成:====我是任务0 thread====&lt;NSThread: 0x6000039c3d00&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<ul>
<li>设置任务依赖并且添加到队列后是可以满足我们的需求</li>
<li>由于任务内部是异步回调，可以看到任务内部的执行还是依赖于<code>dispatch_semaphore_t</code>来实现的</li>
<li>也可以通过重写<code>start</code>方法实现，在上面章节我们已经介绍过了，这里不再赘述。</li>
</ul>
<h3 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h3><p>本文的篇幅有点长了，但是还有一些内容没有覆盖到，比如iOS中常用的线程锁、<code>NSOperationQueue</code>的暂停与取消等，我们会在后面的文章中逐步完善补充。</p>
<blockquote>
<p>由于作者水平有限，难免出现纰漏，如有问题还请不吝赐教。</p>
</blockquote>
<p>参考资料：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html">苹果官方——并发编程指南：Operation Queues</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/liuyang11908/article/details/70757534">iOS GCD之dispatch_semaphore(信号量)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/06/16/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" data-id="cllnfb8p500083fex2d475s84" data-title="iOS-多线程使用总结" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-前端Vue入门总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/17/%E5%89%8D%E7%AB%AFVue%E5%85%A5%E9%97%A8%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2022-05-17T12:46:25.000Z" itemprop="datePublished">2022-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/17/%E5%89%8D%E7%AB%AFVue%E5%85%A5%E9%97%A8%E6%80%BB%E7%BB%93/">前端Vue入门总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>在目前的互联网大环境下，如果只有一门技术傍身，不足以胜任市场对研发的要求，于是想学习大前端技术栈。笔者接触前端是从开发微信小程序开始的，它的数据双向绑定机制，让写习惯了客户端的我叹为观止。目前我入门前端的技术路径是：客户端—微信小程序—混合AppH5开发—Web前端。一些我自己的经验总结出来，希望对你有所帮助。当然阅读这篇文章的前提是，你已经了解了基本的Html、CSS、JS语法。</p>
<h3 id="二-环境与工具"><a href="#二-环境与工具" class="headerlink" title="二. 环境与工具"></a>二. 环境与工具</h3><h4 id="1-前端环境搭建"><a href="#1-前端环境搭建" class="headerlink" title="1. 前端环境搭建"></a>1. 前端环境搭建</h4><p> 笔者使用的Mac电脑，所有的环境搭建工作都是基于Mac电脑来操作的。首先安装<code>node.js</code>与<code>npm</code>: </p>
<h5 id="node-js"><a href="#node-js" class="headerlink" title="node.js"></a><code>node.js</code></h5><p><code>node</code> 是一个基于 V8 引擎的 Javascript 运行环境，它使得 Javascript 可以运行在服务端，直接与操作系统进行交互，与文件控制、网络交互、进程控制等。简单的说node.js就是运行在服务端的 JavaScript。你可能会有疑问，我写前端页面为甚么需要一个运行在服务端的的JS环境。其实我们这里使用<code>node</code>最关键是需要安装<code>npm</code>. </p>
<h5 id="npm"><a href="#npm" class="headerlink" title="npm"></a><code>npm</code></h5><p><code>npm</code>是node.js的包管理工具（package manager），为啥我们需要一个包管理工具呢？因为我们在Web开发时，会用到很多别人写的JavaScript代码。如果我们要使用别人写的某个包，每次都根据名称搜索一下官方网站，下载代码、解压、再使用，非常繁琐。于是一个集中管理的工具应运而生：大家都把自己开发的模块打包后放到npm官网上，如果要使用，直接通过npm安装就可以直接用。他类似于iOS开发中的<code>Cocoapods</code>,Android开发中的<code>Maven</code>,这样就好理解了。<br><code>node</code>下载地址点击<a target="_blank" rel="noopener" href="https://nodejs.org/en/download/">这里</a>,按照步骤安装完成后，终端输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<p>查看安装版本，出现下面的版本号说明安装成功。<br><img src="https://i.loli.net/2021/11/10/YtBAx7QXrlZomia.png" alt="node"></p>
<blockquote>
<p>注意如果提示<code>-bash: node: command not found</code>,说明还需要配置一下环境变量。配置方式也很简单，在Finder中查找文件夹，输入路径<code>/private/etc</code>,找到<code>profile</code>文件，加上一下语句</p>
</blockquote>
<p><img src="https://i.loli.net/2021/11/10/ruPpjdZT36oUQXe.png" alt="pic"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NODE_HOME=<span class="string">&quot;node安装路径(bin路径的父级路径)&quot;</span> </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$NODE_HOME</span>/bin</span><br></pre></td></tr></table></figure>
<p><code>node</code>安装路径(bin路径的父级路径):你可以通过命令<code>which node</code> 命令来查看。例如我的本地路径是<code>/usr/local/bin/node</code>，那么可以这样设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NODE_HOME=<span class="string">&quot;/usr/local&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$NODE_HOME</span>/bin</span><br></pre></td></tr></table></figure>
<p>重新保存文件后，再次输入<code>node -v</code> 验证一下。下面是一些<code>npm</code>常用命令：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 本地安装模块</span></span><br><span class="line">npm install &lt;<span class="title class_">Module</span> <span class="title class_">Name</span>&gt;</span><br><span class="line"><span class="comment">// 全局安装模块</span></span><br><span class="line">npm install &lt;<span class="title class_">Module</span> <span class="title class_">Name</span>&gt; -g</span><br><span class="line"><span class="comment">// 搜索模块</span></span><br><span class="line">npm search  &lt;<span class="title class_">Module</span> <span class="title class_">Name</span>&gt;</span><br><span class="line"><span class="comment">// 更新模块</span></span><br><span class="line">npm update &lt;<span class="title class_">Module</span> <span class="title class_">Name</span>&gt;</span><br><span class="line"><span class="comment">//卸载模块</span></span><br><span class="line">npm uninstall &lt;<span class="title class_">Module</span> <span class="title class_">Name</span>&gt;</span><br><span class="line"><span class="comment">// 安装项目的全部依赖</span></span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<h5 id="yarn"><a href="#yarn" class="headerlink" title="yarn:"></a><code>yarn</code>:</h5><p><code>yarn</code>是一个由 Facebook 贡献的 Javascript 包管理器。<code>yarn</code>是为了弥补<code>npm</code>的一些缺陷而出现的。在日常开发中你可以使用<code>npm</code>也可以使用<code>yarn</code>进行包的管理，只不过相比<code>npm</code>而言，它的速度更快，并提供了离线模式。关于它我们不会过多的介绍，你可以去它的<a target="_blank" rel="noopener" href="https://yarn.bootcss.com/">中文网站查看</a>.它的安装方式也很简单，直接通过<code>Homebrew</code>进行安装，命令 <code>brew install yarn</code>. 它的一些常用指令：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化一个新项目</span></span><br><span class="line">yarn init</span><br><span class="line"><span class="comment">// 添加依赖包</span></span><br><span class="line">yarn add [package]</span><br><span class="line"><span class="comment">// 添加依赖包的某个版本</span></span><br><span class="line">yarn add [package]@[version]</span><br><span class="line"><span class="comment">// 升级依赖包</span></span><br><span class="line">yarn upgrade [package]</span><br><span class="line"><span class="comment">// 移除依赖包</span></span><br><span class="line">yarn remove [package]</span><br><span class="line"><span class="comment">// 安装项目的全部依赖</span></span><br><span class="line">yarn install 或者 yarn</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以在项目中混用<code>yarn</code>与<code>npm</code>,但是最好不要这样。</p>
</blockquote>
<h4 id="2-开发工具选择"><a href="#2-开发工具选择" class="headerlink" title="2. 开发工具选择"></a>2. 开发工具选择</h4><p><img src="https://i.loli.net/2021/11/10/2edVWoarEFI3hqc.png" alt="pic1"><br>前端的开发工具基本就两个选择<code>Visual Studio Code</code> 或者 <code>WebStorm</code>,两者选择哪一个都可以，我个人更喜欢<code>Visual Studio Code</code>,其实选择它最主要原因是免费且开源，而且有强大的插件库。</p>
<p><code>VSCode</code>安装插件：<br><img src="https://i.loli.net/2021/11/10/k7JjQaONiLX3duC.png" alt="chanjian"></p>
<p>选择[扩展]-[搜索插件]-安装即可<br>下面是我使用的一些常用的<code>VSCode</code>插件：</p>
<p>(1) <code>vue vscode snippets</code><br>它是Vue项目代码的骨架插件，例如输入<code>vbase</code>,会直接生成以下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    export default &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>相似的还有<code>vdata</code>、<code>vmethod</code>、<code>vfor</code>等操作<br>(2) <code>Auto Close Tag</code> 自动闭合HTML标签<br>(3) <code>Auto Rename Tag</code> 修改HTML标签时，自动修改匹配的标签<br>(4) <code>Color Highlight</code> 颜色值在代码中高亮显示<br>(5) <code>HTML CSS Class Completion</code> CSS class提示插件<br>(6) <code>Vetur</code> Vue多功能集成插件，包括：语法高亮，智能提示，emmet，错误提示，格式化，自动补全，debugger。vscode官方钦定Vue插件，Vue开发者必备<br>(7) <code>VSCode-icons</code> 文件图标，方便定位文件<br>(8) <code>Color Highlight</code> 颜色值在代码中高亮显示<br>(9) <code>HTML CSS Support</code> 智能提示CSS类名以及id<br>(10) <code>Beautify</code> 格式化代码工具,美化javascript，JSON，CSS，Sass，和HTML<br>(11) <code>Open in Browser</code> 直接在浏览器中打开你当前的文件</p>
<h3 id="三-Vue项目搭建与开发事项"><a href="#三-Vue项目搭建与开发事项" class="headerlink" title="三.Vue项目搭建与开发事项"></a>三.Vue项目搭建与开发事项</h3><p>目前前端几大主流框架<code>React</code>、<code>Vue</code>、<code>Angular</code>，三个框架各有优劣，个人感觉<code>Vue</code>的入门难度最小，而且有良好的中文教程和广泛的第三方支持，如果要入门前端技术，从<code>Vue</code>入手是比较明智的。</p>
<h4 id="1-Vue项目搭建"><a href="#1-Vue项目搭建" class="headerlink" title="1.Vue项目搭建"></a>1.Vue项目搭建</h4><p> 使用<code>Vue CLI</code>脚手架构建Vue项目</p>
<h5 id="1-使用-npm-或-yarn-全局安装-Vue-CLI"><a href="#1-使用-npm-或-yarn-全局安装-Vue-CLI" class="headerlink" title="(1). 使用 npm 或 yarn 全局安装 Vue CLI"></a>(1). 使用 npm 或 yarn 全局安装 Vue CLI</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @vue/cli</span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line">yarn global add @vue/cli</span><br></pre></td></tr></table></figure>
<p>如果页面报错如下<br><img src="https://i.loli.net/2021/11/10/nNaUIyz4SseQYFj.png" alt="error"><br>说明执行权限不够，可以在在前面加<code>sudo</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g @vue/cli</span><br></pre></td></tr></table></figure>
<p>执行完成后输入命令<code>vue -V</code>查看Vue&#x2F;Cli 版本，出现如下提示说明安装成功。<br><img src="https://i.loli.net/2021/11/10/ST7sfJjglQRiqnH.png" alt="pic"></p>
<h5 id="2-在工程所在目录创建项目"><a href="#2-在工程所在目录创建项目" class="headerlink" title="(2). 在工程所在目录创建项目"></a>(2). 在工程所在目录创建项目</h5><p>执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vue create my-project</span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line">vue ui</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>vue create</code> 是使用命令行创建项目，<code>vue ui</code>是以图形化界面创建和管理项目。</p>
</blockquote>
<h5 id="3-配置工程"><a href="#3-配置工程" class="headerlink" title="(3). 配置工程"></a>(3). 配置工程</h5><p>输入创建命令后提示：<br><img src="https://i.loli.net/2021/11/10/EYkWr4fGVaxzKN2.png" alt="pic"></p>
<p>此时会判断你的npm&#x2F;yarn源的连接速度，询问你是否切换至淘宝镜像，我们输入<code>n</code>,继续</p>
<p><img src="https://i.loli.net/2021/11/10/eHkg1rnTScWNwUq.png" alt="pic"></p>
<p>提示：项目是使用默认配置（Vue2还是Vue3 都包含babel, eslint)还是手动选择，我们选择手动配置，继续</p>
<p><img src="https://i.loli.net/2021/11/10/nvDGP8U4YO9o6F1.png" alt="pic"></p>
<ul>
<li>Choose Vue version: 选择Vue的版本 选择</li>
<li>Babel :将脚手架中浏览器不认识的一切东西翻译为浏览器认识的 选择 </li>
<li>TypeScript : 强类型的 JaveScript</li>
<li>Progressive Web App (PWA) Support : 渐进式App，主要用于兼容移动端</li>
<li>Router : Vue 路由管理 选择</li>
<li>Vuex: Vue的状态管理器 选择</li>
<li>CSS Pre-processors : CSS 预处理器，可选择使用 less、sass、stylus等预处理器 选择</li>
<li>Linter &#x2F; Formatter :代码检测和格式化</li>
<li>Unit Testing: 单元测试</li>
<li>E2E Testing: 端到端测试<br>选中好后继续<blockquote>
<p>按方向键是进行上下移动，空格是选中&#x2F;取消，回车是确定当前所选内容，继续下一步操作</p>
</blockquote>
</li>
</ul>
<p><img src="https://i.loli.net/2021/11/10/ZpsCIj1zbF4QdLE.png" alt="pic"></p>
<p>提示：选择Vue版本，我们选择Vue3版本，继续</p>
<p><img src="https://i.loli.net/2021/11/10/f4z6ipqFWZOehrb.png" alt="pic"></p>
<p>提示：路由方式是否使用history模式。一般都是单页面开发不选择history，输入<code>n</code>继续</p>
<p><img src="https://i.loli.net/2021/11/10/FJT42kyLUNSqmBp.png" alt="pic"></p>
<p>提示：选择CSS预处理器</p>
<ul>
<li>node-sass 是自动编译，实时的</li>
<li>dart-sass 需要保存后才会生效</li>
<li>Less 最终会通过编译处理输出css到浏览器，Less 既可以在客户端上运行，也可在服务端运行 (借助 node.js)</li>
<li>Stylus 主要用来给<code>node</code>项目进行CSS预处理支持，Stylus功能上更为强壮，和Js联系更加紧密，可创建健壮的、动态的的CSS</li>
</ul>
<p>我们选择 Sass&#x2F;SCSS (with node-sass)，继续</p>
<p><img src="https://i.loli.net/2021/11/10/cMnHVuzxEFPhrja.png" alt="pic"></p>
<p>提示：Babel, ESLint是使用独立文件，还是在package.json一个文件中保存所有配置信息。选择第一个，继续</p>
<p><img src="https://i.loli.net/2021/11/10/TQdX1ukVg2yMrn5.png" alt="pic"></p>
<p>提示：是否为以后创建的项目保存我们当前所选的这些配置，我们选择<code>否</code>,开始自动创建项目</p>
<p><img src="https://i.loli.net/2021/11/10/aUPtNG51bKImMJB.png" alt="pic"></p>
<p>项目创建完成后，cd到当前工程目录下，执行<code>yarn serve</code>,就可以运行当前项目了。</p>
<p><img src="https://i.loli.net/2021/11/10/Dy6GpxAHu1o7TZS.png" alt="pic"></p>
<p>在浏览器中输入上面的地址就可看到我们当前创建的<code>Vue</code>工程了</p>
<p><img src="https://i.loli.net/2021/11/10/PFRNUhJDEWA1fe9.png" alt="pic"></p>
<h4 id="2-Vue基础语法"><a href="#2-Vue基础语法" class="headerlink" title="2.Vue基础语法"></a>2.Vue基础语法</h4><h5 id="1-Vue的基础语法"><a href="#1-Vue的基础语法" class="headerlink" title="(1).Vue的基础语法"></a>(1).Vue的基础语法</h5><p>Vue.js 的核心是一个允许采用简洁的模板语法来声明式地将数据渲染进 DOM 的系统：<br><code>About.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;about&quot;&gt;</span><br><span class="line">    &lt;div&gt;&#123;&#123;counter&#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;button @click=&quot;handleClick&quot;&gt;按钮&lt;/button&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">     &lt;span v-bind:title=&quot;message&quot;&gt;</span><br><span class="line">       鼠标悬停几秒钟查看此处动态绑定的提示信息！</span><br><span class="line">     &lt;/span&gt;</span><br><span class="line">     &lt;div v-if=&quot;isShow&quot;&gt;组件按照条件进行展示&lt;/div&gt;</span><br><span class="line">     &lt;div class=&quot;input-binding&quot;&gt;</span><br><span class="line">       &lt;p&gt;&#123;&#123; inputMsg &#125;&#125;&lt;/p&gt;</span><br><span class="line">       &lt;input v-model=&quot;inputMsg&quot; @input=&quot;handleChange&quot;/&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line">     &lt;div&gt;</span><br><span class="line">       &lt;TodoItem :itemList=&quot;todos&quot;/&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import TodoItem from &#x27;../components/TodoItem.vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;About&#x27;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    TodoItem,</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      counter: 0,</span><br><span class="line">      message: &#x27;鼠标悬停消息&#x27;,</span><br><span class="line">      inputMsg: &#x27;&#x27;,</span><br><span class="line">      isShow: false,</span><br><span class="line">      todos: [</span><br><span class="line">        &#123; text: &#x27;Learn JavaScript&#x27; &#125;,</span><br><span class="line">        &#123; text: &#x27;Learn Vue&#x27; &#125;,</span><br><span class="line">        &#123; text: &#x27;Build something awesome&#x27; &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleClick() &#123;</span><br><span class="line">      console.log(&#x27;handleClick---&gt;&#x27;);</span><br><span class="line">      this.counter += 1;</span><br><span class="line">      this.isShow = !this.isShow;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleChange() &#123;</span><br><span class="line">      console.log(&#x27;---&gt;&#x27;, this.inputMsg);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">.about &#123;</span><br><span class="line">  font-size: 20px;</span><br><span class="line"></span><br><span class="line">  span &#123;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><code>TodoItem.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;todo-item&quot;&gt;</span><br><span class="line">      &lt;ol&gt;</span><br><span class="line">        &lt;li v-for = &quot;(item,index) in itemList&quot; :key=&quot;index&quot; class=&quot;todos&quot;&gt;</span><br><span class="line">          &#123;&#123; item.text &#125;&#125;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">      &lt;/ol&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;TodoItem&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    itemList: &#123;</span><br><span class="line">      type: Array,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">.todos &#123;</span><br><span class="line">  text-align: left;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>Vue 框架将data中的数据和 DOM 进行了关联，所有内容都是响应式的。改变data中返回对象的数据，可以直接在Dom中进行响应。</li>
<li>为了让用户和应用进行交互，我们可以用 <code>v-on</code> 指令添加一个事件监听器，通过它调用在实例中定义的方法,指令<code>v-on</code> 可以简写为<code>@</code>。</li>
<li>使用<code>v-model</code>指令，实现表单输入和应用状态之间的双向绑定。</li>
<li>控制一个元素是否显示使用<code>v-if</code>指令，他可以配合<code>v-else</code>使用，也可以使用<code>v-show</code>指令来控制元素是否显示。</li>
<li><code>v-for</code>指令可以绑定数组的数据,来渲染一个项目列表.使用<code>v-for</code>指令必须设置其<code>key</code>值。<blockquote>
<p>以上只是最基本的<code>Vue</code>语法简介，其他语法比如：组件的生命周期、组件之间的数据传递、事件监听、插槽、动态组件&amp;异步组件、组合式API（setup）的使用等等，需要你去学习官方<a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/guide/composition-api-introduction.html">Vue文档</a></p>
</blockquote>
</li>
</ul>
<h5 id="2-Vue-Router的使用"><a href="#2-Vue-Router的使用" class="headerlink" title="(2).Vue Router的使用"></a>(2).<code>Vue Router</code>的使用</h5><p><code>Vue Router</code> 是 <code>Vue.js</code> 的官方路由。它与<code>Vue.js</code>核心深度集成，让用<code>Vue.js</code>构建单页应用变得轻而易举。<br>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue-router@4</span><br></pre></td></tr></table></figure>
<p>使用<br><code>main.js</code>中挂载router</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span>;</span><br><span class="line"><span class="comment">//创建并挂载根实例,整个应用支持路由。</span></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><code>router/index.js</code>中调用createRouter()</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Home.vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Home&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Home</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;About&#x27;</span>,</span><br><span class="line">    <span class="comment">// route level code-splitting</span></span><br><span class="line">    <span class="comment">// this generates a separate chunk (about.[hash].js) for this route</span></span><br><span class="line">    <span class="comment">// which is lazy-loaded when the route is visited.</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/About.vue&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">  routes,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<p><code>App.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;nav&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/&quot;&gt;Home&lt;/router-link&gt; |</span><br><span class="line">    &lt;router-link to=&quot;/about&quot;&gt;About&lt;/router-link&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;router-view/&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过调用 <code>app.use(router)</code>，我们可以在任意组件中以<code>this.$router</code>的形式访问它，并且以<code>this.$route</code>的形式访问当前路由</li>
<li>我们可以在Dom中使用<code>&lt;router-link to=&quot;/&quot; /&gt;</code>来执行导航跳转，也可以使用编程式导航，<code>router-view</code>将显示与 url 对应的组件。你可以把它放在任何地方，以适应你的布局。</li>
<li>嵌套路由也是我们经常使用的方式，例如<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/detail/:userId&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Detail&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/Detail.vue&#x27;</span>),</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="comment">// 默认显示</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Profile</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;profile&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Profile</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;posts&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Posts</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line"> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<code>Detail.vue</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;router-link :to=&quot;&#x27;/detail/&#x27;+userId+&#x27;/posts&#x27;&quot;&gt;posts&lt;/router-link&gt;|</span><br><span class="line">  &lt;router-link :to=&quot;&#x27;/detail/&#x27;+userId+&#x27;/profile&#x27;&quot;&gt;profile&lt;/router-link&gt;</span><br><span class="line">  &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>跳转到<code>Detail</code>页面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userId = <span class="string">&#x27;1001&#x27;</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">`/detail/<span class="subst">$&#123;userId&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<p>上面的例子中，首先使用了动态路由匹配功能，传递参数<code>userId</code>,此时的路径为<code>/detail/1001</code>,默认展示<code>Profile</code>组件，在<code>Detail</code>页面有两个子路由：<code>Profile</code>和<code>Posts</code>，当点击<code>Link</code>标签时,匹配路径为<code>/detail/1001/profile</code>时候展示<code>Profile</code>,当匹配路径为<code>/detail/1001/posts</code>,展示<code>posts</code>组件，设置<code>path: &#39;&#39;</code>,表示进入<code>/detail/userId</code>页面默认显示的组件。</p>
<ul>
<li>如果你想同时在<code>Detail</code>中显示<code>Profile</code>和<code>Posts</code>两个组件，可以使用命名视图，它主要用于同时 (同级) 展示多个视图，而不是嵌套展示。</li>
</ul>
<p><code>Detail.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;router-link :to=&quot;&#x27;/detail/&#x27;+userId+&#x27;/content&#x27;&quot;&gt;content&lt;/router-link&gt;</span><br><span class="line">  &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;!-- 设置 router-view 的name，在router中进行命名 --&gt;</span><br><span class="line">  &lt;router-view name=&quot;Posts&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p><code>router.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/detail/:userId&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Detail&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/Detail.vue&#x27;</span>),</span><br><span class="line">     <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="comment">// 默认显示</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Profile</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="attr">default</span>: <span class="title class_">Profile</span>,<span class="comment">//默认展示的组件</span></span><br><span class="line">          <span class="title class_">Posts</span>,<span class="comment">// ES6 语法，Posts：Posts</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line"> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>**在 Vue 实例中，你可以通过 <code>$router</code> 访问路由实例。因此你可以调用 <code>this.$router.push()</code>**，当你点击 <code>&lt;router-link&gt;</code> 时，内部会调用这个方法，所以点击 <code>&lt;router-link :to=&quot;...&quot;&gt;</code> 相当于调用 <code>router.push(...)</code> 。</li>
<li>其他语法比如：路由组件传参、导航守卫、过渡动效等，需要你去学习官方<a target="_blank" rel="noopener" href="https://router.vuejs.org/zh/">Vue Router文档</a></li>
</ul>
<h5 id="3-Vuex的使用"><a href="#3-Vuex的使用" class="headerlink" title="(3).Vuex的使用"></a>(3).<code>Vuex</code>的使用</h5><p><code>Vuex</code>是一个专为 Vue.js 应用程序开发的<strong>状态管理模式 + 库</strong>。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。它主要用来解决<strong>多个组件共享状态</strong>的问题。</p>
<p><img src="https://s2.loli.net/2022/04/28/JR5o9UgPHM8t7Dl.png" alt="Pic"></p>
<p><code>Vuex</code> 跟 <code>Redux</code>的数据管理模式很相似，如果理解<code>Redux</code>,那么<code>Vuex</code>也很容易理解了，只不过<code>Vuex</code> 是专门为 Vue.js 设计的状态管理库，使用起来要更加方便。</p>
<ul>
<li><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install vuex@next --save</span><br><span class="line">OR</span><br><span class="line">yarn add vuex@next --save</span><br></pre></td></tr></table></figure>
</li>
<li><p>核心概念</p>
<ul>
<li><p><code>State</code>: 就是组件所依赖的状态对象。我们可以在里面定义我们组件所依赖的数据。可以在Vue组件中通过<code>this.$store.state.XXX</code>获取state里面的数据.</p>
</li>
<li><p><code>Getter</code>:从 <code>store</code> 中的 <code>state</code> 中派生出一些状态，可以把他理解为是<code>store</code>的计算属性.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">todos</span>: [</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">text</span>: <span class="string">&#x27;...&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">text</span>: <span class="string">&#x27;...&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doneTodos</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">todos</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">todo</span> =&gt;</span> todo.<span class="property">done</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>例如我们定义了上面的store，在Vue组价中通过<code>store.getters.doneTodos</code>访问它的<code>getter</code>.</p>
</li>
<li><p><code>Mutation</code>:更改 Vuex 的 store 中状态的唯一方法是提交 mutation，我们通过在mutation中定义方法来改变state里面的数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      <span class="comment">// 变更状态</span></span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在Vue组件中，我们通过<code>store.commit(&#39;increment&#39;)</code>,来提交。<strong>需要注意的是，Mutation 必须是同步函数</strong>。在实际使用中我们一般使用常量替代 Mutation 事件类型。例如上面的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">INCREMENT_MUTATION</span> = <span class="string">&#x27;INCREMENT_MUTATION&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="comment">// 我们可以使用 ES2015 风格的计算属性命名功能来使用一个常量作为函数名</span></span><br><span class="line">    [<span class="variable constant_">INCREMENT_MUTATION</span>] (state) &#123;</span><br><span class="line">      <span class="comment">// 变更状态</span></span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Action:</code> Action 类似于 mutation，不同在于：</p>
<ul>
<li>Action 提交的是 mutation，而不是直接变更状态。</li>
<li>Action 可以包含任意异步操作。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    incrementAsync (&#123; commit &#125;) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;increment&#x27;</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在组件中我们通过<code>store.dispatch(&#39;incrementAsync&#39;)</code>触发action。</p>
</li>
<li><p><code>Module</code>: 当我们的应用较大时，为了避免所有状态会集中到一个比较大的对象中，Vuex 允许我们将 store 分割成<strong>模块（module）</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> moduleA = &#123;</span><br><span class="line"><span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123; ... &#125;),</span><br><span class="line"><span class="attr">mutations</span>: &#123; ... &#125;,</span><br><span class="line"><span class="attr">actions</span>: &#123; ... &#125;,</span><br><span class="line"><span class="attr">getters</span>: &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> moduleB = &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123; ... &#125;),</span><br><span class="line">  <span class="attr">mutations</span>: &#123; ... &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">a</span>: moduleA,</span><br><span class="line">    <span class="attr">b</span>: moduleB</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>在Vue组件中我们使用<code>store.state.a, store.state.b </code>来分别获取两个模块的状态.</p>
<p>更多关于<code>Vuex</code>的用法：辅助函数（mapState、mapGetters、mapMutations、mapActions）、命名空间、组合式API中调用等可以阅读<a target="_blank" rel="noopener" href="https://vuex.vuejs.org/zh/">[Vuex]文档</a>.</p>
<h4 id="3-第三方库使用总结"><a href="#3-第三方库使用总结" class="headerlink" title="3.第三方库使用总结"></a>3.第三方库使用总结</h4><h5 id="1-移动Web布局库"><a href="#1-移动Web布局库" class="headerlink" title="(1).移动Web布局库"></a>(1).移动Web布局库</h5><p>我们在进行移动Web页面开发时，需要对页面进行布局，常用的布局方式有用rem来作单位，配合h5新的meta属性来适配屏幕做开发的，也有直接使用三方库<code>postcss-px-to-viewport</code>来进行页面布局的。我们直接使用第二种方式：<br>使用yarn进行安装,cd 到工程目录后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add -D postcss-px-to-viewport</span><br></pre></td></tr></table></figure>
<p>执行完成后，在<code>postcss.config.js</code>中进行参数配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: &#123;<span class="string">&#x27;postcss-px-to-viewport&#x27;</span>: &#123;</span><br><span class="line">    <span class="attr">unitToConvert</span>: <span class="string">&#x27;px&#x27;</span>,<span class="comment">// 要转化的单位</span></span><br><span class="line">    <span class="attr">viewportWidth</span>: <span class="number">375</span>,<span class="comment">// UI设计稿的宽度</span></span><br><span class="line">    <span class="attr">unitPrecision</span>: <span class="number">5</span>,<span class="comment">// 转换后的精度，即小数点位数</span></span><br><span class="line">    <span class="attr">propList</span>: [<span class="string">&#x27;!*&#x27;</span>],<span class="comment">// 指定转换的css属性的单位，*代表全部css属性的单位都进行转换</span></span><br><span class="line">    <span class="attr">viewportUnit</span>: <span class="string">&#x27;vw&#x27;</span>,<span class="comment">// 指定需要转换成的视窗单位，默认vw</span></span><br><span class="line">    <span class="attr">fontViewportUnit</span>: <span class="string">&#x27;vw&#x27;</span>,<span class="comment">// 指定字体需要转换成的视窗单位，默认vw</span></span><br><span class="line">    <span class="attr">selectorBlackList</span>: [],<span class="comment">// 指定不转换为视窗单位的类名，</span></span><br><span class="line">    <span class="attr">minPixelValue</span>: <span class="number">1</span>,<span class="comment">// 默认值1，小于或等于1px则不进行转换</span></span><br><span class="line">    <span class="attr">mediaQuery</span>: <span class="literal">false</span>,<span class="comment">// 是否在媒体查询的css代码中也进行转换，默认false</span></span><br><span class="line">    <span class="attr">replace</span>: <span class="literal">true</span>,<span class="comment">// 是否转换后直接更换属性值</span></span><br><span class="line">    <span class="attr">exclude</span>: [],<span class="comment">// 设置忽略文件，用正则做目录名匹配</span></span><br><span class="line">    <span class="attr">landscape</span>: <span class="literal">false</span>,<span class="comment">// 是否处理横屏情况</span></span><br><span class="line">    <span class="attr">landscapeUnit</span>: <span class="string">&#x27;vw&#x27;</span>,<span class="comment">//横屏单位</span></span><br><span class="line">    <span class="attr">landscapeWidth</span>: <span class="number">568</span><span class="comment">//横屏宽度</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-UI库"><a href="#2-UI库" class="headerlink" title="(2). UI库"></a>(2). UI库</h5><p><img src="https://i.loli.net/2021/11/10/rkTnEjFPyeB82Al.png" alt="pic"></p>
<p>在进行移动Web开发中，第三方UI库的使用是少不了的，我们最常用的有<code>vant</code>、<code>Element UI</code>等，我们以<code>vant</code>来说明,进行工程目录执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Vue 2 项目，安装 Vant 2：</span></span><br><span class="line">npm i vant -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># Vue 3 项目，安装 Vant 3：</span></span><br><span class="line">npm i vant@next -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 yarn 安装vant3</span></span><br><span class="line">yarn add vant@next</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意对于Vue2和Vue3项目引入方式是不一样的，我们是Vue3项目，因此执行<code>npm i vant@next -S</code>或者<code>yarn add vant@next</code></p>
</blockquote>
<p>安装完成后就可以引入组件了，也需要注意，Vue2与Vue3的配置方式也是不同的，具体可以去查看<a target="_blank" rel="noopener" href="https://youzan.github.io/vant/#/zh-CN/quickstart">Vant官网</a>查看，这里不在赘述。</p>
<h5 id="3-网络请求库"><a href="#3-网络请求库" class="headerlink" title="(3). 网络请求库"></a>(3). 网络请求库</h5><p>在项目中进行网络请求时，最常用的第三方库是<code>axios</code>,他的引入方式也很简单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm install axios</span><br><span class="line">OR </span><br><span class="line">$ yarn add axios</span><br></pre></td></tr></table></figure>
<p>对于Vue2项目而言安装完成后在mian.js中引用axios，并绑到原型链上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> ‘axios’</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$http</span> = axios</span><br></pre></td></tr></table></figure>
<p>它的用法很简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get请求</span></span><br><span class="line">axios.<span class="title function_">get</span>(<span class="string">&#x27;/user?ID=12345&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">// post 请求</span></span><br><span class="line">axios.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&#x27;Fred&#x27;</span>,</span><br><span class="line">    <span class="attr">lastName</span>: <span class="string">&#x27;Flintstone&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">// 执行多个并发请求</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getUserAccount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;/user/12345&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getUserPermissions</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;/user/12345/permissions&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">axios.<span class="title function_">all</span>([<span class="title function_">getUserAccount</span>(), <span class="title function_">getUserPermissions</span>()])</span><br><span class="line">  .<span class="title function_">then</span>(axios.<span class="title function_">spread</span>(<span class="keyword">function</span> (<span class="params">acct, perms</span>) &#123;</span><br><span class="line">    <span class="comment">// 两个请求现在都执行完成</span></span><br><span class="line">  &#125;));</span><br></pre></td></tr></table></figure>
<p>但是对于Vue3项目而言，除了引入<code>axios</code>外，还需要引入<code>vue-axios</code>,引入方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save axios vue-axios</span><br></pre></td></tr></table></figure>

<p><code>vue-axios</code>是将axios集成到Vue.js的小包装器，可以像插件一样进行安装。在mian.js中引用axios，vue-axios，通过全局方法<code>Vue.use()</code>使用插件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueAxios</span> <span class="keyword">from</span> <span class="string">&#x27;vue-axios&#x27;</span><span class="comment">// Vue3 使用 axios 需要配合 vue-axios 一起使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建并挂载根实例</span></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(<span class="title class_">VueAxios</span>, axios).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">getList</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">axios</span>.<span class="title function_">get</span>(api).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// or</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">get</span>(api).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-项目中的矢量图片使用"><a href="#4-项目中的矢量图片使用" class="headerlink" title="(4).项目中的矢量图片使用"></a>(4).项目中的矢量图片使用</h5><p>在开发项目时，免不了要使用到图片，目前项目常用的矢量图片库非阿里的<code>iconfont</code>莫属了，它最大的好处是你可以像调整文字一样，设置图片的颜色和大小，而不用担心图片失真问题。它的使用方式也很简单：<br>把我们要使用的图片添加到项目中，然后点击下载到本地<br><img src="https://i.loli.net/2021/11/10/r5BnDHy1XCfsGYE.png" alt="pic"><br>它有三种引入方式分别是：<code>unicode 引用</code>、<code>font-class 引用</code>、<code>symbol 引用</code>,我们只介绍<code>symbol 引用</code>,这也是官方最推荐的引用方式，相比前两种有如下特点：</p>
<ul>
<li>支持多色图标了，不再受单色限制。</li>
<li>通过一些技巧，支持像字体那样，通过font-size,color来调整样式。</li>
<li>兼容性较差，支持 ie9+,及现代浏览器。</li>
<li>浏览器渲染svg的性能一般，还不如png。<br>使用步骤如下：</li>
</ul>
<h6 id="第一步：拷贝下载文件iconfont-js到项目目录"><a href="#第一步：拷贝下载文件iconfont-js到项目目录" class="headerlink" title="第一步：拷贝下载文件iconfont.js到项目目录"></a>第一步：拷贝下载文件<code>iconfont.js</code>到项目目录</h6><p>在需要用到iconfont 的地方引入这个js文件目录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../utils/iconfont&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h6 id="第二步：加入通用css代码（引入一次就行）"><a href="#第二步：加入通用css代码（引入一次就行）" class="headerlink" title="第二步：加入通用css代码（引入一次就行）"></a>第二步：加入通用css代码（引入一次就行）</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">    <span class="selector-class">.icon</span> &#123;</span><br><span class="line">       <span class="attribute">width</span>: <span class="number">1em</span>; <span class="attribute">height</span>: <span class="number">1em</span>;</span><br><span class="line">       <span class="attribute">vertical-align</span>: -<span class="number">0.15em</span>;</span><br><span class="line">       fill: currentColor;</span><br><span class="line">       <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h6 id="第三步：挑选相应图标并获取类名，应用于页面："><a href="#第三步：挑选相应图标并获取类名，应用于页面：" class="headerlink" title="第三步：挑选相应图标并获取类名，应用于页面："></a>第三步：挑选相应图标并获取类名，应用于页面：</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg class=&quot;<span class="attribute">icon</span>&quot; aria-hidden=&quot;true&quot;&gt;</span><br><span class="line">    &lt;use xlink:href=<span class="string">&quot;#icon-xxx&quot;</span>&gt;&lt;/use&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>#icon-xxx</code> 就是你选的图片类名<br>如果要调整大小、颜色、位置等</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.icon</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">  <span class="attribute">position</span>:relative;</span><br><span class="line">  <span class="attribute">display</span>:inline-block;</span><br><span class="line">  <span class="attribute">top</span>: <span class="built_in">calc</span>(<span class="number">12px</span> + <span class="number">0.15rem</span>);</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">6px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：加入的图片最好是去掉填充色的,然后你才能修改颜色,否则设置颜色不生效。</p>
</blockquote>
<h4 id="4-项目上线"><a href="#4-项目上线" class="headerlink" title="4.项目上线"></a>4.项目上线</h4><p>开发完成后，需要将项目进行上线，我们知道，客户端开发完成后，将打包好的apk或ipa包发布到对应的平台就好了，前端开发完成后也需要将代码进行编译打包。执行命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line">OR</span><br><span class="line">yarn build</span><br></pre></td></tr></table></figure>

<p>打包完成后，会在项目所在目录下生成<code>dist</code>文件夹，将其发给后端小伙伴就可以了。如果你没有配合的后端，或是想发布一个自己专属的网站，那么你大概需要以下步骤：</p>
<ul>
<li>购买云端服务器（阿里云、腾讯云、华为云）</li>
<li>对服务进行一些基本操作与 nginx 配置，可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011068996/article/details/98964277">CentOS（7.6）基本操作与Nginx配置</a></li>
<li>通过 <code>scp</code> 命令将<code>dist</code>文件夹上传到服务，完成后用服务IP可以访问到我们的网站了</li>
<li>购买域名(域名注册)</li>
<li>对域名进行实名认证 +备案</li>
<li>对域名进行解析 (IP 与 域名绑定) ，完成后通过域名可以访问到网站了</li>
<li>借助CDN对网站访问速度进行加速</li>
</ul>
<h3 id="四-总结"><a href="#四-总结" class="headerlink" title="四.总结"></a>四.总结</h3><p>做前端开发这段时间给我的感觉是，入门相对简单，但如果想精通，那确实需要认真学习不断沉淀。有时候接触的知识越多，越感觉自己的浅薄，这篇文章只是给想学习前端开发的同学一点思路，让你在学习繁杂的前端知识时不至于迷失方向。当然海量的知识这里是没涉及的，比如：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015088834?utm_source=tag-newest">Webpack原理</a>、<a href="%5Bzhuanlan.zhihu.com/p/47407398%5D(https://zhuanlan.zhihu.com/p/47407398)">浏览器的基本工作原理</a>、<a target="_blank" rel="noopener" href="https://zhongsp.gitbooks.io/typescript-handbook/content/">TypeScript</a>、<a href="%5Bzhuanlan.zhihu.com/p/43249121%5D(https://zhuanlan.zhihu.com/p/43249121)">babel</a>、<a target="_blank" rel="noopener" href="https://github.com/nqdeng/7-days-nodejs">Node.js</a>、<a target="_blank" rel="noopener" href="https://github.com/ljianshu/Blog/issues/56"><code>Web</code>安全攻防</a>、<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903793918738440">前端开发者必备的Nginx知识</a>、<code>Canvas API</code>、<code>SVG</code>等绘制高性能的动画、虚拟Dom与Diff算法等等，只能说革命尚未成功，同志仍需努力啊！</p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/guide/component-template-refs.html">Vue 中文文档</a><br><a target="_blank" rel="noopener" href="https://github.com/evrone/postcss-px-to-viewport/blob/HEAD/README_CN.md">postcss-px-to-viewport</a><br><a target="_blank" rel="noopener" href="https://element.eleme.cn/#/zh-CN">element UI</a><br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/yunye/axios/234845">axios</a><br><a target="_blank" rel="noopener" href="https://www.iconfont.cn/?spm=a313x.7781069.1998910419.d4d0a486a">iocnfont</a><br><a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/">https://v3.cn.vuejs.org/</a><br><a target="_blank" rel="noopener" href="https://cli.vuejs.org/zh/guide/">https://cli.vuejs.org/zh/guide/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/05/17/%E5%89%8D%E7%AB%AFVue%E5%85%A5%E9%97%A8%E6%80%BB%E7%BB%93/" data-id="cllnfb8pb000f3fexevpf3yyp" data-title="前端Vue入门总结" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-React-Redux与Vuex使用对比" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/09/React-Redux%E4%B8%8EVuex%E4%BD%BF%E7%94%A8%E5%AF%B9%E6%AF%94/" class="article-date">
  <time class="dt-published" datetime="2022-05-09T12:46:25.000Z" itemprop="datePublished">2022-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/09/React-Redux%E4%B8%8EVuex%E4%BD%BF%E7%94%A8%E5%AF%B9%E6%AF%94/">Web开发-React-Redux与Vuex使用对比</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p><code>React</code>与<code>Vue</code>是我们熟悉的两大前端主流框架，来自官方的解释,<strong>Vue是一套用于构建用户界面的渐进式框架</strong>,<strong>React是一个用于构建用户界面的JavaScript库</strong>,两个框架都使用各自的语法，专注于用户UI界面的构建.那我们会有疑问，这两个框架都专注于UI界面的构建，但是随着JavaScript单页应用开发日趋复杂，我们如何进行更多数据的管理呢？比如网络请求的数据、缓存数据、本地生成尚未持久化到服务器的数据，UI状态数据，激活的路由，被选中的标签等等. 基于上面的疑问，两个框架都有各自的解决方案：<code>React-Redux</code>与<code>Vuex</code>.</p>
<h3 id="二-使用"><a href="#二-使用" class="headerlink" title="二.使用"></a>二.使用</h3><h4 id="1-Redux"><a href="#1-Redux" class="headerlink" title="1.Redux"></a>1.Redux</h4><p>使用<code>react-redux</code>之前我们先来了解一下<code>Redux</code>。<code>Redux</code>是 JavaScript 状态容器，提供可预测化的状态管理，<code>Redux</code>由<code>Flux</code>演变而来,当然除了和<code>React</code>一起用外，还支持其它界面库，不过我们这里主要介绍它配合React进行使用.先来了解下它的几个核心概念：</p>
<h5 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="(1) 核心概念"></a>(1) 核心概念</h5><ul>
<li><p><code>State</code>: 所谓的<code>state</code>就是<code>React</code>组件所依赖的状态对象。你可以在里面定义任何组件所依赖的状态。比如一个简单的<code>todo</code>应用的state可能是这样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">todos</span>: [&#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;Eat food&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">true</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;Exercise&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">visibilityFilter</span>: <span class="string">&#x27;SHOW_COMPLETED&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>Action</code>: <code>action</code>就是一个普通JavaScript对象,用来描述发生了什么.比如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;ADD_TODO&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;Go to swimming pool&#x27;</span> &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;TOGGLE_TODO&#x27;</span>, <span class="attr">index</span>: <span class="number">1</span> &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;SET_VISIBILITY_FILTER&#x27;</span>, <span class="attr">filter</span>: <span class="string">&#x27;SHOW_ALL&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>
<p>你可以把<code>action</code>理解为一个描述发生了什么的指示器。在实际应用中，我们会<code>dispatch(action)</code>,通过派发action来达到修改state的目的。这样做的好处是可以清晰地知道应用中到底发生了什么。</p>
</li>
<li><p><code>Reducer</code>:<code>reducer</code>的作用是用来初始化整个<code>Store</code>，并且串起<code>state</code>与<code>action</code>, 它是一个接收<code>state</code>和<code>action</code>并返回新<code>state</code>的函数.我们可以通过区分不通的action类型，来处理并返回不同的state.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">StoreAction</span> = (<span class="params">state = defaultState,action</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">HOME_ACTION_UPDATE_STATE</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;...state,...action.<span class="property">data</span>&#125;;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">ADD_ARTICLELIST_STATE</span>:</span><br><span class="line">            <span class="keyword">let</span> newState = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state));<span class="comment">/// 深拷贝</span></span><br><span class="line">            newState.<span class="property">articleList</span> = newState.<span class="property">articleList</span>.<span class="title function_">concat</span>(action.<span class="property">data</span>);</span><br><span class="line">            <span class="keyword">return</span> newState;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="2-使用原则"><a href="#2-使用原则" class="headerlink" title="(2) 使用原则"></a>(2) 使用原则</h5><p>使用<code>Redux</code>进行数据管理时有三个原则需要注意</p>
<ul>
<li><p><strong>单一数据源</strong><br>整个应用的<code>state</code>被储存在一棵<code>object tree</code>中，并且这个<code>object tree</code>只存在于唯一一个<code>store</code>中。</p>
</li>
<li><p><strong><code>State</code> 是只读的</strong><br>唯一改变<code>state</code>的方法就是触发<code>action</code>，<code>action</code>是一个用于描述已发生事件的普通对象。</p>
</li>
<li><p><strong>使用纯函数来执行修改</strong><br>我们通过reducer接收先前的<code>state</code>和<code>action</code>，并返回新的<code>state</code>, <code>Reducer</code>必须是一个纯函数，所谓的纯函数就是一个函数的返回结果只依赖于它的参数，并且在执行过程中没有副作用。</p>
</li>
</ul>
<h5 id="3-React-Redux"><a href="#3-React-Redux" class="headerlink" title="(3)React Redux"></a>(3)<code>React Redux</code></h5><p><code>react-redux</code>是<code>Redux</code>官方提供的<code>React</code>绑定库.他的使用也遵循上面的redux原则。</p>
<ul>
<li><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save react-redux</span><br></pre></td></tr></table></figure></li>
<li><p>流程<br><img src="https://s2.loli.net/2022/05/09/xdJ5G67N9LDEPeC.png" alt="pic"><br>通过上面的流程图可以很清晰的明确<code>Redux</code>的使用：</p>
<blockquote>
<p><code>React组件</code>首先调用<code>ActionCreators</code>里事先定义好的方法，得到一个<code>actoion</code>,通过<code>dispatch(action)</code>达到派发<code>action</code>给<code>Reducer</code>的目的。<code>Reducer</code>通过接受的不同的<code>action</code>来对<code>state</code>数据进行处理，处理完成后，返回一个新的<code>state</code>,<code>state</code>变化后<code>React组件</code>进行重新渲染。</p>
</blockquote>
</li>
<li><p>使用</p>
<ul>
<li><p>入口文件index.js</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Provider</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> todoApp <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./components/App&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> store = <span class="title function_">createStore</span>(todoApp)</span><br><span class="line"></span><br><span class="line"><span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span>,</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


</li>
<li><p>创建store&#x2F;reducer.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">ADD_TODO_LIST_VALUE</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./actionTypes&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 初始化数据</span></span><br><span class="line"><span class="keyword">const</span> defaultState = &#123;</span><br><span class="line">    <span class="attr">todos</span>: [&#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;Eat food&#x27;</span>,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">true</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;Exercise&#x27;</span>,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">false</span></span><br><span class="line">      &#125;],</span><br><span class="line">      <span class="attr">visibilityFilter</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// Reducer 可以接受state，但是不能修改State ！</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (state = defaultState , action) =&gt; &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">ADD_TODO_LIST_VALUE</span>:</span><br><span class="line">        <span class="keyword">const</span> newState = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state));<span class="comment">///将原来的state 做一次深拷贝</span></span><br><span class="line">        newState.<span class="property">todos</span>.<span class="title function_">push</span>(action.<span class="property">value</span>);</span><br><span class="line">        <span class="keyword">return</span> newState;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据<code>reducer</code>创建store&#x2F;index.js,</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore,compose,applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>actionCreators</code>store&#x2F;actionCreators.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">ADD_TODO_LIST_VALUE</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./actionTypes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">addItemListAction</span> = (<span class="params">value</span>) =&gt; (&#123;</span><br><span class="line">      <span class="attr">type</span>:<span class="variable constant_">ADD_TODO_LIST_VALUE</span>,</span><br><span class="line">      value</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>actionTypes</code>专门用来存储<code>action</code>的type值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ADD_TODO_LIST_VALUE</span> = <span class="string">&#x27;add_todo_list_value&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>React组件中使用</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; addItemListAction &#125; <span class="keyword">from</span> <span class="string">&#x27;../pages/home/store/actionCreators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Customtodolist</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;todo-list&#x27;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>&#123;this.props.addListItem()&#125;&#125;&gt;</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  &#123; </span></span><br><span class="line"><span class="language-xml">                    this.props.todos.map((item,index) =&gt; </span></span><br><span class="line"><span class="language-xml">                      <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span>&#123;index&#125;:&#123;item&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    )</span></span><br><span class="line"><span class="language-xml">                  &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = (<span class="params">state</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">todos</span>: state.<span class="property">todos</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapDispatchToProps</span> = (<span class="params">dispatch</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">addListItem</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> item = &#123;<span class="attr">text</span>: <span class="string">&#x27;Eat food&#x27;</span>,<span class="attr">completed</span>: <span class="literal">true</span>&#125;</span><br><span class="line">            <span class="keyword">const</span> actionCreator = <span class="title function_">addItemListAction</span>(item);</span><br><span class="line">            <span class="title function_">dispatch</span>(actionCreator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">connect</span>(mapStateToProps, mapDispatchToProps)(<span class="title class_">Customtodolist</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们通过<code>react-redux</code>的<code>connect</code>方法，将mapStateToProps与mapDispatchToProps 方法与组件链接，然后直接在类组件中通过<code>this.props.XXX</code>的方式进行访问Store中的state.</p>
</blockquote>
</li>
<li><p><code>React hooks</code>中使用</p>
   <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// hooks 中使用react-redux</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Home</span> = (<span class="params">props</span>)=&gt; &#123;</span><br><span class="line">    <span class="comment">// hook 获取store state 方式</span></span><br><span class="line">    <span class="keyword">const</span> storeCount = <span class="title function_">useSelector</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">home</span>.<span class="property">count</span>);</span><br><span class="line">    <span class="comment">// 获取actionCreator方法</span></span><br><span class="line">    <span class="keyword">const</span> dispatch = <span class="title function_">useDispatch</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;style[</span>&#x27;<span class="attr">home-content</span>&#x27;]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;home-content-detail&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              StoreCount数据展示&#123;storeCount&#125;</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/* addStoreCount是在actionCreators中定义的方法 */&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> &#123;dispatch(addStoreCount(0))&#125;&#125;&gt;点击storeCount+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>redux-thunk</code>的使用</p>
<p><code>redux-thunk</code>是<code>redux</code>的<a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-thunk">中间件</a>.他的主要作用是可以使用异步派发action。例如我们要进行网络请求，那么可以在<code>actionCreators</code>里面异步派发action.</p>
<p>安装与使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save redux-thunk</span><br></pre></td></tr></table></figure>

<p>(1).在store&#x2F;index.js 中添加引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&quot;redux-thunk&quot;</span>;<span class="comment">/// redux-thunk 中间件 需要引入的</span></span><br></pre></td></tr></table></figure>

<p>(2). 使用<code>thunk</code>初始化<code>store</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 下面的代码是固定写法 /// redux-thunk 中间件 需要引入的</span></span><br><span class="line"><span class="keyword">const</span> composeEnhancers =</span><br><span class="line">  <span class="keyword">typeof</span> <span class="variable language_">window</span> === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">__REDUX_DEVTOOLS_EXTENSION_COMPOSE__</span> ?   </span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">__REDUX_DEVTOOLS_EXTENSION_COMPOSE__</span>(&#123;</span><br><span class="line">    &#125;) : compose;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 中间件都需要用这个方法</span></span><br><span class="line"><span class="keyword">const</span> enhancer = <span class="title function_">composeEnhancers</span>(</span><br><span class="line">    <span class="title function_">applyMiddleware</span>(thunk),<span class="comment">/// redux-thunk 中间件 需要引入的</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">/// 创建</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(</span><br><span class="line">    reducer,</span><br><span class="line">    enhancer<span class="comment">//使用Redux-thunk 中间件</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>(3).在<code>actionCreater.js</code> 中添加异步派发函数，注意：在获取到异步处理的结果后，我们任然需要调用<code>actionCreater.js</code>中的其他创建action方法，来对其进行<code>dispatch</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">initListAction</span> = (<span class="params">data</span>) =&gt; (&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="variable constant_">INIT_LIST_ACTION</span>,</span><br><span class="line">    data</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 将异步请求 放在 Action 中执行</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getToList</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">   <span class="comment">/// 这里返回一个函数,能获取到 dispatch 方法 这就是 redux-thunk 的作用，可以返回一个函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">        axios.<span class="title function_">get</span>(<span class="string">&#x27;/api/todolist&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// alert(res.data);</span></span><br><span class="line">            <span class="keyword">const</span> data = res.<span class="property">data</span>;</span><br><span class="line">            <span class="keyword">const</span> action = <span class="title function_">initListAction</span>(data);</span><br><span class="line">            <span class="title function_">dispatch</span>(action);</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;网络请求错误了---thunk----》&#x27;</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>reducer</code>的拆分与合并</p>
<p>随着项目功能模块越来越多，如果只有一个<code>reducer</code>来维护<code>state</code>，会使其变动越来越大，从而导致难以维护。<code>combineReducer</code>应运而生， 它将根<code>reducer</code>分拆成多个 <code>reducer</code>，拆分之后的 <code>reducer</code> 都是相同的结构（state, action），并且每个函数独立负责管理该特定切片 state 的更新。多个拆分之后的<code>reducer</code>可以响应一个 action，在需要的情况下独立的更新他们自己的切片 state，最后组合成新的 state。</p>
<p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;<span class="comment">/// 将小的Reducer 合并成大的reducers</span></span><br><span class="line"><span class="comment">/// 需要拆分 </span></span><br><span class="line"><span class="keyword">import</span> headerReducer <span class="keyword">from</span> <span class="string">&#x27;../common/header/store/reducer&#x27;</span></span><br><span class="line"><span class="keyword">import</span> mainReducer <span class="keyword">from</span> <span class="string">&#x27;./mainReducer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;reducer <span class="keyword">as</span> homeReducer&#125; <span class="keyword">from</span> <span class="string">&#x27;../pages/home/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;reducer <span class="keyword">as</span> loginReducer&#125; <span class="keyword">from</span> <span class="string">&#x27;../pages/login/store&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进行 reducer的合并</span></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="title function_">combineReducers</span>(&#123;</span><br><span class="line">    <span class="attr">header</span>:headerReducer,</span><br><span class="line">    <span class="attr">main</span>:mainReducer,</span><br><span class="line">    <span class="attr">login</span>:loginReducer,</span><br><span class="line">    <span class="attr">home</span>:homeReducer,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer;</span><br></pre></td></tr></table></figure>

<p>在<code>react</code>组件中使用，要加上reducer名称,例如我们在<code>Home</code>组件中这样获取其state</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = (<span class="params">state, ownProps</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">showScroll</span>: state.<span class="property">home</span>.<span class="property">showScroll</span>,<span class="comment">//state后面添加reducer名称</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-Vuex"><a href="#2-Vuex" class="headerlink" title="2.Vuex"></a>2.Vuex</h4><p><code>Vuex</code>是一个专为 Vue.js 应用程序开发的<strong>状态管理模式 + 库</strong>。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。它主要用来解决<strong>多个组件共享状态</strong>的问题。</p>
<p><img src="https://s2.loli.net/2022/04/28/JR5o9UgPHM8t7Dl.png" alt="Pic"></p>
<p><code>Vuex</code> 跟 <code>Redux</code>的数据管理模式很相似，如果理解<code>Redux</code>,那么<code>Vuex</code>也很容易理解了，只不过<code>Vuex</code> 是专门为 Vue.js 设计的状态管理库，使用起来要更加方便。</p>
<h5 id="1-核心概念-1"><a href="#1-核心概念-1" class="headerlink" title="(1) 核心概念"></a>(1) 核心概念</h5><ul>
<li><p><code>State</code>: 就是组件所依赖的状态对象。我们可以在里面定义我们组件所依赖的数据。可以在Vue组件中通过<code>this.$store.state.XXX</code>获取state里面的数据.</p>
</li>
<li><p><code>Getter</code>:从 <code>store</code> 中的 <code>state</code> 中派生出一些状态，可以把他理解为是<code>store</code>的计算属性.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">todos</span>: [</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">text</span>: <span class="string">&#x27;...&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">text</span>: <span class="string">&#x27;...&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doneTodos</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">todos</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">todo</span> =&gt;</span> todo.<span class="property">done</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>例如我们定义了上面的store，在Vue组价中通过<code>store.getters.doneTodos</code>访问它的<code>getter</code>.</p>
</li>
<li><p><code>Mutation</code>:更改 Vuex 的 store 中状态的唯一方法是提交 mutation，我们通过在mutation中定义方法来改变state里面的数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      <span class="comment">// 变更状态</span></span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在Vue组件中，我们通过<code>store.commit(&#39;increment&#39;)</code>,来提交。<strong>需要注意的是，Mutation 必须是同步函数</strong>。在实际使用中我们一般使用常量替代 Mutation 事件类型。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">INCREMENT_MUTATION</span> = <span class="string">&#x27;INCREMENT_MUTATION&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="comment">// 我们可以使用 ES2015 风格的计算属性命名功能来使用一个常量作为函数名</span></span><br><span class="line">    [<span class="variable constant_">INCREMENT_MUTATION</span>] (state) &#123;</span><br><span class="line">      <span class="comment">// 变更状态</span></span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Action:</code> Action 类似于 Mutation，不同在于：</p>
<ul>
<li>Action 提交的是 mutation，而不是直接变更状态。</li>
<li>Action 可以包含任意异步操作。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      state.<span class="property">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    incrementAsync (&#123; commit &#125;) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;increment&#x27;</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在组件中我们通过<code>store.dispatch(&#39;incrementAsync&#39;)</code>触发action。</p>
</li>
<li><p><code>Module</code>: 当我们的应用较大时，为了避免所有状态会集中到一个比较大的对象中，Vuex 允许我们将 store 分割成<strong>模块（module）</strong>，你可以把它理解为<code>Redux</code>中的<code>combineReducer</code>的作用.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> moduleA = &#123;</span><br><span class="line"><span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123; ... &#125;),</span><br><span class="line"><span class="attr">mutations</span>: &#123; ... &#125;,</span><br><span class="line"><span class="attr">actions</span>: &#123; ... &#125;,</span><br><span class="line"><span class="attr">getters</span>: &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> moduleB = &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123; ... &#125;),</span><br><span class="line">  <span class="attr">mutations</span>: &#123; ... &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">a</span>: moduleA,</span><br><span class="line">    <span class="attr">b</span>: moduleB</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>在Vue组件中我们使用<code>store.state.a, store.state.b </code>来分别获取两个模块的状态.</p>
<h5 id="2-使用"><a href="#2-使用" class="headerlink" title="(2) 使用"></a>(2) 使用</h5><ul>
<li><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install vuex@next --save</span><br><span class="line">OR </span><br><span class="line">yarn add vuex@next --save</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>main.js</code>中挂载store</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>store/index.js</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">ADD_ITEM_LIST</span>, <span class="variable constant_">REDUCE_ITEM_LIST</span>, <span class="variable constant_">CHANGE_ITEM_LIST_ASYNC</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./constants&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">itemList</span>: [</span><br><span class="line">      &#123; <span class="attr">text</span>: <span class="string">&#x27;Learn JavaScript&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">text</span>: <span class="string">&#x27;Learn Vue&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">text</span>: <span class="string">&#x27;Build something awesome&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doneItemList</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">itemList</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">todo</span>) =&gt;</span> todo.<span class="property">done</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="comment">// 使用ES2015风格的计算属性命名功能 来使用一个常量作为函数名</span></span><br><span class="line">    [<span class="variable constant_">ADD_ITEM_LIST</span>](state, item) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;增加数据&#x27;</span>, item);</span><br><span class="line">      state.<span class="property">itemList</span>.<span class="title function_">push</span>(item);</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="variable constant_">REDUCE_ITEM_LIST</span>](state) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;减少数据&#x27;</span>);</span><br><span class="line">      state.<span class="property">itemList</span>.<span class="title function_">pop</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    [<span class="variable constant_">CHANGE_ITEM_LIST_ASYNC</span>](&#123; commit, state &#125;, todoItem) &#123;</span><br><span class="line">      <span class="comment">/// 模拟网络请求</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">commit</span>(<span class="variable constant_">ADD_ITEM_LIST</span>, todoItem);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;state===&#x27;</span>, state);</span><br><span class="line">      &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>注意我们这里仍然使用常量来作<code>actions</code>和<code>mutations</code>的方法名，使用时候要加上<code>[]</code>.</p>
</blockquote>
<ul>
<li><p>在选项式API中使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;about&quot;&gt;</span><br><span class="line">    &lt;div&gt;&#123;&#123;counter&#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;button @click=&quot;handleClick&quot;&gt;按钮&lt;/button&gt;</span><br><span class="line">    &lt;div&gt;     </span><br><span class="line">     &lt;div&gt;</span><br><span class="line">       &lt;TodoItem :itemList=&quot;$store.state.itemList&quot;/&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        完成的Todo</span><br><span class="line">       &lt;TodoItem :itemList=&quot;$store.getters.doneItemList&quot;/&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line">     &lt;div class=&quot;btn-content&quot;&gt;</span><br><span class="line">       &lt;button @click=&quot;addClick&quot;&gt;增加Item&lt;/button&gt;</span><br><span class="line">       &lt;button @click=&quot;reduceClick&quot;&gt;减少Item&lt;/button&gt;</span><br><span class="line">       &lt;button @click=&quot;changeClickAsync&quot;&gt;调用Action&lt;/button&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import TodoItem from &#x27;../components/TodoItem.vue&#x27;;</span><br><span class="line">import &#123;</span><br><span class="line">  ADD_ITEM_LIST, REDUCE_ITEM_LIST, CHANGE_ITEM_LIST_ASYNC,</span><br><span class="line">&#125; from &#x27;../store/constants&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;About&#x27;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    TodoItem,</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      counter: 0,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    todos() &#123;</span><br><span class="line">      return this.$store.getters.doneItemList;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleClick() &#123;</span><br><span class="line">      console.log(&#x27;handleClick---&gt;&#x27;);</span><br><span class="line">      this.counter += 1;</span><br><span class="line">    &#125;,</span><br><span class="line">    addClick() &#123;</span><br><span class="line">      const item = &#123; text: &#x27;add_item_list success!&#x27;, done: true &#125;;</span><br><span class="line">      /// 提交mutations</span><br><span class="line">      this.$store.commit(ADD_ITEM_LIST, item);</span><br><span class="line">    &#125;,</span><br><span class="line">    reduceClick() &#123;</span><br><span class="line">      this.$store.commit(REDUCE_ITEM_LIST);</span><br><span class="line">    &#125;,</span><br><span class="line">    changeClickAsync() </span><br><span class="line">      const item = &#123; text: &#x27;async_add_item_list success!&#x27;, done: true &#125;;</span><br><span class="line">      ///派发actions</span><br><span class="line">      this.$store.dispatch(CHANGE_ITEM_LIST_ASYNC, item);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在组合式API中使用</p>
<p>在组合式API中通过调用 <code>useStore</code> 函数，来在 <code>setup</code> 钩子函数中访问 store。这与在组件中使用选项式 API 访问 <code>this.$store</code> 是等效的.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  setup () &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useStore</span>()</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 在 computed 函数中访问 state</span></span><br><span class="line">      <span class="attr">count</span>: <span class="title function_">computed</span>(<span class="function">() =&gt;</span> store.<span class="property">state</span>.<span class="property">count</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在 computed 函数中访问 getter</span></span><br><span class="line">      <span class="attr">double</span>: <span class="title function_">computed</span>(<span class="function">() =&gt;</span> store.<span class="property">getters</span>.<span class="property">double</span>)</span><br><span class="line">      </span><br><span class="line">       <span class="comment">// 使用 mutation</span></span><br><span class="line">      <span class="attr">increment</span>: <span class="function">() =&gt;</span> store.<span class="title function_">commit</span>(<span class="string">&#x27;increment&#x27;</span>),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 使用 action</span></span><br><span class="line">      <span class="attr">asyncIncrement</span>: <span class="function">() =&gt;</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;asyncIncrement&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h3><p>通过对比<code>React Redux</code>与<code>Vuex</code>可以发现，两者的封装与使用有很大的相似性，它们都借鉴了 <a target="_blank" rel="noopener" href="https://facebook.github.io/flux/docs/overview">Flux</a>的设计思想，通过使用对比可以让我们更容易掌握他们。</p>
<p>一些参考：</p>
<p><a target="_blank" rel="noopener" href="https://vuex.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%22%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F%22%EF%BC%9F">Vuex</a></p>
<p><a target="_blank" rel="noopener" href="https://www.redux.org.cn/">Redux中文文档</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/05/09/React-Redux%E4%B8%8EVuex%E4%BD%BF%E7%94%A8%E5%AF%B9%E6%AF%94/" data-id="cllnfb8oz00013fex5fdpeum0" data-title="Web开发-React-Redux与Vuex使用对比" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/08/23/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%8F%91%E4%B8%80%E6%AC%BEChatGPT%20VSCode%E6%8F%92%E4%BB%B6/">从零开发一款ChatGPT VSCode插件</a>
          </li>
        
          <li>
            <a href="/2023/05/26/%E6%B5%85%E8%B0%88Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">浅谈Vue3响应式原理与源码解读</a>
          </li>
        
          <li>
            <a href="/2023/04/01/setState%E4%B8%8EuseState%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E9%A1%B9/">setState与useState使用注意项</a>
          </li>
        
          <li>
            <a href="/2023/02/06/%E4%BD%BF%E7%94%A8useReducer%20+%20useContext%20%E4%BB%A3%E6%9B%BF%20react-redux/">使用useReducer + useContext 代替 react-redux</a>
          </li>
        
          <li>
            <a href="/2022/11/15/GitHub%20Actions%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%20Vue%20%E9%A1%B9%E7%9B%AE/">GitHub Actions 自动部署前端 Vue 项目</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 chenXming<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>