<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>WebViewJavascriptBridge源码解析 | chenXming的个人技术网站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一. 概述做客户端开发免不了要与WebView打交道，特别是对于Hybrid App，在H5所占比重越来越大的背景下，一套好的WebView 与原生交互的API显得尤为重要，当然目前两端都有比较成熟的三方库进行支持。比如Android端的JsBridge,iOS端的WebViewJavascriptBridge,但是对于其内部原理笔者一直一知半解，导致有时面对问题无从下手，最后决心分析WebVie">
<meta property="og:type" content="article">
<meta property="og:title" content="WebViewJavascriptBridge源码解析">
<meta property="og:url" content="https://chenxming.github.io/2022/03/04/WebViewJavascriptBridge%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="chenXming的个人技术网站">
<meta property="og:description" content="一. 概述做客户端开发免不了要与WebView打交道，特别是对于Hybrid App，在H5所占比重越来越大的背景下，一套好的WebView 与原生交互的API显得尤为重要，当然目前两端都有比较成熟的三方库进行支持。比如Android端的JsBridge,iOS端的WebViewJavascriptBridge,但是对于其内部原理笔者一直一知半解，导致有时面对问题无从下手，最后决心分析WebVie">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2021/12/20/Genj8E9uvAxpX5M.png">
<meta property="article:published_time" content="2022-03-04T12:46:25.000Z">
<meta property="article:modified_time" content="2023-08-23T07:14:27.376Z">
<meta property="article:author" content="chenXming">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2021/12/20/Genj8E9uvAxpX5M.png">
  
    <link rel="alternate" href="/atom.xml" title="chenXming的个人技术网站" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">chenXming的个人技术网站</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chenxming.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-WebViewJavascriptBridge源码解析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/04/WebViewJavascriptBridge%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2022-03-04T12:46:25.000Z" itemprop="datePublished">2022-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      WebViewJavascriptBridge源码解析
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h3><p>做客户端开发免不了要与<code>WebView</code>打交道，特别是对于<code>Hybrid App</code>，在<code>H5</code>所占比重越来越大的背景下，一套好的<code>WebView</code> 与原生交互的API显得尤为重要，当然目前两端都有比较成熟的三方库进行支持。比如Android端的<a target="_blank" rel="noopener" href="https://github.com/lzyzsd">JsBridge</a>,iOS端的<a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge</a>,但是对于其内部原理笔者一直一知半解，导致有时面对问题无从下手，最后决心分析<code>WebViewJavascriptBridge</code>的内部实现原理，一是提升自己的源码阅读水平，其次也希望对以后的工作有所帮助。</p>
<h3 id="二-基本原理"><a href="#二-基本原理" class="headerlink" title="二. 基本原理"></a>二. 基本原理</h3><p><img src="https://s2.loli.net/2021/12/20/Genj8E9uvAxpX5M.png" alt="pic"><br>下载<code>WebViewJavascriptBridge</code>的源码后可以看到其文件并不多，分别对几个文件做简单的介绍，后面详细分析其源码</p>
<ul>
<li><code>WebViewJavascriptBridge_JS</code>: JS桥接文件，通过它实现JS环境的初始化，里面就一个C函数，返回的是JS方法。原生调用的JS方法与对应的方法回调都需要先在这里面进行注册。</li>
<li><code>WKWebViewJavascriptBridge</code> 与 <code>WebViewJavascriptBridge</code>: <code>WKWebView</code>与<code>UIWebView</code>对应的桥接文件。JS调用的原生方法与对应的方法回调都需要先在这里面进行注册。</li>
<li><code>WebViewJavascriptBridgeBase</code>: 桥接基础文件。通过他实现对原生环境的初始化，以及对方法存储容器的初始化，当然还有对<code>WebViewJavascriptBridge_JS</code>里面JS方法的调用。</li>
</ul>
<h3 id="三-源码解析"><a href="#三-源码解析" class="headerlink" title="三. 源码解析"></a>三. 源码解析</h3><p>大体了解了上面几个类的作用，我们通过源码来分析其内部的实现逻辑。我们就以<code>WebViewJavascriptBridge</code>Demo为例。</p>
<h4 id="1-JS调用OC方法"><a href="#1-JS调用OC方法" class="headerlink" title="1.  JS调用OC方法"></a>1.  JS调用OC方法</h4><h5 id="1-OC环境初始化与方法注册"><a href="#1-OC环境初始化与方法注册" class="headerlink" title="(1) OC环境初始化与方法注册"></a>(1) OC环境初始化与方法注册</h5><p>如何实现JS调用OC方法呢，首先要对当前OC环境进行初始化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// ExampleWKWebViewController</span><br><span class="line">_bridge = [WebViewJavascriptBridge bridgeForWebView:webView];</span><br><span class="line">    [_bridge setWebViewDelegate:self];</span><br><span class="line">    </span><br><span class="line">    [_bridge registerHandler:@&quot;testObjcCallback&quot; handler:^(id data, WVJBResponseCallback responseCallback) &#123;</span><br><span class="line">        NSLog(@&quot;testObjcCallback called: %@&quot;, data);</span><br><span class="line">        responseCallback(@&quot;Response from testObjcCallback&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">// WKWebViewJavascriptBridge</span><br><span class="line">+ (instancetype)bridgeForWebView:(WKWebView*)webView &#123;</span><br><span class="line">    WKWebViewJavascriptBridge* bridge = [[self alloc] init];</span><br><span class="line">    [bridge _setupInstance:webView];</span><br><span class="line">    [bridge reset];</span><br><span class="line">    return bridge;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">// WKWebViewJavascriptBridge</span><br><span class="line">- (void) _setupInstance:(WKWebView*)webView &#123;</span><br><span class="line">    _webView = webView;</span><br><span class="line">    _webView.navigationDelegate = self;</span><br><span class="line">    _base = [[WebViewJavascriptBridgeBase alloc] init];</span><br><span class="line">    _base.delegate = self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>[WebViewJavascriptBridge bridgeForWebView:webView];</code>: 看这个方法的调用栈，可以清晰的看到其作用是初始化 <code>WKWebViewJavascriptBridge</code>,进而实例化其对应的<code>WebViewJavascriptBridgeBase</code>,还有绑定各自的代理，最终实现初始化OC调用环境的目的。</p>
</li>
<li><p><code>- (void)registerHandler:(NSString*)handlerName handler:(WVJBHandler)handler;</code> : 如果要实现JS调用原生方法的目的，那么必须对原生方法进行注册，这个就是对应的注册方法。我们来看他内部做了什么:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)registerHandler:(NSString *)handlerName handler:(WVJBHandler)handler &#123;</span><br><span class="line">    _base.messageHandlers[handlerName] = [handler copy];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单，只不过把当前的Block保存进了<code>messageHandlers</code>这个字典中，以便等JS端调用时,通过方法名称来找到其对应的实现。</p>
</li>
</ul>
<h5 id="2-JS环境初始化与方法触发"><a href="#2-JS环境初始化与方法触发" class="headerlink" title="(2) JS环境初始化与方法触发"></a>(2) JS环境初始化与方法触发</h5><p>OC环境初始化与方法注册完成后，我们来下JS环境的初始化<br>Demo中通过<code>- (void)loadExamplePage:(WKWebView*)webView</code> 方法加载网页到当前的webView，来看下<code>ExampleApp.html</code>中的核心方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupWebViewJavascriptBridge</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span>) &#123; <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="title class_">WebViewJavascriptBridge</span>); &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>) &#123; <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>.<span class="title function_">push</span>(callback); &#125;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span> = [callback];</span><br><span class="line">      <span class="keyword">var</span> <span class="title class_">WVJBIframe</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">      <span class="title class_">WVJBIframe</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">      <span class="title class_">WVJBIframe</span>.<span class="property">src</span> = <span class="string">&#x27;https://__bridge_loaded__&#x27;</span>;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(<span class="title class_">WVJBIframe</span>);</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">removeChild</span>(<span class="title class_">WVJBIframe</span>) &#125;, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupWebViewJavascriptBridge</span>(<span class="keyword">function</span>(<span class="params">bridge</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> uniqueId = <span class="number">1</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">message, data</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> log = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">    el.<span class="property">className</span> = <span class="string">&#x27;logLine&#x27;</span></span><br><span class="line">    el.<span class="property">innerHTML</span> = uniqueId++ + <span class="string">&#x27;. &#x27;</span> + message + <span class="string">&#x27;:&lt;br/&gt;&#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data)</span><br><span class="line">    <span class="keyword">if</span> (log.<span class="property">children</span>.<span class="property">length</span>) &#123; log.<span class="title function_">insertBefore</span>(el, log.<span class="property">children</span>[<span class="number">0</span>]) &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; log.<span class="title function_">appendChild</span>(el) &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bridge.<span class="title function_">registerHandler</span>(<span class="string">&#x27;testJavascriptHandler&#x27;</span>, <span class="keyword">function</span>(<span class="params">data, responseCallback</span>) &#123;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;ObjC called testJavascriptHandler with&#x27;</span>, data)</span><br><span class="line">    <span class="keyword">var</span> responseData = &#123; <span class="string">&#x27;Javascript Says&#x27;</span>:<span class="string">&#x27;Right back atcha!&#x27;</span> &#125;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;JS responding with&#x27;</span>, responseData)</span><br><span class="line">    <span class="title function_">responseCallback</span>(responseData)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;br&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> callbackButton = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;buttons&#x27;</span>).<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>))</span><br><span class="line">  callbackButton.<span class="property">innerHTML</span> = <span class="string">&#x27;Fire testObjcCallback&#x27;</span></span><br><span class="line">  callbackButton.<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    e.<span class="title function_">preventDefault</span>()</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&#x27;JS calling handler &quot;testObjcCallback&quot;&#x27;</span>)</span><br><span class="line">    bridge.<span class="title function_">callHandler</span>(<span class="string">&#x27;testObjcCallback&#x27;</span>, &#123;<span class="string">&#x27;foo&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;, <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">      <span class="title function_">log</span>(<span class="string">&#x27;JS got response&#x27;</span>, response)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>setupWebViewJavascriptBridge(callback)</code>是核心方法，webView加载html后会首先调用这个方法。这个方法需要一个参数<code>callback</code>,也是一个函数。我们来看这个方法：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function setupWebViewJavascriptBridge(callback) &#123;</span><br><span class="line">    if (window.WebViewJavascriptBridge) &#123; return callback(WebViewJavascriptBridge); &#125;</span><br><span class="line">    if (window.WVJBCallbacks) &#123; return window.WVJBCallbacks.push(callback); &#125;</span><br><span class="line">    window.WVJBCallbacks = [callback];</span><br><span class="line">    var WVJBIframe = document.createElement(&#x27;iframe&#x27;);</span><br><span class="line">    WVJBIframe.style.display = &#x27;none&#x27;;</span><br><span class="line">    WVJBIframe.src = &#x27;https://__bridge_loaded__&#x27;;</span><br><span class="line">    document.documentElement.appendChild(WVJBIframe);</span><br><span class="line">    setTimeout(function() &#123; document.documentElement.removeChild(WVJBIframe) &#125;, 0)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
第一次加载网页时 <code>window.WebViewJavascriptBridge</code> 与 <code>window.WVJBCallbacks</code>都是false，把<code>window.WVJBCallbacks</code>赋值为包含callback的数组，此时callback为一个函数，就是后面的<code>function(bridge) ....</code>,接下来创建<code>WVJBIframe</code>,你可以把它理解为一个空白页面，创建它的目的是设置<code>src = &#39;https://__bridge_loaded__&#39;;</code>,</li>
</ul>
<blockquote>
<p>注意这个<code>src</code>属性很关键，当我们设置一个网页的<code>src</code>属性时，这个链接会被我们OC端的webView所捕获，从而调用webView的代理方法<code>- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler</code>,</p>
</blockquote>
<p>后面两句代码的的意思是加载当前空白页，以便触发OC的代理方法，然后立马移除。</p>
<ul>
<li><p>接下来我们去<code>WKWebViewJavascriptBridge</code>中看 <code>- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler</code> 这个代理方法拦截到请求后做了什么。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSURL *url = navigationAction.request.URL;</span><br><span class="line">__strong typeof(_webViewDelegate) strongDelegate = _webViewDelegate;</span><br><span class="line"></span><br><span class="line">if ([_base isWebViewJavascriptBridgeURL:url]) &#123;</span><br><span class="line">    if ([_base isBridgeLoadedURL:url]) &#123;</span><br><span class="line">        [_base injectJavascriptFile];</span><br><span class="line">    &#125; else if ([_base isQueueMessageURL:url]) &#123;</span><br><span class="line">        [self WKFlushMessageQueue];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [_base logUnkownMessage:url];</span><br><span class="line">    &#125;</span><br><span class="line">    decisionHandler(WKNavigationActionPolicyCancel);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先判断当前的URL是否是<code>__wvjb_queue_message__</code>或者<code>__bridge_loaded__</code>,刚才触发的URL是 <code>__bridge_loaded__</code><br>会调用<code>WebViewJavascriptBridgeBase</code>的<code>- (void)injectJavascriptFile</code>方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (void)injectJavascriptFile &#123;</span><br><span class="line">    // 获取JS字符串</span><br><span class="line">    NSString *js = WebViewJavascriptBridge_js();</span><br><span class="line">    [self _evaluateJavascript:js];</span><br><span class="line">    if (self.startupMessageQueue) &#123;</span><br><span class="line">        NSArray* queue = self.startupMessageQueue;</span><br><span class="line">        self.startupMessageQueue = nil;</span><br><span class="line">        for (id queuedMessage in queue) &#123;</span><br><span class="line">            [self _dispatchMessage:queuedMessage];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">- (void) _evaluateJavascript:(NSString *)javascriptCommand &#123;</span><br><span class="line">    [self.delegate _evaluateJavascript:javascriptCommand];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">- (NSString*) _evaluateJavascript:(NSString*)javascriptCommand &#123;</span><br><span class="line">    [_webView evaluateJavaScript:javascriptCommand completionHandler:nil];</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上方法调用可以看到，最后是把<code>WebViewJavascriptBridge_js();</code> JS方法字符串，通过方法 <code>[_webView evaluateJavaScript:javascriptCommand completionHandler:nil]</code> 注入到了webView中并且执行。从而达到初始化javascript环境的brige的作用。</p>
</li>
<li><p>WebViewJavascriptBridge_js()方法解析</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span> = &#123;</span><br><span class="line">  <span class="attr">registerHandler</span>: registerHandler,</span><br><span class="line">  <span class="attr">callHandler</span>: callHandler,</span><br><span class="line">  <span class="attr">disableJavscriptAlertBoxSafetyTimeout</span>: disableJavscriptAlertBoxSafetyTimeout,</span><br><span class="line">  <span class="attr">_fetchQueue</span>: _fetchQueue,</span><br><span class="line">  <span class="attr">_handleMessageFromObjC</span>: _handleMessageFromObjC</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messagingIframe;</span><br><span class="line">  <span class="comment">// 要发送给原生的消息列表</span></span><br><span class="line"><span class="keyword">var</span> sendMessageQueue = [];</span><br><span class="line">  <span class="comment">// 存储注册在bridge的JS方法</span></span><br><span class="line"><span class="keyword">var</span> messageHandlers = &#123;&#125;;</span><br><span class="line"><span class="comment">// 要跳转的URL</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> = <span class="string">&#x27;https&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">QUEUE_HAS_MESSAGE</span> = <span class="string">&#x27;__wvjb_queue_message__&#x27;</span>;</span><br><span class="line"><span class="comment">//JS方法回调</span></span><br><span class="line"><span class="keyword">var</span> responseCallbacks = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> uniqueId = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> dispatchMessagesWithTimeoutSafety = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// OC调用的JS方法需要用它来进行注册</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">registerHandler</span>(<span class="params">handlerName, handler</span>) &#123;</span><br><span class="line">  messageHandlers[handlerName] = handler;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//JS调用OC的方法入口</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    responseCallback = data;</span><br><span class="line">    data = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;, responseCallback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">disableJavscriptAlertBoxSafetyTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">  dispatchMessagesWithTimeoutSafety = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 要发送消息给原生了</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_doSend</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">    <span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">    message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">  &#125;</span><br><span class="line">  sendMessageQueue.<span class="title function_">push</span>(message);</span><br><span class="line">      <span class="comment">//触发webView 代理，解析JS 的message</span></span><br><span class="line">  messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 把消息转成json字符串</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_fetchQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> messageQueueString = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendMessageQueue);</span><br><span class="line">  sendMessageQueue = [];</span><br><span class="line">  <span class="keyword">return</span> messageQueueString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_dispatchMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 原生会调用他，JS用它来达到消息分发</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_handleMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">      <span class="title function_">_dispatchMessageFromObjC</span>(messageJSON);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">messagingIframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">messagingIframe.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(messagingIframe);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(_callWVJBCallbacks, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_callWVJBCallbacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> callbacks = <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">  <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;callbacks.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    callbacks[i](<span class="title class_">WebViewJavascriptBridge</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我截选了一些关键代码，首先整个<code>WebViewJavascriptBridge_js</code>是一个JS方法的执行，首先创建了JS端的<code>WebViewJavascriptBridge</code>并赋值给了<code>window</code>,我们来看这个对象的构成：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span> = &#123;</span><br><span class="line">  <span class="attr">registerHandler</span>: registerHandler,</span><br><span class="line">  <span class="attr">callHandler</span>: callHandler,</span><br><span class="line">  <span class="attr">disableJavscriptAlertBoxSafetyTimeout</span>: disableJavscriptAlertBoxSafetyTimeout,</span><br><span class="line">  <span class="attr">_fetchQueue</span>: _fetchQueue,</span><br><span class="line">  <span class="attr">_handleMessageFromObjC</span>: _handleMessageFromObjC</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p><code>registerHandler</code>:直接对应下面的<code>registerHandler(handlerName, handler)</code> 方法，通过它我们把能被OC调用的JS方法进行注册，看它的实现也是比较简单的</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerHandler</span>(<span class="params">handlerName, handler</span>) &#123;</span><br><span class="line">	messageHandlers[handlerName] = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把JS的方法实现以方法名<code>handleName</code>保存在messageHandlers中。</p>
<ul>
<li><code>callHandler</code>: 对应下面<code>callHandler(handlerName, data, responseCallback)</code>方法，通过它我们可以直接发起对OC方法的调用，具体调用逻辑我们在下面进行分析。</li>
<li><code>disableJavscriptAlertBoxSafetyTimeout</code>:回调是否超时开关，默认为false</li>
<li><code>_fetchQueue</code>: 把javascript环境的方法序列化成JSON字符串，并返回给OC端</li>
<li><code>_handleMessageFromObjC</code>:处理OC发给javascript环境的方法,<code>_dispatchMessageFromObjC(messageJSON)</code>这个方法的参数就是OC调用JS的message信息，这个方法对messageJSON进行解析处理，进而调用相应的JS方法。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">messagingIframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">messagingIframe.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(messagingIframe);</span><br></pre></td></tr></table></figure>
<p>这里的src就是https:&#x2F;&#x2F;__wvjb_queue_message__，这段代码的意思是把javascript要发送给OC的消息立即发送出去。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(_callWVJBCallbacks, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_callWVJBCallbacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> callbacks = <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">  <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;callbacks.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    callbacks[i](<span class="title class_">WebViewJavascriptBridge</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>WebViewJavascriptBridge_js</code>的最后是上面的代码，它会调用<code>ExampleApp.html</code>中的callBack方法，也就是它</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setupWebViewJavascriptBridge</span>(<span class="keyword">function</span>(<span class="params">bridge</span>) &#123;</span><br><span class="line"> ....</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>继而完成对这个JS环境的初始化与<code>ExampleApp.html</code>的加载。</p>
<h5 id="3-JS调用OC方法流程"><a href="#3-JS调用OC方法流程" class="headerlink" title="(3) JS调用OC方法流程"></a>(3) JS调用OC方法流程</h5><ul>
<li>点击JS按钮触发下面的方法<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bridge.<span class="title function_">callHandler</span>(<span class="string">&#x27;testObjcCallback&#x27;</span>, &#123;<span class="string">&#x27;foo&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;, <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">	<span class="title function_">log</span>(<span class="string">&#x27;JS got response&#x27;</span>, response)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
传递方法名<code>testObjcCallback</code>,消息参数<code>&#123;&#39;foo&#39;: &#39;bar&#39;&#125;</code>,以及OC回调JS的方法<code>function(response) &#123;log(&#39;JS got response&#39;, response)&#125;)</code>,</li>
<li>调用<code>WebViewJavascriptBridge_js</code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    responseCallback = data;</span><br><span class="line">    data = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;, responseCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_doSend</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">    <span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">    message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">  &#125;</span><br><span class="line">  sendMessageQueue.<span class="title function_">push</span>(message);</span><br><span class="line">  messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
可以看到核心方法是<code>_doSend()</code>,入参message是调用OC的方法名与参数，responseCallback是OC回调JS的方法，接下来将这个回调方法保存在responseCallbacks中，key值是<code>callbackId</code>,消息对象message也添加一个<code>callbackId</code>,最后设置<code>messagingIframe</code>的src属性，从而被ebView的代理方法<code>- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler</code>拦截。</li>
<li>在上面的代理方法中，拦截到的URL为<code>__wvjb_queue_message__</code>,所以调用方法：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (void)WKFlushMessageQueue &#123;</span><br><span class="line">    [_webView evaluateJavaScript:[_base webViewJavascriptFetchQueyCommand] completionHandler:^(NSString* result, NSError* error) &#123;</span><br><span class="line">        if (error != nil) &#123;</span><br><span class="line">            NSLog(@&quot;WebViewJavascriptBridge: WARNING: Error when trying to fetch data from WKWebView: %@&quot;, error);</span><br><span class="line">        &#125;</span><br><span class="line">        [_base flushMessageQueue:result];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">- (NSString *)webViewJavascriptFetchQueyCommand &#123;</span><br><span class="line">    return @&quot;WebViewJavascriptBridge._fetchQueue();&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
WebView触发JS的<code>WebViewJavascriptBridge._fetchQueue()</code>,<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">_fetchQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> messageQueueString = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendMessageQueue);</span><br><span class="line">	sendMessageQueue = [];</span><br><span class="line">	<span class="keyword">return</span> messageQueueString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这个方法里面会将<code>sendMessageQueue</code>换成json字符串，然后返回给OC环境，触发<code>[_base flushMessageQueue:result];</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">- (void)flushMessageQueue:(NSString *)messageQueueString&#123;</span><br><span class="line">    if (messageQueueString == nil || messageQueueString.length == 0) &#123;</span><br><span class="line">        NSLog(@&quot;WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page.&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // JS传递过来的json字符串，我们进行反序列化 得到message数组</span><br><span class="line">    NSLog(@&quot;messageQueueString===%@&quot;,messageQueueString);</span><br><span class="line">    id messages = [self _deserializeMessageJSON:messageQueueString];</span><br><span class="line"></span><br><span class="line">    for (WVJBMessage* message in messages) &#123;</span><br><span class="line">        if (![message isKindOfClass:[WVJBMessage class]]) &#123;</span><br><span class="line">            NSLog(@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;, [message class], message);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        [self _log:@&quot;RCVD&quot; json:message];</span><br><span class="line">        </span><br><span class="line">        NSString* responseId = message[@&quot;responseId&quot;];</span><br><span class="line">        if (responseId) &#123;</span><br><span class="line">            WVJBResponseCallback responseCallback = _responseCallbacks[responseId];</span><br><span class="line">            responseCallback(message[@&quot;responseData&quot;]);</span><br><span class="line">            [self.responseCallbacks removeObjectForKey:responseId];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            WVJBResponseCallback responseCallback = NULL;</span><br><span class="line">            NSString* callbackId = message[@&quot;callbackId&quot;];</span><br><span class="line">            if (callbackId) &#123; // 有回调</span><br><span class="line">                responseCallback = ^(id responseData) &#123;</span><br><span class="line">                    if (responseData == nil) &#123;</span><br><span class="line">                        responseData = [NSNull null];</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    WVJBMessage* msg = @&#123; @&quot;responseId&quot;:callbackId, @&quot;responseData&quot;:responseData &#125;;</span><br><span class="line">                    [self _queueMessage:msg];</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                responseCallback = ^(id ignoreResponseData) &#123;</span><br><span class="line">                    // Do nothing</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            WVJBHandler handler = self.messageHandlers[message[@&quot;handlerName&quot;]];</span><br><span class="line"></span><br><span class="line">            if (!handler) &#123;</span><br><span class="line">                NSLog(@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;, message);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            //向下传递参数，并且触发block回调（）</span><br><span class="line">            handler(message[@&quot;data&quot;], responseCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这个方法就是OC端处理JS的核心方法了，将<code>messageQueueString</code>反序列化，得到消息数组<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">       &#123;</span><br><span class="line">       callbackId = &quot;cb_1_1639553291614&quot;;</span><br><span class="line">       data =         &#123;</span><br><span class="line">           foo = bar;</span><br><span class="line">       &#125;;</span><br><span class="line">       handlerName = testObjcCallback;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
有<code>callbackId</code>,表明有消息回调，生成<code>responseCallback</code>Block,这个Block里面将接收的参数与<code>callbackId</code>打包一并发送给JS环境，并调用JS环境的<code>WebViewJavascriptBridge._handleMessageFromObjC(messageJSON);</code>方法将<code>messageJSON</code>进行解析。这里只是Block的实现，并没调用这个Block，调用在下面</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WVJBHandler handler = self.messageHandlers[message[@&quot;handlerName&quot;]];</span><br><span class="line"></span><br><span class="line">if (!handler) &#123;</span><br><span class="line">    NSLog(@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;, message);</span><br><span class="line">    continue;</span><br><span class="line">&#125;</span><br><span class="line">//向下传递参数，并且触发block回调（）</span><br><span class="line">handler(message[@&quot;data&quot;], responseCallback);</span><br></pre></td></tr></table></figure>

<p>根据<code>handlerName</code>找到在<code>messageHandlers</code>保存的方法实现，<code>handler(message[@&quot;data&quot;], responseCallback);</code>进行真正的调用，在OC的注册方法中，调用<code>responseCallback(@&quot;Response from testObjcCallback&quot;);</code> 向JS环境发送回调并传递参数。</p>
<ul>
<li><p>JS环境通过这个<code>_handleMessageFromObjC(messageJSON)</code>方法得到<code>messageJSON</code>,并对其解析。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">_dispatchMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (dispatchMessagesWithTimeoutSafety) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(_doDispatchMessageFromObjC);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="title function_">_doDispatchMessageFromObjC</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_doDispatchMessageFromObjC</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//转换为对象</span></span><br><span class="line">    <span class="keyword">var</span> message = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(messageJSON);</span><br><span class="line">    <span class="keyword">var</span> messageHandler;</span><br><span class="line">    <span class="keyword">var</span> responseCallback;</span><br><span class="line">    <span class="comment">// 这个responseId就是JS调用OC方法保存的callbackId</span></span><br><span class="line">    <span class="keyword">if</span> (message.<span class="property">responseId</span>) &#123;</span><br><span class="line">      responseCallback = responseCallbacks[message.<span class="property">responseId</span>];</span><br><span class="line">      <span class="keyword">if</span> (!responseCallback) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">responseCallback</span>(message.<span class="property">responseData</span>);</span><br><span class="line">      <span class="keyword">delete</span> responseCallbacks[message.<span class="property">responseId</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (message.<span class="property">callbackId</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> callbackResponseId = message.<span class="property">callbackId</span>;</span><br><span class="line">        responseCallback = <span class="keyword">function</span>(<span class="params">responseData</span>) &#123;</span><br><span class="line">          <span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:message.<span class="property">handlerName</span>, <span class="attr">responseId</span>:callbackResponseId, <span class="attr">responseData</span>:responseData &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> handler = messageHandlers[message.<span class="property">handlerName</span>];</span><br><span class="line">      <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebViewJavascriptBridge: WARNING: no handler for message from ObjC:&quot;</span>, message);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">handler</span>(message.<span class="property">data</span>, responseCallback);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先将字符串转化为JSON对象，根据responseId(这个responseId就是JS调用OC方法保存的callbackId),找到对应的方法实现，进行调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">  <span class="title function_">log</span>(<span class="string">&#x27;JS got response&#x27;</span>, response)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此就完成了JS调用OC，并且OC回调JS并传递参数的全部过程。</p>
</li>
</ul>
<h4 id="2-OC调用JS方法"><a href="#2-OC调用JS方法" class="headerlink" title="2. OC调用JS方法"></a>2. OC调用JS方法</h4><p>跟上面类似再来看下OC主动调用JS方法的实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[_bridge callHandler:@&quot;testJavascriptHandler&quot; data:@&#123; @&quot;foo&quot;:@&quot;before ready&quot; &#125;];</span><br><span class="line">....</span><br><span class="line"> - (void)callHandler:(NSString *)handlerName data:(id)data &#123;</span><br><span class="line">    [self callHandler:handlerName data:data responseCallback:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)callHandler:(NSString *)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback &#123;</span><br><span class="line">    [_base sendData:data responseCallback:responseCallback handlerName:handlerName];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">  </span><br><span class="line">- (void)sendData:(id)data responseCallback:(WVJBResponseCallback)responseCallback handlerName:(NSString*)handlerName &#123;</span><br><span class="line">    NSMutableDictionary* message = [NSMutableDictionary dictionary];</span><br><span class="line">    </span><br><span class="line">    if (data) &#123;</span><br><span class="line">        message[@&quot;data&quot;] = data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (responseCallback) &#123;</span><br><span class="line">        NSString* callbackId = [NSString stringWithFormat:@&quot;objc_cb_%ld&quot;, ++_uniqueId];</span><br><span class="line">        self.responseCallbacks[callbackId] = [responseCallback copy];</span><br><span class="line">        message[@&quot;callbackId&quot;] = callbackId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (handlerName) &#123;</span><br><span class="line">        message[@&quot;handlerName&quot;] = handlerName;</span><br><span class="line">    &#125;</span><br><span class="line">    [self _queueMessage:message];</span><br><span class="line">&#125;</span><br><span class="line">....</span><br><span class="line">  </span><br><span class="line">- (void)_dispatchMessage:(WVJBMessage*)message &#123;</span><br><span class="line">    NSString *messageJSON = [self _serializeMessage:message pretty:NO];</span><br><span class="line">    [self _log:@&quot;SEND&quot; json:messageJSON];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\\&quot; withString:@&quot;\\\\&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\&quot;&quot; withString:@&quot;\\\&quot;&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\&#x27;&quot; withString:@&quot;\\\&#x27;&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;\\n&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\r&quot; withString:@&quot;\\r&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\f&quot; withString:@&quot;\\f&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\u2028&quot; withString:@&quot;\\u2028&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\u2029&quot; withString:@&quot;\\u2029&quot;];</span><br><span class="line">    </span><br><span class="line">    NSString* javascriptCommand = [NSString stringWithFormat:@&quot;WebViewJavascriptBridge._handleMessageFromObjC(&#x27;%@&#x27;);&quot;, messageJSON];</span><br><span class="line">    NSLog(@&quot;javascriptCommand==%@&quot;,javascriptCommand);</span><br><span class="line">    if ([[NSThread currentThread] isMainThread]) &#123;</span><br><span class="line">        [self _evaluateJavascript:javascriptCommand];</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dispatch_sync(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [self _evaluateJavascript:javascriptCommand];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，跟JS调用OC方法的原理类似，将OC调用JS的方法名与参数封装进message对象，如果有回调函数，将回调函数通过<code>responseCallbacks</code>保存，并生成<code>callbackId</code>,将整个message打包发送给JS环境的<code>WebViewJavascriptBridge._handleMessageFromObjC(messageJSON);</code> 进行解析，解析流程上面介绍过了，这里不再赘述。</p>
<h3 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h3><p>通过上面流程分析,整个<code>WebViewJavascriptBridge</code> 内部的实现原理就比较清晰了。</p>
<ul>
<li>JS将方法注册到JS环境的bridge，OC调用JS的核心方法就是<code> [_webView evaluateJavaScript:javascriptCommand completionHandler:nil];</code>,JS环境收到消息后，通过方法<code>WebViewJavascriptBridge._handleMessageFromObjC();</code>将消息进行解析，调用注册在bridge的方法。</li>
<li>OC将方法注册到OC环境的bridge，JS调用OC的核心逻辑是，设置空白网页的<code>src</code>属性，从而被webView的代理方法<code>- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler</code>，OC通过核心方法<code>- (void)flushMessageQueue:(NSString *)messageQueueString</code>将传递数据进行解析。</li>
<li>两边都是通过方法名找到对应的方法实现，然后通过ID来查找回调函数。</li>
</ul>
<p>多阅读源码是好的一方面可以提升自己源码阅读水平，另一方面可以学习作者的一些好的设计思路。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">https://github.com/marcuswestin/WebViewJavascriptBridge</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lzyzsd/JsBridge">https://github.com/lzyzsd/JsBridge</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903472718938126#heading-9">https://juejin.cn/post/6844903472718938126#heading-9</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chenxming.github.io/2022/03/04/WebViewJavascriptBridge%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" data-id="cllniud7w0002xbex7n296jts" data-title="WebViewJavascriptBridge源码解析" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/03/08/iOS%E4%B8%AD%E7%9A%84Flex%E5%B8%83%E5%B1%80-FlexLib%E7%9A%84%E4%BD%BF%E7%94%A8/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          iOS-中的Flex布局-FlexLib的使用
        
      </div>
    </a>
  
  
    <a href="/2021/11/14/iOS%E9%80%86%E5%90%91%E4%B9%8B%E4%BB%8E%E7%A0%B8%E5%A3%B3%E5%88%B0%E9%87%8D%E7%AD%BE%E5%90%8D/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">iOS-逆向之从砸壳到重签名</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/08/16/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%8F%91%E4%B8%80%E6%AC%BEChatGPT%20VSCode%E6%8F%92%E4%BB%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/05/26/%E6%B5%85%E8%B0%88Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">浅谈Vue3响应式原理与源码解读</a>
          </li>
        
          <li>
            <a href="/2023/04/01/setState%E4%B8%8EuseState%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E9%A1%B9/">setState与useState使用注意项</a>
          </li>
        
          <li>
            <a href="/2023/02/06/%E4%BD%BF%E7%94%A8useReducer%20+%20useContext%20%E4%BB%A3%E6%9B%BF%20react-redux/">使用useReducer + useContext 代替 react-redux</a>
          </li>
        
          <li>
            <a href="/2022/11/15/GitHub%20Actions%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%20Vue%20%E9%A1%B9%E7%9B%AE/">GitHub Actions 自动部署前端 Vue 项目</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 chenXming<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>